<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API 수집 설정</title>
    {# head}
    <style>
        .schedule-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        .schedule-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            background: #f8f9fa;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            font-size: 14px;
            font-family: inherit;
            color: inherit;
            text-align: center;
            text-decoration: none;
            outline: none;
        }
        .schedule-tab.active {
            background: #fff;
            border-color: #ddd;
            border-bottom: 1px solid #fff;
            margin-bottom: -1px;
        }
        .schedule-tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            background: #fff;
        }
        .schedule-tab-content.active {
            display: block;
        }
        .time-settings {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .time-settings input[type="time"] {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .time-settings select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .time-range {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            margin-top: 30px;
        }
        .time-range label {
            margin: 0;
        }
        .interval-settings {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .interval-settings input[type="number"] {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .selected-items {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .selected-item {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 15px;
            font-size: 12px;
        }
        .selected-item .remove {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* 카테고리 선택 스타일 */
        .category-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .category-input-container input[readonly] {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }
        
        .category-select-btn {
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        
        /* API 버튼들을 더 작게 만들기 위한 추가 스타일 */
        .input-button .category-select-btn {
            padding: 4px 8px;
            font-size: 11px;
            margin-left: 4px;
        }
        
        /* 비활성화된 AI 도움 버튼 스타일 */
        .category-select-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .category-select-btn:hover {
            background: #0056b3;
        }
        
        .category-clear-btn {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .category-clear-btn:hover {
            background: #545b62;
        }
        
        .category-info {
            margin-top: 5px;
            font-size: 12px;
            color: #6c757d;
        }
        .checkbox-item input[type="checkbox"] {
            margin: 0;
        }
        .schedule-summary {
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            font-size: 14px;
        }
        
        /* Provider Dropdown Styles */
        .provider-input-container {
            position: relative;
            display: flex;
        }
        
        .provider-input-container input[type="text"] {
            flex: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none;
        }
        
        .provider-dropdown-btn {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-left: none;
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
            padding: 0 12px;
            cursor: pointer;
            font-size: 12px;
            color: #6c757d;
            transition: all 0.2s ease;
        }
        
        .provider-dropdown-btn:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        .provider-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow: hidden;
            display: none;
        }
        
        .provider-dropdown-header {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .provider-dropdown-header input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 13px;
        }
        
        .provider-dropdown-list {
            max-height: 250px;
            overflow-y: auto;
        }
        
        .provider-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s ease;
        }
        
        .provider-item:hover {
            background: #f8f9fa;
        }
        
        .provider-item:last-child {
            border-bottom: none;
        }
        
        .provider-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
        }
        
        .provider-url {
            font-size: 12px;
            color: #6c757d;
        }
        
        .provider-status {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }
        
        .provider-status.active {
            background: #d4edda;
            color: #155724;
        }
        
        .provider-status.inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .provider-loading {
            padding: 20px;
            text-align: center;
            color: #6c757d;
            font-size: 14px;
        }
        
        .provider-empty {
            padding: 20px;
            text-align: center;
            color: #6c757d;
            font-size: 14px;
        }

        input:not([type=checkbox],[type=radio]), select, textarea {
            margin-top: 0px !important;
            margin-bottom: 0px !important;
        }
        
        /* Placeholder 색상 설정 */
        input::placeholder,
        textarea::placeholder {
            color: #999 !important;
            opacity: 0.6;
        }
        
        /* Webkit 브라우저용 */
        input::-webkit-input-placeholder {
            color: #999 !important;
            opacity: 0.6;
        }
        
        /* Firefox용 */
        input::-moz-placeholder {
            color: #999 !important;
            opacity: 0.6;
        }
        
        /* IE/Edge용 */
        input:-ms-input-placeholder {
            color: #999 !important;
            opacity: 0.6;
        }

        .grid {
            margin-bottom: 20px !important;
        }

        ul.tree-ul li span:hover {
            background: #ddd;
        }
        ul.tree-ul li span.selected {
            background: #dbeafe;
            border-radius: 4px;
        }

        .provider-dropdown-btn{height: -webkit-fill-available;}
        button#confirmNodePath {margin-bottom: 0;}

        #aiModel{width: 200px;margin-left: 20px;}
        
        /* 스크린 리더 전용 텍스트 */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* 모달 스타일 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 25px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 17px;
            font-weight: 600;
            color: #0369a1;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #888;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 18px 24px 12px 24px;
            background: #f8fafc;
            overflow: auto;
            font-size: 14px;
            color: #222;
            max-height: 45vh;
        }
        
        .modal-footer {
            padding: 12px 24px 12px 24px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }
        
        /* API 응답 트리 스타일 */
        .api-tree {
            list-style: none;
            margin: 0;
            padding-left: 18px;
        }
        
        .api-tree li {
            margin: 2px 0;
        }
        
        .api-tree-key {
            color: #0369a1;
            font-weight: 500;
            cursor: pointer;
        }
        
        .api-tree-index {
            color: #888;
            cursor: pointer;
        }
        
        .api-tree-node.selected {
            background: #dbeafe;
            border-radius: 4px;
        }
        
        /* 요약 테이블 스타일 */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .summary-table th,
        .summary-table td {
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
        }
        
        .summary-table th {
            font-weight: 600;
            width: 30%;
        }
        
        .summary-section {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
        }
        
        .summary-section.basic {
            background: #f8f9fa;
        }
        
        .summary-section.schedule {
            background: #f0f9ff;
        }
        
        .summary-section.fields {
            background: #f0fdf4;
        }
        
        .summary-section h4 {
            color: #374151;
            margin-bottom: 12px;
        }
        
        .summary-section h3 {
            color: #0369a1;
            margin-bottom: 20px;
        }
        
        /* 유틸리티 클래스 */
        .hidden {
            display: none !important;
        }
        
        .textarea-resizable {
            resize: vertical;
            min-height: 2.5em;
        }
        
        /* 작은 삭제 버튼 스타일 */
        .btn-deleteRow {
            padding: 2px 6px !important;
            border-radius: 3px !important;
            font-size: 11px !important;
            min-width: auto !important;
            height: auto !important;
            line-height: 1.2 !important;
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
            color: white !important;
        }
        
        .btn-deleteRow:hover {
            background-color: #c82333 !important;
            border-color: #bd2130 !important;
        }
        
        .btn-deleteRow:focus {
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }
        
        .btn-deleteRow i {
            font-size: 10px !important;
        }
        
        .migration-btn-hidden {
            display: none;
        }
        .btn-warning {
            background-color: #f59e0b;
            color: white;
            border: 1px solid #f59e0b;
        }
        .btn-warning:hover {
            background-color: #d97706;
            border-color: #d97706;
        }
        
        /* API 데이터 레이어 팝업 */
        #apiDataLayer {
            position: fixed;
            bottom: 0;
            right: 20px;
            width: 50vw;
            max-width: 1200px;
            height: 50vh;
            background: white;
            border: 2px solid #007bff;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 9998;
            transition: transform 0.3s ease;
            display: none;
            flex-direction: column;
        }
        
        #apiDataLayer.minimized {
            transform: translateY(calc(100% - 50px));
            display: none !important;
        }
        
        #apiDataLayer.expanded {
            transform: translateY(0);
            display: flex;
        }
        
        #apiDataLayer.fullscreen {
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100vh;
            border-radius: 0;
        }
        
        .api-data-layer-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .api-data-layer-header:hover {
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
        }
        
        .api-data-layer-actions {
            display: flex;
            gap: 10px;
        }
        
        .api-data-layer-actions button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
            margin-bottom: 0;
        }
        
        .api-data-layer-actions button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .api-data-layer-content {
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }
        
        #apiDataLayer.fullscreen .api-data-layer-content {
            height: calc(100vh - 60px);
        }
        
        #apiDataTableContainer {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }
        
        .api-data-table-wrapper {
            flex: 1;
            min-height: 0;
            overflow-x: auto;
            overflow-y: auto;
        }
        
        /* 스크롤바 항상 표시 */
        .api-data-table-wrapper::-webkit-scrollbar {
            height: 12px;
            width: 12px;
        }
        
        .api-data-table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .api-data-table-wrapper::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        .api-data-table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .api-data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            min-width: 100%;
        }
        
        .api-data-table th,
        .api-data-table td {
            padding: 4px 8px;
            text-align: left;
            border: 1px solid #ddd;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .api-data-table thead th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 15;
            padding: 6px 8px;
        }
        
        .api-data-table thead th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .api-data-table thead th.sortable:hover {
            background: #e9ecef;
        }
        
        .api-data-table thead th.sortable i {
            margin-left: 5px;
            color: #007bff;
        }
        
        .api-data-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s ease;
            background: white;
        }
        
        .api-data-table tbody tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .api-data-table tbody tr:hover {
            background: #e3f2fd !important;
        }
        
        .api-data-table tbody tr.selected {
            background: #007bff !important;
        }
        
        .api-data-table tbody tr.selected td {
            background: #007bff !important;
            color: white !important;
        }
        
        .api-data-table tbody tr.selected:nth-child(even) td {
            background: #007bff !important;
            color: white !important;
        }
        
        .api-data-table tbody tr.selected:hover td {
            background: #0056b3 !important;
            color: white !important;
        }
        
        .api-data-table tbody tr.selected .api-data-table-index-col {
            background: #007bff !important;
            color: white !important;
        }
        
        .api-data-table tbody tr.selected:hover .api-data-table-index-col {
            background: #0056b3 !important;
            color: white !important;
        }
        
        /* 수직 스크롤 시 첫 번째 열 고정 */
        .api-data-table-index-col {
            width: 50px;
            text-align: center;
            position: sticky;
            left: 0;
            z-index: 10;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        }
        
        .api-data-table thead .api-data-table-index-col {
            background: #f8f9fa;
            z-index: 20;
        }
        
        .api-data-table tbody .api-data-table-index-col {
            background: white;
            z-index: 15;
        }
        
        .api-data-table tbody tr:nth-child(even) .api-data-table-index-col {
            background: #f9f9f9;
        }
        
        .api-data-table tbody tr.selected .api-data-table-index-col {
            background: #007bff !important;
            color: white !important;
        }
        
        .api-data-table tbody tr.selected:nth-child(even) .api-data-table-index-col {
            background: #007bff !important;
        }
        
        .api-data-table tbody tr.selected:hover .api-data-table-index-col {
            background: #0056b3 !important;
        }
        
        .api-data-layer-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 14px;
        }
        
        .api-data-layer-empty i {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 10px;
            display: block;
        }
        
        /* 데이터 타입별 색상 */
        .type-string { color: #28a745; }
        .type-number { color: #007bff; }
        .type-boolean { color: #ffc107; }
        .type-object { color: #6f42c1; }
        .type-array { color: #dc3545; }
        .type-null { color: #6c757d; }
        
        /* 최소화된 레이어 스타일 */
        #apiDataLayerMinimized {
            position: fixed;
            bottom: 0;
            right: 20px;
            width: 50vw;
            max-width: 1200px;
            display: none;
            z-index: 9998;
            background: white;
            border: 2px solid #007bff;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .api-data-layer-minimized-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .api-data-layer-minimized-header button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
            margin-bottom:0;
        }
        
        .api-data-layer-minimized-header button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .api-data-layer-minimized-content {
            max-height: 150px;
            overflow-x: auto;
            overflow-y: auto;
        }
        
        .minimized-table {
            font-size: 11px;
            border-collapse: collapse;
            width: 100%;
            margin-bottom:0;
        }
        
        .minimized-table th {
            background: #f8f9fa;
            padding: 6px 8px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #ddd;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .minimized-table td {
            padding: 6px 8px;
            border: 1px solid #ddd;
            white-space: nowrap;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .minimized-table tr.selected {
            background: #007bff !important;
            color: white !important;
        }
    </style>
</head>
<body>
    {# left}
    {# header}
    <main class="container">
        <div role="document">
			<div role="heading" aria-level="1">API 수집</div>
			<section>
				<input type="hidden" name="referer" id="referer" value="{ _SERVER['HTTP_REFERER']}"/>
				<form id="inputForm" method="post" role="form" class="spacing">
					<input type="hidden" id="coId" name="coId" value="{? result.item.coId}{result.item.coId}{:}{_SESSION.coId}{/}">
                    <input type="hidden" name="action" value="{? result.item.id}update{:}insert{/}">
					<!-- 스케줄 데이터 로드용 hidden input -->
					<input type="hidden" id="loadScheduleData" value="{? !empty(result.item.schedule)}{=json_encode(result.item.schedule)}{:}{? !empty(result.item.scheduleConfig)}{result.item.scheduleConfig}{/}{/}">
					
					<div class="grid">
						<label for="url">
							API Url <span class="red">*</span>
							<div class="input-button">
								<input type="text" placeholder="Please enter the URL" name="url" id="url" value="{? !empty(result.item.url)}{result.item.url}{/}" aria-describedby="url-help">
								<button type="button" class="category-select-btn" id="bnt_dataCheck" aria-label="API 데이터 확인">API데이터 확인</button>
                                <select id="aiModel" name="aiModel" aria-label="AI 모델 선택">
                                    <option value="">AI모델 선택</option>
                                    {@ result.aiModel}
                                    <option value="{.idx}">{.name}</option>
                                    {/}
                                </select>
								<button type="button" class="category-select-btn" id="bnt_aiHelp" disabled aria-label="AI 도움 (API 데이터 확인 후 사용 가능)">AI도움</button>
							</div>
							<div id="url-help" class="sr-only">API URL을 입력하고 데이터 확인 버튼을 클릭하세요</div>
						</label>
					</div>
					<div class="grid">
						<label for="id">
                            API ID <span class="red">*</span>
                            <input type="text" placeholder="Please enter the API ID[alpabet, number,-,_, No Space]" name="id" id="id" autocomplete="off" maxlength="60" value="{? !empty(result.item.id)}{result.item.id}{/}" aria-describedby="id-help idResult">
							<span id="idResult" role="status" aria-live="polite"></span>
							<div id="id-help" class="sr-only">영문자, 숫자, 하이픈, 언더스코어만 사용 가능하며 공백은 사용할 수 없습니다</div>
						</label>
						<label for="title">
                            API 주제명 <span class="red">*</span>
                            <input type="text" placeholder="Please enter the Api Title" name="title" id="title" autocomplete="off" maxlength="60" value="{? !empty(result.item.title)}{result.item.title}{/}" aria-describedby="title-help titleResult">
							<span id="titleResult" role="status" aria-live="polite"></span>
							<div id="title-help" class="sr-only">API의 제목을 입력하세요</div>
						</label>
					</div>
                    <div class="grid">
						<label for="provider">
                            제공사 <span class="red">*</span>
                            <div class="provider-input-container">
                                <input type="text" placeholder="제공사를 입력하거나 선택하세요" name="provider" id="provider" value="{? !empty(result.item.provider)}{result.item.provider}{/}" autocomplete="off" aria-describedby="provider-help" aria-expanded="false" aria-haspopup="listbox" role="combobox">
                                <button type="button" class="provider-dropdown-btn" id="providerDropdownBtn" title="저장된 제공사 목록" aria-label="제공사 목록 열기" aria-expanded="false" aria-haspopup="listbox">▼</button>
                                <div class="provider-dropdown" id="providerDropdown" role="listbox" aria-label="제공사 목록">
                                    <div class="provider-dropdown-header">
                                        <input type="text" placeholder="제공사 검색..." id="providerSearch" aria-label="제공사 검색">
                                    </div>
                                    <div class="provider-dropdown-list" id="providerDropdownList">
                                        <div class="provider-loading">제공사 목록을 불러오는 중...</div>
                                    </div>
                                </div>
                            </div>
							<div id="provider-help" class="sr-only">제공사명을 직접 입력하거나 드롭다운에서 선택하세요</div>
						</label>
						<label for="returnType">
							API 문서형식 <span class="red">*</span>
							<select id="returnType" name="returnType" aria-describedby="returnType-help">
								<option value="JSON">JSON</option>
								<option value="XML">XML</option>
							</select>
							<div id="returnType-help" class="sr-only">API 응답 데이터의 형식을 선택하세요</div>
						</label>
					</div>
					<div class="grid">
						<label for="categoryName">
							카테고리 <span class="red">*</span>
							<div class="category-input-container">
								<input type="text" placeholder="카테고리를 선택하세요" name="categoryName" id="categoryName" value="{? !empty(result.item.categoryName)}{result.item.categoryName}{/}" readonly aria-describedby="category-help">
								<input type="hidden" name="categoryId" id="categoryId" value="{? !empty(result.item.categoryId)}{result.item.categoryId}{/}">
								<button type="button" class="category-select-btn" id="categorySelectBtn" title="카테고리 선택" aria-label="카테고리 선택 팝업 열기">카테고리 선택</button>
							</div>
							<div id="category-help" class="sr-only">카테고리 선택 버튼을 클릭하여 카테고리를 선택하세요</div>
						</label>

						<label for="isUse">
                            사용여부 
                            <select id="isUse" name="isUse" aria-describedby="isUse-help">
                                <option value="Y" selected="selected">Y</option>
								<option value="N">N</option>
                            </select>
							<div id="isUse-help" class="sr-only">API 사용 여부를 선택하세요</div>
                        </label>

						<label for="isChartUse">
                            차트조회사용 
                            <select id="isChartUse" name="isChartUse" aria-describedby="isChartUse-help">
                                <option value="Y" selected="selected">Y</option>
								<option value="N">N</option>
                            </select>
							<div id="isChartUse-help" class="sr-only">차트 조회 사용 여부를 선택하세요</div>
                        </label>
					</div>
					<div class="grid">
						<label for="key">
							API Key <span class="red">*</span> <mark>URL {\key}와 치환</mark>
							<input type="text" placeholder="Please enter the API Key" name="key" id="key" value="{? !empty(result.item.key)}{result.item.key}{/}">
						</label>
					</div>
                    <div class="grid">
						<label for="key">
							Header 정보 <span class="red">*</span> <mark>URL {\header}와 치환</mark>
							<textarea placeholder="Please enter the Header" name="header" id="header" rows="3">{? !empty(result.item.header)}{result.item.header}{/}</textarea>
						</label>
					</div>
					<div class="grid">
						<label for="dateChar">
							Api Url Date 문자형식 <mark>URL {\date}와 치환 - php date 문법</mark>
							<input type="text" placeholder="PHP Date Value (20200801 => 'Ymd', 2020-08-01 => 'Y-m-d')" name="dateChar" id="dateChar" value="{? !empty(result.item.dateChar)}{=htmlentities(result.item.dateChar)}{/}">
						</label>
						<label for="listTag">
							원본 리스트 tag <mark>리스트 태그가 2,3 depth인 경우</mark>
							<input type="text" placeholder="Tag in case of XML [channel][item]" name="listTag" id="listTag" value="{? !empty(result.item.listTag)}{result.item.listTag}{/}">
						</label>
					</div>

                    <div class="grid">
						<label for="unit">
							단위 <mark>예: USD, KRW, %, 억원, 천원, 개</mark>
							<input type="text" placeholder="단위" name="unit" id="unit" value="{? !empty(result.item.unit)}{result.item.unit}{/}">
						</label>
						<label for="aliases">
							별칭 <mark>여러개인 경우 ',' 콤마로 구분</mark>
							<input type="text" placeholder="별칭" name="aliases" id="aliases" value="{? !empty(result.item.aliases)}{result.item.aliases}{/}">
						</label>
					</div>

                    <div class="grid">
						<label for="description">
							설명문
							<textarea name="description" id="description" rows="2" maxlength="200" class="textarea-resizable">{? !empty(result.item.description)}{result.item.description}{/}</textarea>
						</label>
					</div>

					<!-- 스케줄 주기 설정 -->
					
                    <div class="grid">
                        <div>
                            <div>
                                스케줄 주기<span class="red">*</span>
                            </div>
                            <div class="schedule-tabs" role="tablist" aria-label="스케줄 주기 선택">
                                <button type="button" class="schedule-tab active" data-type="daily" role="tab" aria-selected="true" aria-controls="daily-content" id="daily-tab" tabindex="0">일간</button>
                                <button type="button" class="schedule-tab" data-type="weekly" role="tab" aria-selected="false" aria-controls="weekly-content" id="weekly-tab" tabindex="-1">주간</button>
                                <button type="button" class="schedule-tab" data-type="monthly" role="tab" aria-selected="false" aria-controls="monthly-content" id="monthly-tab" tabindex="-1">월간</button>
                                <button type="button" class="schedule-tab" data-type="quarterly" role="tab" aria-selected="false" aria-controls="quarterly-content" id="quarterly-tab" tabindex="-1">분기</button>
                                <button type="button" class="schedule-tab" data-type="yearly" role="tab" aria-selected="false" aria-controls="yearly-content" id="yearly-tab" tabindex="-1">년간</button>
                            </div>
 
                            <!-- 일간 탭 -->
                            <div class="schedule-tab-content active" id="daily-content" role="tabpanel" aria-labelledby="daily-tab">
                                <p>매일 실행됩니다.</p>
                                <div class="time-range">
                                    <div>
                                        <label for="dailyStartTime">시작 시간:</label>
                                        <input type="time" id="dailyStartTime" value="09:00">
                                    </div>
                                    <div>
                                        <label for="dailyEndTime">종료 시간:</label>
                                        <input type="time" id="dailyEndTime" value="18:00">
                                    </div>
                                </div>
                                <div class="interval-settings">
                                    <div>
                                        <label for="dailyInterval">실행 주기:</label>
                                        <input type="number" id="dailyInterval" min="1" max="1440" value="60"> 분
                                    </div>
                                </div>
                                <div class="schedule-summary" id="daily-summary">
                                    매일 09:00 ~ 18:00, 60분 주기로 실행됩니다.
                                </div>
                            </div>
                            
                            <!-- 주간 탭 -->
                            <div class="schedule-tab-content" id="weekly-content" role="tabpanel" aria-labelledby="weekly-tab">
                                <p>선택한 요일에 실행됩니다.</p>
                                <div class="checkbox-group">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="weekly-1" value="1">
                                        <label for="weekly-1">월요일</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="weekly-2" value="2">
                                        <label for="weekly-2">화요일</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="weekly-3" value="3">
                                        <label for="weekly-3">수요일</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="weekly-4" value="4">
                                        <label for="weekly-4">목요일</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="weekly-5" value="5">
                                        <label for="weekly-5">금요일</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="weekly-6" value="6">
                                        <label for="weekly-6">토요일</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="weekly-0" value="0">
                                        <label for="weekly-0">일요일</label>
                                    </div>
                                </div>
                                <div class="time-range">
                                    <div>
                                        <label for="weeklyStartTime">시작 시간:</label>
                                        <input type="time" id="weeklyStartTime" value="09:00">
                                    </div>
                                    <div>
                                        <label for="weeklyEndTime">종료 시간:</label>
                                        <input type="time" id="weeklyEndTime" value="18:00">
                                    </div>
                                </div>
                                <div class="interval-settings">
                                    <div>
                                        <label for="weeklyInterval">실행 주기:</label>
                                        <input type="number" id="weeklyInterval" min="1" max="1440" value="60"> 분
                                    </div>
                                </div>
                                <div class="selected-items hidden" id="weekly-selected">
                                    <strong>선택된 요일:</strong> <span id="weekly-selected-text"></span>
                                </div>
                                <div class="schedule-summary" id="weekly-summary">
                                    선택된 요일 09:00 ~ 18:00, 60분 주기로 실행됩니다.
                                </div>
                            </div>
                            
                            <!-- 월간 탭 -->
                            <div class="schedule-tab-content" id="monthly-content" role="tabpanel" aria-labelledby="monthly-tab">
                                <p>선택한 일자에 실행됩니다.</p>
                                <div class="checkbox-group">
                                    <!-- 1일부터 31일까지 체크박스 생성 -->
                                </div>
                                <div class="time-range">
                                    <div>
                                        <label for="monthlyStartTime">시작 시간:</label>
                                        <input type="time" id="monthlyStartTime" value="09:00">
                                    </div>
                                    <div>
                                        <label for="monthlyEndTime">종료 시간:</label>
                                        <input type="time" id="monthlyEndTime" value="18:00">
                                    </div>
                                </div>
                                <div class="interval-settings">
                                    <div>
                                        <label for="monthlyInterval">실행 주기:</label>
                                        <input type="number" id="monthlyInterval" min="1" max="1440" value="60"> 분
                                    </div>
                                </div>
                                <div class="selected-items hidden" id="monthly-selected">
                                    <strong>선택된 일자:</strong> <span id="monthly-selected-text"></span>
                                </div>
                                <div class="schedule-summary" id="monthly-summary">
                                    선택된 일자 09:00 ~ 18:00, 60분 주기로 실행됩니다.
                                </div>
                            </div>
                            
                            <!-- 분기 탭 -->
                            <div class="schedule-tab-content" id="quarterly-content" role="tabpanel" aria-labelledby="quarterly-tab">
                                <p>선택한 분기에 실행됩니다.</p>
                                <div class="checkbox-group">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="quarterly-1" value="1">
                                        <label for="quarterly-1">1분기 (1-3월)</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="quarterly-2" value="2">
                                        <label for="quarterly-2">2분기 (4-6월)</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="quarterly-3" value="3">
                                        <label for="quarterly-3">3분기 (7-9월)</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="quarterly-4" value="4">
                                        <label for="quarterly-4">4분기 (10-12월)</label>
                                    </div>
                                </div>
                                <div class="time-range">
                                    <div>
                                        <label for="quarterlyStartTime">시작 시간:</label>
                                        <input type="time" id="quarterlyStartTime" value="09:00">
                                    </div>
                                    <div>
                                        <label for="quarterlyEndTime">종료 시간:</label>
                                        <input type="time" id="quarterlyEndTime" value="18:00">
                                    </div>
                                </div>
                                <div class="interval-settings">
                                    <div>
                                        <label for="quarterlyInterval">실행 주기:</label>
                                        <input type="number" id="quarterlyInterval" min="1" max="1440" value="60"> 분
                                    </div>
                                </div>
                                <div class="selected-items hidden" id="quarterly-selected">
                                    <strong>선택된 분기:</strong> <span id="quarterly-selected-text"></span>
                                </div>
                                <div class="schedule-summary" id="quarterly-summary">
                                    선택된 분기 09:00 ~ 18:00, 60분 주기로 실행됩니다.
                                </div>
                            </div>
                            
                            <!-- 년간 탭 -->
                            <div class="schedule-tab-content" id="yearly-content" role="tabpanel" aria-labelledby="yearly-tab">
                                <p>선택한 월에 실행됩니다.</p>
                                <div class="checkbox-group">
                                    <!-- 1월부터 12월까지 체크박스 생성 -->
                                </div>
                                <div class="time-range">
                                    <div>
                                        <label for="yearlyStartTime">시작 시간:</label>
                                        <input type="time" id="yearlyStartTime" value="09:00">
                                    </div>
                                    <div>
                                        <label for="yearlyEndTime">종료 시간:</label>
                                        <input type="time" id="yearlyEndTime" value="18:00">
                                    </div>
                                </div>
                                <div class="interval-settings">
                                    <div>
                                        <label for="yearlyInterval">실행 주기:</label>
                                        <input type="number" id="yearlyInterval" min="1" max="1440" value="60"> 분
                                    </div>
                                </div>
                                
                                <div class="selected-items hidden" id="yearly-selected">
                                    <strong>선택된 월:</strong> <span id="yearly-selected-text"></span>
                                </div>
                                <div class="schedule-summary" id="yearly-summary">
                                    선택된 월 09:00 ~ 18:00, 60분 주기로 실행됩니다.
                                </div>
                            </div>
                        </div>
					</div>
					
					<div>
						<div class="flex"><span>필드 세팅</span><button class="btn-addRow btn btn-sm" type="button" title="새 필드 추가"><i class="fa fa-plus"></i></button></div>
						<table id="collectionField" class="border th-bg text-center" role="grid">
							<thead>
								<tr>
									<th>No.</th><th>원본 Tag명</th><th>DB에 입력될 필드명</th><th>주요필드</th><th>기본값</th><th>조건</th><th>그래프 표기명</th><th>삭제</th>
								</tr>
							</thead>
							<tbody>
								<tr class="tmp_row">
									<td class="no"></td>
									<td><input type="text" placeholder="Please enter the Data Tag Name" name="tag[]" id="tag_template"></td>
									<td>
										<input type="text" placeholder="Please enter the Collection Field Name" list="fieldKind" name="field[]" id="field_template">
									</td>
									<td><input type="checkbox" name="keyField[]" id="keyField_template" value="" aria-label="주요 필드 선택"></td>
									<td><input type="text" placeholder="Please enter the Default Value" name="value[]" id="value_template"></td>
									<td><input type="text" placeholder='=="배추"(값이 배추인경우) > 20 (20보다 큰경우), <= 20(20보다 작거나 같은경우), !=30(30과 같지않다.) ' name="condition[]" id="condition_template"></td>
									<td class="d-flex flex-row">
										<input type="text" placeholder="Please enter the Remark" name="remark[]" id="remark_template">
									</td>
									<td>
										<button type="button" class="btn-deleteRow btn btn-sm btn-danger" title="행 삭제" aria-label="이 행 삭제">
											<i class="fa fa-trash"></i>
										</button>
									</td>
								</tr>
								{@ result.item.items}
								<tr class="tr_row">
									<td class="no">{.index_+1}</td>
									<td><input type="text" placeholder="Please enter the Data Tag Name" name="tag[]" id="tag_{.index_}" value="{=htmlentities(.tag)}"></td>
									<td><input type="text" placeholder="Please enter the Collection Field Name" list="fieldKind" name="field[]" id="field_{.index_}" value="{=htmlentities(.field)}"></td>
									<td><input type="checkbox" name="keyField[]" id="keyField_{.index_}" value="{.index_}" {?.keyField}checked{/} aria-label="주요 필드 선택"></td>
									<td><input type="text" placeholder="Please enter the Default Value" name="value[]" id="value_{.index_}" value="{=htmlentities(.value)}"></td>
									<td><input type="text" placeholder='=="배추"(값이 배추인경우) > 20 (20보다 큰경우), <= 20(20보다 작거나 같은경우), !=30(30과 같지않다.) ' name="condition[]" id="condition_{.index_}" value="{=htmlentities(.condition)}"></td>
									<td class="d-flex flex-row">
										<input type="text" placeholder="Please enter the Remark" name="remark[]" id="remark_{.index_}" value="{=htmlentities(.remark)}">
									</td>
									<td>
										<button type="button" class="btn-deleteRow btn btn-sm btn-danger" title="행 삭제" aria-label="이 행 삭제">
											<i class="fa fa-trash"></i>
										</button>
									</td>
								</tr>
								{/}
							</tbody>
						</table>

						<datalist id="fieldKind">
							<option value="date"></option>
							<option value="price"></option>
							<option value="name"></option>
							<option value="kind"></option>
							<option value="grade"></option>
							<option value="gradeCode"></option>
							<option value="market"></option>
							<option value="unit"></option>
						</datalist>
					</label>
				</form>
				<div class="flex justify-center">
					<button type="button" class="btn btn-md" id="saveBtn">API저장</button>
                    <button type="button" class="btn btn-md" id="listBtn">목록</button>
                    <button type="button" class="btn btn-md copy-btn-hidden" id="copyBtn" style="margin-left:20px;">복사</button>
					<button type="button" class="btn btn-md btn-warning migration-btn-hidden" id="migrationBtn">Migration</button>
                    
				</div>
			</section>
		</div>
	</main>

<script type="text/javascript">
// 액션 타입 설정
var action = '<?php echo empty($_GET["id"]) ? "insert" : "modify"; ?>';
if (action === 'modify') {
	$("#copyBtn").removeClass('copy-btn-hidden'); // 수정 모드일 때만 복사 버튼 표시
	$("#migrationBtn").removeClass('migration-btn-hidden'); // 수정 모드일 때만 Migration 버튼 표시
}

var scheduleData = <?php echo !empty($result['item']['scheduleText']) ? json_encode($result['item']['scheduleText']) : 'null'; ?>; 

// ==================== 전역 변수 및 설정 ====================
var currentScheduleType = 'daily';
var apiData = [];
var providerList = [];
var filteredProviders = [];
var selectedCategory = null;
var selectedCategoryPath = [];

// DOM 요소 캐싱
var row = $(".tmp_row").clone();
$(".tmp_row").remove();

// ==================== 공통 유틸리티 함수 ====================

/**
 * 공통 AJAX 설정을 적용한 요청 함수
 * @param {Object} options - AJAX 옵션
 * @returns {jQuery.Deferred} - jQuery Deferred 객체
 */
function makeAjaxRequest(options) {
    var defaultOptions = {
        cache: false,
        headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
        }
    };
    
    return $.ajax($.extend(defaultOptions, options));
}

/**
 * 에러 메시지를 사용자 친화적으로 변환
 * @param {Object} xhr - XMLHttpRequest 객체
 * @param {string} status - 상태
 * @param {string} error - 에러 메시지
 * @returns {string} - 사용자 친화적 에러 메시지
 */
function getErrorMessage(xhr, status, error) {
    if (xhr.status === 0) {
        return '네트워크 연결을 확인해주세요.';
    } else if (xhr.status === 404) {
        return 'API 엔드포인트를 찾을 수 없습니다.';
    } else if (xhr.status === 500) {
        return '서버 오류가 발생했습니다.';
    } else if (xhr.status === 403) {
        return '접근이 거부되었습니다. 권한을 확인해주세요.';
    } else if (status === 'timeout') {
        return '요청 시간이 초과되었습니다.';
    }
    return '요청 처리 중 오류가 발생했습니다.';
}

// 페이지 로드 시 초기화
$(document).ready(function() {
    // 월간 체크박스 생성
    generateMonthlyCheckboxes();
    
    // 년간 체크박스 생성
    generateYearlyCheckboxes();

    // 이벤트 바인딩
    bindEvents();
    
    // 초기 스케줄 요약 업데이트
    
    
    // 기존 데이터 로드
    loadExistingData();
    
    // 스케줄 필드 name 속성 초기화
    updateScheduleFieldNames();
    
    // Provider 드롭다운 초기화
    initProviderDropdown();
    
    // 카테고리 관련 초기화
    initCategoryFields();
    
});

/**
 * 월간 스케줄용 체크박스 생성 (1일~31일)
 */
function generateMonthlyCheckboxes() {
    var container = $('#monthly-content .checkbox-group');
    container.empty();
    
    for(var i = 1; i <= 31; i++) {
        var item = $('<div class="checkbox-item">' +
            '<input type="checkbox" id="monthly-' + i + '" value="' + i + '">' +
            '<label for="monthly-' + i + '">' + i + '일</label>' +
            '</div>');
        container.append(item);
    }
}

/**
 * 년간 스케줄용 체크박스 생성 (1월~12월)
 */
function generateYearlyCheckboxes() {
    var container = $('#yearly-content .checkbox-group');
    container.empty();
    
    for(var i = 1; i <= 12; i++) {
        var item = $('<div class="checkbox-item">' +
            '<input type="checkbox" id="yearly-' + i + '" value="' + i + '">' +
            '<label for="yearly-' + i + '">' + i + '월</label>' +
            '</div>');
        container.append(item);
    }
}

/**
 * 모든 이벤트 핸들러 바인딩
 */
function bindEvents() {
    bindScheduleTabEvents();
    bindCheckboxEvents();
    bindTimeInputEvents();
    bindCategoryEvents();
    bindAIHelpEvents();
    bindCopyButtonEvents();
}

/**
 * 스케줄 탭 관련 이벤트 바인딩
 */
function bindScheduleTabEvents() {
    // 탭 클릭 이벤트
    $('.schedule-tab').click(function() {
        var type = $(this).data('type');
        switchTab(type);
    });
    
    // 탭 키보드 이벤트
    $('.schedule-tab').keydown(function(e) {
        handleTabKeydown(e, this);
    });
}

/**
 * 탭 키보드 이벤트 처리
 */
function handleTabKeydown(e, element) {
    var $tabs = $('.schedule-tab');
    var currentIndex = $tabs.index(element);
    var nextIndex;
    
    switch(e.key) {
        case 'ArrowLeft':
            e.preventDefault();
            nextIndex = currentIndex > 0 ? currentIndex - 1 : $tabs.length - 1;
            focusTab($tabs, nextIndex, element);
            break;
        case 'ArrowRight':
            e.preventDefault();
            nextIndex = currentIndex < $tabs.length - 1 ? currentIndex + 1 : 0;
            focusTab($tabs, nextIndex, element);
            break;
        case 'Enter':
        case ' ':
            e.preventDefault();
            var type = $(element).data('type');
            switchTab(type);
            break;
        case 'Home':
            e.preventDefault();
            focusTab($tabs, 0, element);
            break;
        case 'End':
            e.preventDefault();
            focusTab($tabs, $tabs.length - 1, element);
            break;
    }
}

/**
 * 탭 포커스 처리
 */
function focusTab($tabs, index, currentElement) {
    $tabs.eq(index).focus().attr('tabindex', '0');
    $(currentElement).attr('tabindex', '-1');
}

/**
 * 체크박스 관련 이벤트 바인딩
 */
function bindCheckboxEvents() {
    $('input[type="checkbox"]').change(function() {
        var type = $(this).closest('.schedule-tab-content').attr('id').replace('-content', '');
        updateSelectedDisplay(type);
        updateScheduleSummary();
    });
}

/**
 * 시간 입력 관련 이벤트 바인딩
 */
function bindTimeInputEvents() {
    $('input[type="time"], input[type="number"]').change(function() {
        updateScheduleSummary();
    });
}

/**
 * 카테고리 관련 이벤트 바인딩
 */
function bindCategoryEvents() {
    $('#categorySelectBtn').click(function() {
        openCategoryPopup();
    });
    
    $('#categoryClearBtn').click(function() {
        clearCategorySelection();
    });
}

/**
 * AI 도움 관련 이벤트 바인딩
 */
function bindAIHelpEvents() {
    $('#bnt_aiHelp, #btn_aiHelp').click(function() {
        if ($(this).prop('disabled')) {
            alert('먼저 "API데이터 확인" 버튼을 클릭해주세요.');
            return;
        }
        requestAIHelp();
    });
}

/**
 * 복사 버튼 관련 이벤트 바인딩
 */
function bindCopyButtonEvents() {
    $('#copyBtn').click(function() {
        copyApiSettings();
    });
}

// 탭 전환
function switchTab(type) {
    currentScheduleType = type;
    
    // 탭 활성화
    $('.schedule-tab').removeClass('active').attr('aria-selected', 'false').attr('tabindex', '-1');
    $('.schedule-tab[data-type="' + type + '"]').addClass('active').attr('aria-selected', 'true').attr('tabindex', '0');
    
    // 컨텐츠 활성화
    $('.schedule-tab-content').removeClass('active');
    $('#' + type + '-content').addClass('active');
    
    // 현재 활성화된 탭의 필드들만 name 속성 부여
    updateScheduleFieldNames();
    
    // 스케줄 요약 업데이트
    updateScheduleSummary();
}

// 현재 활성화된 탭의 필드들만 name 속성 부여
function updateScheduleFieldNames() {
    // 모든 스케줄 필드의 name 속성 제거
    $('input[name$="StartTime"], input[name$="EndTime"], input[name$="Interval"], input[name$="Days[]"]').removeAttr('name');
    
    // 현재 활성화된 탭의 필드들만 name 속성 부여
    switch(currentScheduleType) {
        case 'daily':
            $('#dailyStartTime').attr('name', 'dailyStartTime');
            $('#dailyEndTime').attr('name', 'dailyEndTime');
            $('#dailyInterval').attr('name', 'dailyInterval');
            break;
            
        case 'weekly':
            $('#weeklyStartTime').attr('name', 'weeklyStartTime');
            $('#weeklyEndTime').attr('name', 'weeklyEndTime');
            $('#weeklyInterval').attr('name', 'weeklyInterval');
            $('#weekly-content input[type="checkbox"]').attr('name', 'weeklyDays[]');
            break;
            
        case 'monthly':
            $('#monthlyStartTime').attr('name', 'monthlyStartTime');
            $('#monthlyEndTime').attr('name', 'monthlyEndTime');
            $('#monthlyInterval').attr('name', 'monthlyInterval');
            $('#monthly-content input[type="checkbox"]').attr('name', 'monthlyDays[]');
            break;
            
        case 'quarterly':
            $('#quarterlyStartTime').attr('name', 'quarterlyStartTime');
            $('#quarterlyEndTime').attr('name', 'quarterlyEndTime');
            $('#quarterlyInterval').attr('name', 'quarterlyInterval');
            $('#quarterly-content input[type="checkbox"]').attr('name', 'quarterlyQuarters[]');
            break;
            
        case 'yearly':
            $('#yearlyStartTime').attr('name', 'yearlyStartTime');
            $('#yearlyEndTime').attr('name', 'yearlyEndTime');
            $('#yearlyInterval').attr('name', 'yearlyInterval');
            $('#yearly-content input[type="checkbox"]').attr('name', 'yearlyMonths[]');
            break;
    }
}

// 선택된 항목 표시 업데이트
function updateSelectedDisplay(type) {
    var selectedItems = [];
    var container = $('#' + type + '-content');
    
    container.find('input[type="checkbox"]:checked').each(function() {
        var value = $(this).val();
        var label = $(this).next('label').text();
        selectedItems.push({value: value, text: label});
    });
    
    var selectedContainer = $('#' + type + '-selected');
    var selectedText = $('#' + type + '-selected-text');
    
    if(selectedItems.length > 0) {
        selectedText.empty();
        selectedItems.forEach(function(item) {
            selectedText.append('<span class="selected-item">' + item.text + '</span>');
        });
        selectedContainer.removeClass('hidden');
    } else {
        selectedContainer.addClass('hidden');
    }
}

// 스케줄 요약 업데이트 (현재 활성화된 탭의 데이터만 저장)
function updateScheduleSummary() {
    var summary = '';
    var startTime = $('#' + currentScheduleType + 'StartTime').val() || '09:00';
    var endTime = $('#' + currentScheduleType + 'EndTime').val() || '18:00';
    var interval = $('#' + currentScheduleType + 'Interval').val() || '60';
    
    switch(currentScheduleType) {
        case 'daily':
            summary = '매일 ' + startTime + ' ~ ' + endTime + ', ' + interval + '분 주기로 실행됩니다.';
            break;
        case 'weekly':
            var selectedDays = [];
            $('#weekly-content input[type="checkbox"]:checked').each(function() {
                selectedDays.push($(this).next('label').text());
            });
            if(selectedDays.length > 0) {
                summary = selectedDays.join(', ') + ' ' + startTime + ' ~ ' + endTime + ', ' + interval + '분 주기로 실행됩니다.';
            } else {
                summary = '선택된 요일 ' + startTime + ' ~ ' + endTime + ', ' + interval + '분 주기로 실행됩니다.';
            }
            break;
        case 'monthly':
            var selectedDays = [];
            $('#monthly-content input[type="checkbox"]:checked').each(function() {
                selectedDays.push($(this).next('label').text());
            });
            if(selectedDays.length > 0) {
                summary = '매월 ' + selectedDays.join(', ') + ' ' + startTime + ' ~ ' + endTime + ', ' + interval + '분 주기로 실행됩니다.';
            } else {
                summary = '선택된 일자 ' + startTime + ' ~ ' + endTime + ', ' + interval + '분 주기로 실행됩니다.';
            }
            break;
        case 'quarterly':
            var selectedQuarters = [];
            $('#quarterly-content input[type="checkbox"]:checked').each(function() {
                selectedQuarters.push($(this).next('label').text());
            });
            if(selectedQuarters.length > 0) {
                summary = selectedQuarters.join(', ') + ' ' + startTime + ' ~ ' + endTime + ', ' + interval + '분 주기로 실행됩니다.';
            } else {
                summary = '선택된 분기 ' + startTime + ' ~ ' + endTime + ', ' + interval + '분 주기로 실행됩니다.';
            }
            break;
        case 'yearly':
            var selectedMonths = [];
            $('#yearly-content input[type="checkbox"]:checked').each(function() {
                selectedMonths.push($(this).next('label').text());
            });
            if(selectedMonths.length > 0) {
                summary = '매년 ' + selectedMonths.join(', ') + ' ' + startTime + ' ~ ' + endTime + ', ' + interval + '분 주기로 실행됩니다.';
            } else {
                summary = '선택된 월 ' + startTime + ' ~ ' + endTime + ', ' + interval + '분 주기로 실행됩니다.';
            }
            break;
    }
    
    $('#' + currentScheduleType + '-summary').text(summary);
    
    // 현재 활성화된 탭의 데이터만 저장하도록 hidden input 업데이트
    updateScheduleConfigHidden();
}

// 스케줄 설정 JSON 생성 (현재 활성화된 탭의 데이터만 저장)
function generateScheduleConfig() {
    var config = {
        type: currentScheduleType,
        startTime: $('#' + currentScheduleType + 'StartTime').val() || '09:00',
        endTime: $('#' + currentScheduleType + 'EndTime').val() || '18:00',
        interval: parseInt($('#' + currentScheduleType + 'Interval').val()) || 60
    };
    
    // 현재 활성화된 탭의 선택된 항목들 추가
    switch(currentScheduleType) {
        case 'weekly':
            var weeklyDays = [];
            $('#weekly-content input[type="checkbox"]:checked').each(function() {
                weeklyDays.push(parseInt($(this).val()));
            });
            config.days = weeklyDays;
            break;
            
        case 'monthly':
            var monthlyDays = [];
            $('#monthly-content input[type="checkbox"]:checked').each(function() {
                monthlyDays.push(parseInt($(this).val()));
            });
            config.days = monthlyDays;
            break;
            
        case 'quarterly':
            var quarterlyQuarters = [];
            $('#quarterly-content input[type="checkbox"]:checked').each(function() {
                quarterlyQuarters.push(parseInt($(this).val()));
            });
            config.quarters = quarterlyQuarters;
            break;
            
        case 'yearly':
            var yearlyMonths = [];
            $('#yearly-content input[type="checkbox"]:checked').each(function() {
                yearlyMonths.push(parseInt($(this).val()));
            });
            config.months = yearlyMonths;
            break;
    }
    
    return config;
}

// 스케줄 설정을 hidden input에 업데이트 (현재 활성화된 탭의 데이터만 저장)
function updateScheduleConfigHidden() {
    var scheduleConfig = generateScheduleConfig();
    $('#scheduleConfig').val(JSON.stringify(scheduleConfig));
}

// 기존 데이터 로드
function loadExistingData() {
    // DB에서 스케줄 설정 로드
    var config = null;
    
    // 전역 scheduleData 변수 우선 사용
    if(typeof scheduleData !== 'undefined' && scheduleData && Object.keys(scheduleData).length > 0) {
        config = scheduleData;
        console.log('전역 scheduleData 사용:', config);
    } else {
        // hidden input에서 스케줄 데이터 로드 (기존 방식)
        var scheduleDataValue = $('#loadScheduleData').val();
        if(scheduleDataValue && scheduleDataValue.trim() !== '') {
            try {
                config = JSON.parse(scheduleDataValue);
                console.log('hidden input에서 스케줄 데이터 로드:', config);
            } catch(e) {
            }
        }
    }
    
    if(config && config.type) {
        
        // 스케줄 타입에 따라 탭 활성화
        switchTab(config.type);
        
        // 중첩된 구조에서 데이터 추출 (기존 DB 구조 지원)
        var scheduleDataToUse = config;
        if(config[config.type]) {
            // 중첩된 구조인 경우 (예: {type: "weekly", weekly: {...}})
            scheduleDataToUse = config[config.type];
        }
        
        // 시간 설정 복원
        if(scheduleDataToUse.startTime) {
            $('#' + config.type + 'StartTime').val(scheduleDataToUse.startTime);
        }
        if(scheduleDataToUse.endTime) {
            $('#' + config.type + 'EndTime').val(scheduleDataToUse.endTime);
        }
        if(scheduleDataToUse.interval) {
            $('#' + config.type + 'Interval').val(scheduleDataToUse.interval);
        }
        
        // 선택된 항목들 복원
        if(config.type === 'weekly' && scheduleDataToUse.days) {
            // 기존 체크박스 모두 해제
            $('#weekly-content input[type="checkbox"]').prop('checked', false);
            
            // days가 문자열인 경우 배열로 변환
            var daysArray = scheduleDataToUse.days;
            if(typeof daysArray === 'string') {
                daysArray = daysArray.split(',').map(function(day) {
                    return parseInt(day.trim());
                });
            }
            
            daysArray.forEach(function(day) {
                $('#weekly-content input[value="' + day + '"]').prop('checked', true);
            });
        }
        
        if(config.type === 'monthly' && scheduleDataToUse.days) {
            // 기존 체크박스 모두 해제
            $('#monthly-content input[type="checkbox"]').prop('checked', false);
            
            // days가 문자열인 경우 배열로 변환
            var daysArray = scheduleDataToUse.days;
            if(typeof daysArray === 'string') {
                daysArray = daysArray.split(',').map(function(day) {
                    return parseInt(day.trim());
                });
            }
            
            daysArray.forEach(function(day) {
                $('#monthly-content input[value="' + day + '"]').prop('checked', true);
            });
        }
        
        if(config.type === 'quarterly' && scheduleDataToUse.quarters) {
            // 기존 체크박스 모두 해제
            $('#quarterly-content input[type="checkbox"]').prop('checked', false);
            
            // quarters가 문자열인 경우 배열로 변환
            var quartersArray = scheduleDataToUse.quarters;
            if(typeof quartersArray === 'string') {
                quartersArray = quartersArray.split(',').map(function(quarter) {
                    return parseInt(quarter.trim());
                });
            }
            
            quartersArray.forEach(function(quarter) {
                $('#quarterly-content input[value="' + quarter + '"]').prop('checked', true);
            });
        }

        if(config.type === 'yearly' && scheduleDataToUse.months) {
            // 기존 체크박스 모두 해제
            $('#yearly-content input[type="checkbox"]').prop('checked', false);
            
            // months가 문자열인 경우 배열로 변환
            var monthsArray = scheduleDataToUse.months;
            if(typeof monthsArray === 'string') {
                monthsArray = monthsArray.split(',').map(function(month) {
                    return parseInt(month.trim());
                });
            }
            
            monthsArray.forEach(function(month) {
                $('#yearly-content input[value="' + month + '"]').prop('checked', true);
            });
        }
        
        // 선택된 항목 표시 업데이트
        updateSelectedDisplay(config.type);
        
        // 스케줄 요약 업데이트
        updateScheduleSummary();
        
        console.log('스케줄 데이터 로드 완료:', config);
    } else {
        // scheduleData가 없으면 기본 설정으로 초기화
        console.log('스케줄 데이터가 없어 기본 설정으로 초기화');
        // daily 탭을 기본으로 활성화
        switchTab('daily');
        updateScheduleSummary();
    }
    
    // 기존 카테고리 정보가 있으면 로드
    if(typeof result !== 'undefined' && result.item && result.item.categoryId) {
        var categoryData = {
            id: result.item.categoryId,
            name: result.item.categoryName || '',
            depth: result.item.categoryDepth || 0
        };
        
        // 카테고리 경로 정보가 있으면 설정
        if(result.item.categoryPath) {
            selectedCategoryPath = result.item.categoryPath.split(' > ');
        } else {
            // 경로 정보가 없으면 카테고리명만 사용
            selectedCategoryPath = [categoryData.name];
        }
        
        // 카테고리 선택 상태 설정
        selectCategory(categoryData);
    }
}
/**
 * Data check 버튼 클릭 시, 응답 JSON을 트리구조로 popup.html 스타일의 모달에 보여주는 함수
 * - 트리의 각 노드를 클릭하면 해당 노드의 경로(1depth > 2depth ...)를 input에 보여주고,
 *   확인 버튼을 누르면 #listTag에 PHP 배열첨자 형태(예: ['result'][0]['name'])로 입력
 * - 초보자도 이해할 수 있도록 주석 추가
 */
// API 데이터 확인 버튼 클릭 이벤트
$("#bnt_dataCheck").click(function () {
    // 기존 모달이 있으면 제거
    $("#apiResponseModal").remove();
    
    // 통합된 API 데이터 가져오기 함수 호출 (모달 표시)
    getUrlData(true);
});


// API 데이터 가져오기 (통합된 함수)
function getUrlData(showModal) {
    var key = $("#key").val();
    var rt = $("#returnType").val();
    var header = $("#header").val();
    var dateChar = $("#dateChar").val();
    var apiUrl = encodeURIComponent($("#url").val().trim());

    if(apiUrl == "") {
        alert("API URL을 입력하세요.");
        return;
    }

    makeAjaxRequest({
        crossOrigin: true,
        url: '/apis/getUrlData/ajax',
        method: 'POST',
        dataType: "json",
        data: {
            url: apiUrl,
            key: key,
            header: header,
            dateChar: dateChar
        }
    }).done(function(data) {
        // 모달 표시가 요청된 경우 (API 데이터 확인 버튼)
        if (showModal) {
            apiData = data;
            showApiDataModal(data);
        } else {
            // 필드 자동 채우기 (기존 getUrlData 로직)
            populateFieldsFromApiData(data);
        }
    }).fail(function(xhr, status, error) {
        var errorMessage = getErrorMessage(xhr, status, error);
        
        if (showModal) {
            showApiDataError(errorMessage);
        } else {
            alert(errorMessage);
        }
    });
}

// API 데이터로 필드 자동 채우기
function populateFieldsFromApiData(data) {
    var listTag = $("#listTag").val();
    if (listTag !== "") {
        try {
            data = eval("data['result']" + listTag);
        } catch (e) {
        }
    }
    
    var index = 1;
    $(".tr_row").remove();
    
    if (Array.isArray(data) && data.length > 0) {
        $.each(data[0], function(key, value) {
            var rowTmp = row.clone();
            var rowIndex = index++;
            rowTmp.find(".no").text(rowIndex);
            
            // 동적으로 생성되는 행의 ID를 고유하게 만들기
            rowTmp.find('[id$="_template"]').each(function() {
                var oldId = $(this).attr('id');
                var newId = oldId.replace('_template', '_' + rowIndex);
                $(this).attr('id', newId);
            });
            
            // 체크박스에 aria-label 추가
            rowTmp.find('input[type="checkbox"]').attr('aria-label', '주요 필드 선택');
            
            rowTmp.find("[name^='tag']").val(key);
            rowTmp.find("[name^='keyField']").val(index - 2);
            // remark 필드는 자동으로 채우지 않음 (사용자가 직접 입력)
            rowTmp.removeClass('tmp_row').addClass('tr_row');
            $("#collectionField tbody").append(rowTmp);
            
            // condition readonly 상태 업데이트 (tag 값이 있으므로 readonly 해제)
            updateConditionReadonlyState(rowTmp);
        });
        
        // AI 도움 버튼 활성화
        $('#bnt_aiHelp').prop('disabled', false).attr('aria-label', 'AI 도움');
    }
}

// API 데이터 모달 표시
function showApiDataModal(data) {
    /**
     * 트리 구조로 변환하는 재귀 함수
     * 각 노드에 data-path 속성으로 경로 정보를 저장
     */
    function jsonToTree(obj, pathArr) {
        pathArr = pathArr || [];
        if (obj === null) return '<span style="color:#888;">null</span>';
        if (typeof obj !== "object") {
            return '<span class="tree-leaf" data-path="' + encodeURIComponent(JSON.stringify(pathArr)) + '">' + $('<span/>').text(String(obj)).html() + '</span>';
        }

        // 배열 처리
        if (Array.isArray(obj)) {
            if (obj.length === 0) return '<span style="color:#888;">[빈 배열]</span>';
            var html = '<ul class="api-tree">';
            obj.forEach(function(item, idx) {
                var newPath = pathArr.concat([idx]);
                html += '<li><span class="api-tree-index api-tree-node" data-path="' + encodeURIComponent(JSON.stringify(newPath)) + '">[' + idx + ']</span>: ' + jsonToTree(item, newPath) + '</li>';
            });
            html += '</ul>';
            return html;
        }

        // 객체 처리
        var keys = Object.keys(obj);
        if (keys.length === 0) return '<span style="color:#888;">{빈 객체}</span>';
        var html = '<ul class="api-tree">';
        keys.forEach(function(key) {
            var value = obj[key];
            var newPath = pathArr.concat([key]);
            html += '<li><span class="api-tree-key api-tree-node" data-path="' + encodeURIComponent(JSON.stringify(newPath)) + '">' + $('<span/>').text(key).html() + '</span>: ' + jsonToTree(value, newPath) + '</li>';
        });
        html += '</ul>';
        return html;
    }

    // 최상위가 배열이면 첫 번째 객체로 트리 시작
    var rootObj = data;
    if (Array.isArray(data) && data.length > 0 && typeof data[0] === "object") {
        rootObj = data[0];
    }

    // 트리 HTML 생성
    var treeHtml = jsonToTree(rootObj, []);

    // 모달 HTML 생성
    var modalHtml = ''
        + '<div id="apiResponseModal" class="modal-overlay">'
        +   '<div class="modal-content" style="min-width:420px; max-width:90vw; max-height:85vh; display:flex; flex-direction:column; overflow:hidden;">'
        +     '<div class="modal-header">'
        +       '<span class="modal-title">API 응답 트리 구조</span>'
        +       '<button id="closeApiResponseModal" class="modal-close" title="닫기">'
        +         '<i class="fa fa-times"></i>'
        +       '</button>'
        +     '</div>'
        +     '<div class="modal-body">'
        +         treeHtml
        +     '</div>'
        +     '<div class="modal-footer">'
        +       '<div style="display:flex; align-items:center; gap:8px;">'
        +         '<input type="text" id="selectedNodePath" readonly style="flex:1; padding:6px 10px; font-size:14px; border:1px solid #d1d5db; border-radius:5px; background:#f3f4f6;" placeholder="노드를 클릭하면 경로가 표시됩니다">'
        +         '<button id="confirmNodePath" class="btn btn-primary" style="padding:7px 18px; font-size:14px; border-radius:6px;">확인</button>'
        +       '</div>'
        +     '</div>'
        +   '</div>'
        + '</div>';

    $("body").append(modalHtml);
    bindApiModalEvents();
}

// API 모달 이벤트 바인딩
function bindApiModalEvents() {
    // 닫기 버튼 이벤트
    $("#closeApiResponseModal, #closeApiResponseModal2").click(function () {
        $("#apiResponseModal").remove();
    });

    // ESC 키로 닫기
    $(document).on('keydown.apiResponseModal', function(e) {
        if (e.key === 'Escape') {
            $("#apiResponseModal").remove();
            $(document).off('keydown.apiResponseModal');
        }
    });

    // 트리 노드 클릭 시 경로 표시
    var selectedPathArr = null;
    $(document).on('click', '#apiResponseModal .api-tree-node', function(e) {
        e.stopPropagation();
        $('#apiResponseModal .api-tree-node').removeClass('selected');
        $(this).addClass('selected');

        var pathJson = decodeURIComponent($(this).attr('data-path'));
        try {
            selectedPathArr = JSON.parse(pathJson);
        } catch (e) {
            selectedPathArr = null;
        }

        if (selectedPathArr && selectedPathArr.length > 0) {
            var displayPath = selectedPathArr.map(function(p) {
                return (typeof p === 'number') ? '[' + p + ']' : p;
            }).join(' > ');
            $("#selectedNodePath").val(displayPath);
        } else {
            $("#selectedNodePath").val('');
        }
    });

    // 확인 버튼 클릭 시 listTag에 경로 입력
    $(document).on('click', '#confirmNodePath', function() {
        var selectedPath = $("#selectedNodePath").val();
        
        if (!selectedPath || selectedPath.trim() === '') {
            alert('노드를 먼저 선택하세요.');
            return;
        }
        
        // selectedPath 문자열을 파싱하여 경로 배열 생성
        // "result > data > item" 형태를 ["result", "data", "item"] 배열로 변환
        var pathArray = selectedPath.split(' > ').map(function(path) {
            return path.trim();
        });
        
        var phpPath = '';
        var startIdx = 0;

        // result로 시작하는 경우 startIdx 조정
        if (pathArray.length > 0 && pathArray[0] === 'result') {
            startIdx = 1;
        }
        
        // PHP 경로 생성
        for (var i = startIdx; i < pathArray.length; i++) {
            var p = pathArray[i];
            if (typeof p === 'number') {
                phpPath += '[' + p + ']';
            } else {
                phpPath += "['" + p + "']";
            }
        }

        // 선택된 노드의 전체 데이터를 배열로 저장
        // selectedPath 문자열을 사용하여 apiData에서 해당 노드에 접근
        var subItems = [];
        try {
            // apiData는 전역 또는 상위 스코프에 있다고 가정
            var node = apiData;
            // 선택된 경로를 따라가서 해당 노드에 접근
            for (var i = 0; i < pathArray.length; i++) {
                node = node[pathArray[i]];
            }
            // node가 배열이면 전체 데이터, 객체면 값 배열로 변환
            if (Array.isArray(node)) {
                subItems = node; // 전체 데이터 사용
            } else if (typeof node === 'object' && node !== null) {
                var values = Object.values(node);
                subItems = values; // 전체 데이터 사용
            } else {
                // 배열/객체가 아니면 단일 값만 배열로 저장
                subItems = [node];
            }
        } catch (e) {
            // 오류 발생 시 빈 배열로 처리
            subItems = [];
        }
        apiData = subItems;

        $("#listTag").val(phpPath);
        getUrlData(false); // 필드 자동 채우기

        $("#apiResponseModal").remove();
    });
}

// API 오류 모달 표시
function showApiDataError(error) {
    var errorHtml = ''
        + '<div id="apiResponseModal" style="position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;">'
        +   '<div style="background:#fff; border-radius:10px; min-width:320px; max-width:90vw; box-shadow:0 4px 24px rgba(0,0,0,0.18);">'
        +     '<div style="padding:24px 32px; text-align:center;">'
        +       '<div style="font-size:16px; color:#ef4444; font-weight:600; margin-bottom:10px;">'
        +         '<i class="fa fa-exclamation-triangle"></i> API 요청 중 오류가 발생했습니다'
        +       '</div>'
        +       '<div style="color:#888; font-size:13px; margin-bottom:18px;">'
        +         $('<span/>').text(error).html()
        +       '</div>'
        +       '<button id="closeApiResponseModal" class="btn btn-primary" style="padding:7px 22px; font-size:14px; border-radius:6px;">닫기</button>'
        +     '</div>'
        +   '</div>'
        + '</div>';
    $("body").append(errorHtml);
    $("#closeApiResponseModal").click(function () {
        $("#apiResponseModal").remove();
    });
}



$(document).on('click','.btn-addRow',function (){
	var rowTmp = row.clone();
	var rowIndex = $("#collectionField tbody").find("tr").length;
	rowTmp.find(".no").text(rowIndex);
	
	// 동적으로 생성되는 행의 ID를 고유하게 만들기
	rowTmp.find('[id$="_template"]').each(function() {
		var oldId = $(this).attr('id');
		var newId = oldId.replace('_template', '_' + rowIndex);
		$(this).attr('id', newId);
	});
	
	// 체크박스에 aria-label 추가
	rowTmp.find('input[type="checkbox"]').attr('aria-label', '주요 필드 선택');
	
	$("#collectionField tbody").append(rowTmp);
	
	// 새 행의 condition readonly 상태 초기화 (tag가 비어있으므로 readonly)
	updateConditionReadonlyState(rowTmp);
});

// 행 삭제 기능
$(document).on('click','.btn-deleteRow',function (){
	var $row = $(this).closest('tr');
	
	// 확인 대화상자 표시
	if(confirm('이 행을 삭제하시겠습니까?')) {
		$row.remove();
		// 삭제 후 번호 재정렬
		updateRowNumbers();
	}
});

// 행 번호 재정렬 함수
function updateRowNumbers() {
	$("#collectionField tbody tr").each(function(index) {
		$(this).find(".no").text(index + 1);
	});
}

// ==================== 필드 추천 및 자동 설정 ====================
// 필드 메타 정의: 라벨, 필수 여부, 주요필드(키필드) 여부
var FIELD_META = {
	date:      { label: '날짜',   required: true,  key: true  },
	price:     { label: '가격',   required: true,  key: false },
	name:      { label: '품명',   required: true,  key: true  },
	kind:      { label: '품종',   required: true,  key: true  },
	grade:     { label: '등급',   required: true,  key: true  },
	gradeCode: { label: '등급코드', required: false, key: false },
	market:    { label: '시장',   required: false, key: true  },
	unit:      { label: '단위',   required: false, key: false }
};

// 선택 시 동일 행의 주요필드 체크, 비고 자동 입력
function applyFieldSelectionBehavior($fieldInput) {
	var value = ($fieldInput.val() || '').trim();
	var key = value.toLowerCase();
	var meta = FIELD_META[key];
	if (!meta) return;

	var $row = $fieldInput.closest('tr');
	$row.find('input[name="keyField[]"]').prop('checked', !!meta.key);
	$row.find('input[name="remark[]"]').val(meta.label);
	
	// date 필드인 경우 value[]에 날짜 함수 입력
	if (key === 'date') {
		var $valueInput = $row.find('input[name="value[]"]');
		var currentValue = $valueInput.val().trim();
		// 값이 비어있으면 자동 입력
		if (!currentValue) {
			$valueInput.val('date("Y-m-d",$curDate)');
		}
	}
}

// 포커스 시 추천 리스트 보이기(datalist 활용) 및 입력/변경 시 동작 적용
$(document).on('focus', 'input[name="field[]"]', function() {
	this.setAttribute('list', 'fieldKind');
});

$(document).on('input change', 'input[name="field[]"]', function() {
	applyFieldSelectionBehavior($(this));
});

// tag[] 필드 값에 따라 condition[] 필드 readonly 상태 제어
function updateConditionReadonlyState($row) {
	var $tagInput = $row.find('input[name="tag[]"]');
	var $conditionInput = $row.find('input[name="condition[]"]');
	var tagValue = $tagInput.val().trim();
	
	if (tagValue === '') {
		// tag 값이 비어있으면 condition을 readonly로 설정하고 값 비우기
		$conditionInput.prop('readonly', true);
		$conditionInput.val('');
		$conditionInput.css('background-color', '#f0f0f0');
		$conditionInput.attr('placeholder', 'Tag 값을 먼저 입력하세요');
	} else {
		// tag 값이 있으면 condition readonly 해제
		$conditionInput.prop('readonly', false);
		$conditionInput.css('background-color', '');
		$conditionInput.attr('placeholder', '=="배추"(값이 배추인경우) > 20 (20보다 큰경우), <= 20(20보다 작거나 같은경우), !=30(30과 같지않다.) ');
	}
}

// tag[] 필드 값 변경 시 condition[] readonly 상태 업데이트
$(document).on('input change', 'input[name="tag[]"]', function() {
	var $row = $(this).closest('tr');
	updateConditionReadonlyState($row);
});

// 조건 필드에 선택된 row 값 자동 입력 기능
$(document).on('click', 'input[name="condition[]"]', function() {
	var $conditionInput = $(this);
	
	// readonly 상태이면 아무 동작 안 함
	if ($conditionInput.prop('readonly')) {
		alert('Tag 값을 먼저 입력해주세요.');
		return;
	}
	
	var currentValue = $conditionInput.val().trim();
	
	// 선택된 row 데이터가 있고, 값이 비어있는 경우에만 자동 입력
	if (window.selectedRowData && !currentValue) {
		var $row = $conditionInput.closest('tr');
		var $tagInput = $row.find('input[name="tag[]"]');
		var tagName = $tagInput.val().trim();
		
		console.log('조건 필드 클릭 - tagName:', tagName);
		console.log('선택된 row 데이터:', window.selectedRowData);
		
		// 선택된 row 데이터에서 tag 이름과 일치하는 값 가져오기
		if (tagName && window.selectedRowData[tagName]) {
			var value = window.selectedRowData[tagName];
			var newValue = '=="' + value + '"';
			$conditionInput.val(newValue);
			console.log('조건 필드에 값 입력:', newValue);
		} else {
			console.log('태그명이 없거나 값이 없습니다. tagName:', tagName);
		}
	}
});

// 페이지 로드 시 초기 값들에 대해서도 동작 적용
$(function() {
	$('input[name="field[]"]').each(function() {
		applyFieldSelectionBehavior($(this));
	});
	
	// 모든 행의 condition readonly 상태 초기화
	$('#collectionField tbody tr').each(function() {
		updateConditionReadonlyState($(this));
	});
});

// 필수 필드 존재 검증
function validateFieldRequirements() {
	var present = {};
	$('input[name="field[]"]').each(function() {
		var v = ($(this).val() || '').trim().toLowerCase();
		if (v) present[v] = true;
	});

	var requiredKeys = Object.keys(FIELD_META).filter(function(k){ return FIELD_META[k].required; });
	var missing = [];
	for (var i = 0; i < requiredKeys.length; i++) {
		var k = requiredKeys[i];
		if (!present[k]) {
			missing.push(FIELD_META[k].label + ' (' + k + ')');
		}
	}

	if (missing.length > 0) {
		alert('필수 필드가 누락되었습니다:\n- ' + missing.join('\n- '));
		return false;
	}
	return true;
}

$("#saveBtn").click(function (){
    // 필수 필드 검증
    if($('#title').val().trim() == ''){
        alert('API 주제명을 입력해주세요.');
        $('#title').focus();
        return;
    }
    
    if($('#provider').val().trim() == ''){
        alert('제공사를 입력해주세요.');
        $('#provider').focus();
        return;
    }
    
    if($('#key').val().trim() == ''){
        alert('API Key를 입력해주세요.');
        $('#key').focus();
        return;
    }
    
    if($('#url').val().trim() == ''){
        alert('API URL을 입력해주세요.');
        $('#url').focus();
        return;
    }
    
    if($('#categoryId').val().trim() == ''){
        alert('카테고리를 선택해주세요.');
        $('#categorySelectBtn').focus();
        return;
    }
    
    // 스케줄 설정 검증
    if(!validateScheduleSettings()){
        return;
    }

	// 필드 요구사항 검증 (date, price, name, kind, grade)
	if(!validateFieldRequirements()){
		return;
	}

    // 바로 저장 (요약 모달 건너뛰기)
    confirmSave();
});

// 저장 전 요약 표시
function showSaveSummary() {
    // 폼 데이터 수집
    var formData = collectFormData();
    
    // 요약 HTML 생성
    var summaryHtml = generateSaveSummaryHtml(formData);
    
    // 모달 표시
    showSaveSummaryModal(summaryHtml);
}

// 폼 데이터 수집
function collectFormData() {
    var data = {
        basic: {
            title: $('#title').val(),
            provider: $('#provider').val(),
            url: $('#url').val(),
            returnType: $('#returnType').val(),
            categoryName: $('#categoryName').val(),
            isUse: $('#isUse').val(),
            isChartUse: $('#isChartUse').val(),
            key: $('#key').val(),
            dateChar: $('#dateChar').val(),
            listTag: $('#listTag').val()
        },
        schedule: generateScheduleConfig(),
        fields: getCollectionFieldData()
    };
    
    return data;
}

// 저장 요약 HTML 생성
function generateSaveSummaryHtml(data) {
    var html = '<div style="max-width: 800px; text-align: left;">';
    html += '<h3 style="color: #0369a1; margin-bottom: 20px;">📋 API 설정 요약</h3>';
    
    // 기본 정보
    html += '<div class="summary-section basic">';
    html += '<h4>🔧 기본 정보</h4>';
    html += '<table class="summary-table">';
    html += '<tr><th>제목:</th><td>' + data.basic.title + '</td></tr>';
    html += '<tr><th>제공사:</th><td>' + data.basic.provider + '</td></tr>';
    html += '<tr><th>URL:</th><td style="word-break: break-all;">' + data.basic.url + '</td></tr>';
    html += '<tr><th>응답 형식:</th><td>' + data.basic.returnType + '</td></tr>';
    html += '<tr><th>카테고리:</th><td>' + data.basic.categoryName + '</td></tr>';
    html += '<tr><th>사용 여부:</th><td>' + (data.basic.isUse === 'Y' ? '사용' : '미사용') + '</td></tr>';
    html += '<tr><th>차트 사용:</th><td>' + (data.basic.isChartUse === 'Y' ? '사용' : '미사용') + '</td></tr>';
    html += '</table></div>';
    
    // 스케줄 정보
    html += '<div class="summary-section schedule">';
    html += '<h4>⏰ 수집 스케줄</h4>';
    html += '<table class="summary-table">';
    html += '<tr><th>주기:</th><td>' + getScheduleTypeName(data.schedule.type) + '</td></tr>';
    html += '<tr><th>시작 시간:</th><td>' + (data.schedule.startTime || '09:00') + '</td></tr>';
    html += '<tr><th>종료 시간:</th><td>' + (data.schedule.endTime || '18:00') + '</td></tr>';
    html += '<tr><th>실행 간격:</th><td>' + (data.schedule.interval || 60) + '분</td></tr>';
    html += '</table></div>';
    
    // 필드 설정
    if (data.fields && data.fields.length > 0) {
        html += '<div class="summary-section fields">';
        html += '<h4>🔧 필드 설정 (' + data.fields.length + '개)</h4>';
        html += '<div style="max-height: 200px; overflow-y: auto;">';
        html += '<table class="summary-table" style="font-size: 14px;">';
        html += '<thead><tr style="background: #f3f4f6;"><th style="text-align: left; border: 1px solid #d1d5db;">원본 태그</th><th style="text-align: left; border: 1px solid #d1d5db;">DB 필드</th><th style="text-align: center; border: 1px solid #d1d5db;">키필드</th><th style="text-align: left; border: 1px solid #d1d5db;">기본값</th></tr></thead>';
        html += '<tbody>';
        data.fields.forEach(function(field) {
            html += '<tr>';
            html += '<td style="border: 1px solid #d1d5db;">' + (field.tag || '') + '</td>';
            html += '<td style="border: 1px solid #d1d5db;">' + (field.field || '') + '</td>';
            html += '<td style="border: 1px solid #d1d5db; text-align: center;">' + (field.keyField === '1' ? '✓' : '') + '</td>';
            html += '<td style="border: 1px solid #d1d5db;">' + (field.defaultValue || '') + '</td>';
            html += '</tr>';
        });
        html += '</tbody></table></div></div>';
    }
    
    // 확인 버튼
    html += '<div style="text-align: center; margin-top: 20px;">';
    html += '<button onclick="confirmSave()" style="background: #10b981; color: white; border: none; padding: 10px 24px; border-radius: 6px; cursor: pointer; margin-right: 10px; font-size: 14px;">저장하기</button>';
    html += '<button onclick="$(this).closest(\'.modal\').remove()" style="background: #6b7280; color: white; border: none; padding: 10px 24px; border-radius: 6px; cursor: pointer; font-size: 14px;">취소</button>';
    html += '</div></div>';
    
    return html;
}

// 저장 요약 모달 표시
function showSaveSummaryModal(html) {
    var modalHtml = '<div class="modal modal-overlay">';
    modalHtml += '<div class="modal-content">';
    modalHtml += html;
    modalHtml += '</div></div>';
    
    $('body').append(modalHtml);
}

// 실제 저장 실행
function confirmSave() {
    // condition[] 필드가 누락되지 않도록 확인
    ensureConditionFields();

    // 스케줄 설정을 schedule 배열로 생성
    var scheduleConfig = generateScheduleConfig();
    
    // schedule 배열을 폼에 추가
    var scheduleHtml = '';
    Object.keys(scheduleConfig).forEach(function(key) {
        scheduleHtml += '<input type="hidden" name="schedule[' + key + ']" value="' + scheduleConfig[key] + '">';
    });
    
    // 기존 scheduleConfig hidden input 제거
    $('#scheduleConfig').remove();
    
    // 새로운 schedule 배열 추가
    $('#inputForm').append(scheduleHtml);

    // 디버깅: 전송할 데이터 확인
    var formData = $('#inputForm').serialize();
    console.log('전송할 폼 데이터:', formData);
    
    // condition[] 필드가 포함되어 있는지 확인
    if (formData.indexOf('condition%5B%5D') === -1) {
        console.warn('condition[] 필드가 폼 데이터에 포함되지 않았습니다.');
    } else {
        console.log('condition[] 필드가 폼 데이터에 포함되었습니다.');
    }

    // 모달 닫기
    $('.modal').remove();

    // AJAX로 저장 실행
    makeAjaxRequest({
        url: '/apis/'+action+'/ajax',
        method: 'POST',
        data: formData
    }).done(function() {
        alert('저장되었습니다.');
        goList();
    }).fail(function(xhr, status, error) {
        alert('저장 중 오류가 발생했습니다: ' + error);
    });
}

// condition[] 필드가 모든 행에 있는지 확인하고 누락된 경우 추가
function ensureConditionFields() {
    $('#fieldList tbody tr').each(function() {
        var $row = $(this);
        var $conditionField = $row.find('[name="condition[]"]');
        
        // condition[] 필드가 없는 경우 추가
        if ($conditionField.length === 0) {
            var $valueCell = $row.find('[name="value[]"]').closest('td');
            var $conditionCell = $valueCell.next();
            
            // condition 필드가 있는 셀이 없다면 새로 생성
            if ($conditionCell.length === 0 || $conditionCell.find('[name="condition[]"]').length === 0) {
                var conditionHtml = '<td>' +
                    '<input type="text" placeholder=\'=="배추"(값이 배추인경우) > 20 (20보다 큰경우), <= 20(20보다 작거나 같은경우), !=30(30과 같지않다.) \' ' +
                    'name="condition[]" class="form-control">' +
                    '</td>';
                
                $valueCell.after(conditionHtml);
            }
        }
    });
}

// 스케줄 설정 검증
function validateScheduleSettings() {
    var currentContent = $('#' + currentScheduleType + '-content');
    
    switch(currentScheduleType) {
        case 'daily':
            if(!$('#dailyStartTime').val() || !$('#dailyEndTime').val()) {
                alert('시작 시간과 종료 시간을 설정해주세요.');
                return false;
            }
            if(!$('#dailyInterval').val() || $('#dailyInterval').val() < 1) {
                alert('실행 주기를 설정해주세요. (최소 1분)');
                $('#dailyInterval').focus();
                return false;
            }
            break;
        case 'weekly':
            if(currentContent.find('input[type="checkbox"]:checked').length === 0) {
                alert('최소 하나의 요일을 선택해주세요.');
                return false;
            }
            if(!$('#weeklyStartTime').val() || !$('#weeklyEndTime').val()) {
                alert('시작 시간과 종료 시간을 설정해주세요.');
                return false;
            }
            if(!$('#weeklyInterval').val() || $('#weeklyInterval').val() < 1) {
                alert('실행 주기를 설정해주세요. (최소 1분)');
                $('#weeklyInterval').focus();
                return false;
            }
            break;
        case 'monthly':
            if(currentContent.find('input[type="checkbox"]:checked').length === 0) {
                alert('최소 하나의 일자를 선택해주세요.');
                return false;
            }
            if(!$('#monthlyStartTime').val() || !$('#monthlyEndTime').val()) {
                alert('시작 시간과 종료 시간을 설정해주세요.');
                return false;
            }
            if(!$('#monthlyInterval').val() || $('#monthlyInterval').val() < 1) {
                alert('실행 주기를 설정해주세요. (최소 1분)');
                $('#monthlyInterval').focus();
                return false;
            }
            break;
        case 'quarterly':
            if(currentContent.find('input[type="checkbox"]:checked').length === 0) {
                alert('최소 하나의 분기를 선택해주세요.');
                return false;
            }
            if(!$('#quarterlyStartTime').val() || !$('#quarterlyEndTime').val()) {
                alert('시작 시간과 종료 시간을 설정해주세요.');
                return false;
            }
            if(!$('#quarterlyInterval').val() || $('#quarterlyInterval').val() < 1) {
                alert('실행 주기를 설정해주세요. (최소 1분)');
                $('#quarterlyInterval').focus();
                return false;
            }
            break;
        case 'yearly':
            if(currentContent.find('input[type="checkbox"]:checked').length === 0) {
                alert('최소 하나의 월을 선택해주세요.');
                return false;
            }
            if(!$('#yearlyStartTime').val() || !$('#yearlyEndTime').val()) {
                alert('시작 시간과 종료 시간을 설정해주세요.');
                return false;
            }
            if(!$('#yearlyInterval').val() || $('#yearlyInterval').val() < 1) {
                alert('실행 주기를 설정해주세요. (최소 1분)');
                $('#yearlyInterval').focus();
                return false;
            }
            break;
    }
    
    return true;
}

$("#listBtn").click(()=>{
	goList();
});

// 리스트 함수
let goList = ()=>{
	// URL 파라미터에서 페이지 정보 추출
	var urlParams = new URLSearchParams(window.location.search);
	var page = urlParams.get('page');
	var searchText = urlParams.get('searchText');
	var category = urlParams.get('category');
	
	// 목록 URL 생성
	var listUrl = '/apis/list';
	var params = [];
	
	if (page) {
		params.push('page=' + encodeURIComponent(page));
	}
	if (searchText) {
		params.push('searchText=' + encodeURIComponent(searchText));
	}
	if (category) {
		params.push('category=' + encodeURIComponent(category));
	}
	
	if (params.length > 0) {
		listUrl += '?' + params.join('&');
	}
	
	location.href = listUrl;
}

/**
 * API 설정 복사 기능
 */
function copyApiSettings() {
    // 확인 대화상자
    if (!confirm('현재 API 설정을 복사하여 새로운 API로 저장하시겠습니까?')) {
        return;
    }
    
    // 복사 모드로 전환
    action = 'insert';
    $('#saveBtn').text('API저장');
    
    // URL에서 ID 제거 (새로운 API로 저장하기 위해)
    var currentUrl = window.location.href;
    var newUrl = currentUrl.replace(/[?&]id=[^&]*/, '');
    if (newUrl.includes('?')) {
        newUrl += '&copy=true';
    } else {
        newUrl += '?copy=true';
    }
    
    // URL 업데이트 (히스토리 추가하지 않음)
    window.history.replaceState({}, '', newUrl);
    
    // 필드 초기화
    resetFieldsForCopy();
}

/**
 * 복사를 위한 필드 초기화
 */
function resetFieldsForCopy() {
    // 제목에 "(복사)" 추가
    var currentTitle = $('#title').val();
    if (currentTitle && !currentTitle.includes('(복사)')) {
        $('#title').val(currentTitle + ' (복사)');
    }
    
    // API ID에 "(복사)" 추가 (새로운 API이지만 기존 ID 유지)
    var currentId = $('#id').val();
    if (currentId && !currentId.includes('_copy')) {
        $('#id').val(currentId + '_copy');
    }
    
    // 생성일/수정일 관련 필드 초기화
    $('input[name="createDate"], input[name="updateDate"]').val('');
    
    // 기타 고유 식별자들 초기화
    $('input[name="lastRun"], input[name="lastRunStatus"]').val('');
    
    // 스케줄 설정은 유지 (사용자가 원하는 대로 수정 가능)
    
    // AI 도움 버튼 비활성화 (새로운 API이므로)
    $('#bnt_aiHelp, #btn_aiHelp').prop('disabled', true);
    
    // 페이지 제목 업데이트
    document.title = document.title.replace('수정', '등록');
}

// ==================== Provider 드롭다운 관련 함수들 ====================

// Provider 드롭다운 초기화
function initProviderDropdown() {
    // 드롭다운 버튼 클릭 이벤트
    $('#providerDropdownBtn').click(function(e) {
        e.preventDefault();
        e.stopPropagation();
        toggleProviderDropdown();
    });
    
    // 검색 기능
    $('#providerSearch').on('input', function() {
        filterProviders($(this).val());
    });
    
    // 외부 클릭 시 드롭다운 닫기
    $(document).click(function(e) {
        if (!$(e.target).closest('.provider-input-container').length) {
            hideProviderDropdown();
        }
    });
    
    // Provider input에서 엔터키 방지
    $('#provider').on('keydown', function(e) {
        if (e.keyCode === 13) {
            e.preventDefault();
        }
    });
}

// Provider 드롭다운 토글
function toggleProviderDropdown() {
    if ($('#providerDropdown').is(':visible')) {
        hideProviderDropdown();
    } else {
        showProviderDropdown();
    }
}

// Provider 드롭다운 표시
function showProviderDropdown() {
    // 제공사 목록이 없으면 로드
    if (providerList.length === 0) {
        loadProviderList();
    } else {
        $('#providerDropdown').show();
        $('#providerDropdownBtn').attr('aria-expanded', 'true');
        $('#providerSearch').focus();
    }
}

// Provider 드롭다운 숨기기
function hideProviderDropdown() {
    $('#providerDropdown').hide();
    $('#providerDropdownBtn').attr('aria-expanded', 'false');
    $('#providerSearch').val('');
    filteredProviders = providerList;
}

// 제공사 목록 로드 - /apis/providerList/ajax 호출
function loadProviderList() {
    $('#providerDropdownList').html('<div class="provider-loading">제공사 목록을 불러오는 중...</div>');
    $('#providerDropdown').show();
    $('#providerDropdownBtn').attr('aria-expanded', 'true');
    
    // /apis/providerList/ajax 엔드포인트 호출
    makeAjaxRequest({
        url: '/apis/providerList/ajax?status=active',
        method: 'GET',
        dataType: 'json',
        timeout: 10000 // 10초 타임아웃
    }).done(function(data) {
        
        if (data.result && data.result.items) {
            providerList = data.result.items;
            filteredProviders = providerList;
            
            
            renderProviderList();
            $('#providerSearch').focus();
        } else {
            var errorMsg = data.result && data.result.msg ? data.result.msg : '등록된 제공사가 없습니다.';
            $('#providerDropdownList').html('<div class="provider-empty">' + errorMsg + '</div>');
        }
    }).fail(function(jqXHR, textStatus, errorThrown) {
        var errorMsg = '제공사 목록을 불러올 수 없습니다.';
        
        if (textStatus === 'timeout') {
            errorMsg = '요청 시간이 초과되었습니다.';
        } else if (jqXHR.status === 404) {
            errorMsg = 'API 엔드포인트를 찾을 수 없습니다. (/apis/providerList/ajax)';
        } else if (jqXHR.status === 500) {
            errorMsg = '서버 오류가 발생했습니다.';
        }
        
        $('#providerDropdownList').html('<div class="provider-empty">' + errorMsg + '</div>');
    });
}

// 제공사 목록 필터링
function filterProviders(searchText) {
    if (!searchText) {
        filteredProviders = providerList;
    } else {
        filteredProviders = providerList.filter(function(provider) {
            return provider.name.toLowerCase().includes(searchText.toLowerCase()) ||
                   (provider.url.website && provider.url.website.toLowerCase().includes(searchText.toLowerCase()));
        });
    }
    renderProviderList();
}

// 제공사 목록 렌더링
function renderProviderList() {
    var html = '';
    
    if (filteredProviders.length === 0) {
        html = '<div class="provider-empty">검색 결과가 없습니다.</div>';
    } else {
        filteredProviders.forEach(function(provider) {
            var statusClass = provider.status || 'active';
            var statusText = statusClass === 'active' ? '활성' : '비활성';
            var websiteUrl = provider.url && provider.url.website ? provider.url.website : '';
            
            html += '<div class="provider-item" data-provider-id="' + provider.id + '" role="option" tabindex="0" aria-label="' + provider.name + ' (' + statusText + ')' + (websiteUrl ? ', 웹사이트: ' + websiteUrl : '') + '">';
            html += '<div class="provider-name">' + provider.name;
            html += '<span class="provider-status ' + statusClass + '">' + statusText + '</span>';
            html += '</div>';
            if (websiteUrl) {
                html += '<div class="provider-url">' + websiteUrl + '</div>';
            }
            html += '</div>';
        });
    }
    
    $('#providerDropdownList').html(html);
    
    // 제공사 선택 이벤트 바인딩
    $('.provider-item').click(function() {
        var providerId = $(this).data('provider-id');
        selectProvider(providerId);
    });
    
    // 키보드 이벤트 바인딩
    $('.provider-item').keydown(function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            var providerId = $(this).data('provider-id');
            selectProvider(providerId);
        }
    });
}

// 제공사 선택
function selectProvider(providerId) {
    var provider = providerList.find(function(p) {
        return p.id === providerId;
    });
    
    if (provider) {
        // Provider input에 업체명 입력
        $('#provider').val(provider.name);
        
        // API Key가 있으면 입력
        if (provider.apiKey) {
            $('#key').val(provider.apiKey);
        }
        // Header 정보가 있으면 입력
        if (provider.header) {
            $('#header').val(provider.header);
        }

        // 웹사이트 URL이 있으면 URL 필드에 참고용으로 표시 (사용자가 원하는 경우)
        if (provider.url && provider.url.api && !$('#url').val()) {
            // API URL이 있고 현재 URL 필드가 비어있으면 참고용으로 표시
            var confirmed = confirm('이 제공사의 API 주소를 URL 필드에 입력하시겠습니까?\n\n' + provider.url.api);
            if (confirmed) {
                $('#url').val(provider.url.api);
            }
        }
        
        hideProviderDropdown();
        
        // 성공 메시지 (선택사항)
    }
}

// ===== 카테고리 선택 관련 함수들 =====

// 카테고리 선택 팝업 열기
function openCategoryPopup() {
    // 전역 selectedCategory, selectedCategoryPath가 정의되어 있지 않을 수 있으므로 안전하게 처리
    // window 객체에 저장된 값을 우선 사용하고, 없으면 기본값(null, [])
    var categoryName = $('#categoryName').val();
    var categoryId = $('#categoryId').val();
    
    var popupUrl = '/category/popup';
    var popupFeatures = 'width=800,height=600,scrollbars=yes,resizable=yes,status=yes';

    // 선택된 카테고리 데이터가 있으면 URL 파라미터로 전달
    // selectedCategory가 객체이고 id가 있으면 배열로 만들어 전달
    var selectedForPopup = [];

    // 팝업 오픈
    var popup = window.open(popupUrl, 'categoryPopup', popupFeatures);

    // categoryName과 categoryId에 값이 있는 경우에만 배열에 추가
    if (categoryName && categoryId) {
        selectedForPopup.push({
            id: categoryId,
            name: categoryName
        });

        // 팝업이 완전히 로드된 후 selectedForPopup 데이터를 전달
        popup.onload = function() {
            // postMessage를 사용하여 선택된 카테고리 데이터를 팝업에 전달
            popup.postMessage({
                type: 'fromCategory',
                result: selectedForPopup
            }, '*');
        };
    }
}

// 카테고리 선택 처리
function selectCategory(categoryData) {
    selectedCategory = categoryData;
    selectedCategoryPath = categoryData.path || [];
    
    // UI 업데이트
    $('#categoryId').val(categoryData.id);
    $('#categoryName').val(categoryData.name);
    
    // 선택 해제 버튼 표시
    $('#categoryClearBtn').show();
    
    // 카테고리 정보 표시
    updateCategoryInfo();
    
}

// 카테고리 선택 해제
function clearCategorySelection() {
    selectedCategory = null;
    selectedCategoryPath = [];
    
    // UI 초기화
    $('#categoryId').val('');
    $('#categoryName').val('');
    
    // 선택 해제 버튼 숨기기
    $('#categoryClearBtn').hide();
    
    // 카테고리 정보 초기화
    updateCategoryInfo();
    
}

// 카테고리 정보 업데이트
function updateCategoryInfo() {
    var categoryInfo = $('#categoryInfo');
    
    if (selectedCategory && selectedCategoryPath.length > 0) {
        var pathText = selectedCategoryPath.join(' > ');
        if (!categoryInfo.length) {
            // 카테고리 정보 요소가 없으면 생성
            var infoHtml = '<div class="category-info" id="categoryInfo">선택된 경로: ' + pathText + '</div>';
            $('#categoryName').after(infoHtml);
        } else {
            categoryInfo.text('선택된 경로: ' + pathText);
        }
    } else {
        categoryInfo.remove();
    }
}

// 카테고리 필드 초기화
function initCategoryFields() {
    // 기존 카테고리 정보가 있으면 UI 업데이트
    if($('#categoryId').val().trim() !== '') {
        $('#categoryClearBtn').show();
        updateCategoryInfo();
    } else {
        $('#categoryClearBtn').hide();
    }
}

// ==================== 데이터 수집 함수 ====================

// collectionField 데이터 수집 함수
function getCollectionFieldData() {
    var fieldData = [];
    $('#collectionField tbody tr').each(function(index) {
        var row = $(this);
        var field = {
            no: row.find('.no').text(),
            tag: row.find('[name="tag[]"]').val() || '',
            field: row.find('[name="field[]"]').val() || '',
            keyField: row.find('[name="keyField[]"]').is(':checked') ? '1' : '0',
            defaultValue: row.find('[name="value[]"]').val() || '',
            condition: row.find('[name="condition[]"]').val() || '',
            remark: row.find('[name="remark[]"]').val() || ''
        };
        // 빈 행은 제외 (모든 필드가 비어있는 경우)
        if (field.tag || field.field || field.defaultValue || field.condition || field.remark) {
            fieldData.push(field);
        }
    });
    return fieldData;
}

// AI 도움 기능
function requestAIHelp() {
    var url = $('#url').val().trim();
    var key = $('#key').val().trim();
    var aiModel = $('#aiModel').val().trim();

    // apiData가 정의되지 않았거나 비어있는 경우 빈 배열로 초기화
    if (typeof apiData === 'undefined' || !Array.isArray(apiData)) {
        apiData = [];
    }

    // apiData가 비어있는 경우 경고 메시지 표시
    if (apiData.length === 0) {
        if (!confirm('API 데이터가 없습니다. 먼저 "API데이터 확인" 버튼을 클릭하여 데이터를 가져온 후 AI 도움을 사용하시겠습니까?')) {
            return;
        }
    }
 
    if (!url) {
        alert('먼저 API URL을 입력해주세요.');
        $('#url').focus();
        return;
    }
    
    // 로딩 상태 표시
    var $aiButtons = $('#bnt_aiHelp, #btn_aiHelp');
    $aiButtons.prop('disabled', true).text('AI 분석 중...');

    makeAjaxRequest({
        url: '/apis/helpAi/ajax',
        method: 'POST',
        data: { 
            url: url,
            key: key,
            aiModel: aiModel,
            apiData: JSON.stringify(apiData)  // JSON 문자열로 직렬화
        },
        dataType: 'json'
    }).done(function(response) {
        
        if (response.result.success) {            
            // AI 분석 결과를 폼에 적용
            applyAIResults(response.result.data);
        } else {
            alert('AI 분석 실패: ' + (response.result.msg || '알 수 없는 오류'));
        }
    }).fail(function(xhr, status, error) {
        var errorMsg = getErrorMessage(xhr, status, error);
        try {
            var errorResponse = JSON.parse(xhr.responseText);
            if (errorResponse.msg) {
                errorMsg = errorResponse.msg;
            }
        } catch (e) {
            errorMsg += '\n' + (xhr.responseText || error);
        }
        alert(errorMsg);
    }).always(function() {
        // 버튼 상태 복원
        $aiButtons.prop('disabled', false).text('AI도움');
    });
}

// 한글 회사명 추출 함수 (괄호, 특수문자 제거)
function extractKoreanProviderName(providerText) {
    if (!providerText) return '';
    
    // 괄호와 그 안의 내용 제거 (예: "한국농수산식품유통공사(KAMIS)" -> "한국농수산식품유통공사")
    var cleaned = providerText.replace(/\([^)]*\)/g, '').trim();
    
    // 영문, 숫자, 특수문자 제거하고 한글만 추출
    var koreanOnly = cleaned.replace(/[^가-힣\s]/g, '').trim();
    
    // 공백 정리
    koreanOnly = koreanOnly.replace(/\s+/g, ' ').trim();
    
    return koreanOnly;
}

// providerList에서 일치하는 회사 찾기
function findMatchingProvider(koreanName) {
    if (!koreanName || !providerList || providerList.length === 0) {
        return null;
    }
    
    // 정확히 일치하는 경우
    var exactMatch = providerList.find(function(provider) {
        return provider.name === koreanName;
    });
    if (exactMatch) return exactMatch;
    
    // 부분 일치하는 경우 (포함 관계)
    var partialMatch = providerList.find(function(provider) {
        return provider.name.includes(koreanName) || koreanName.includes(provider.name);
    });
    if (partialMatch) return partialMatch;
    
    // 키워드 기반 매칭 (공백으로 분리하여 각 단어가 포함되는지 확인)
    var keywords = koreanName.split(/\s+/).filter(function(word) {
        return word.length > 1; // 1글자 단어는 제외
    });
    
    if (keywords.length > 0) {
        var keywordMatch = providerList.find(function(provider) {
            return keywords.some(function(keyword) {
                return provider.name.includes(keyword);
            });
        });
        if (keywordMatch) return keywordMatch;
    }
    
    return null;
}

// AI 분석 결과를 폼 필드에 적용
function applyAIResults(data) {   
    
    // 1. api_meta에서 기본 폼 필드 적용
    if (data.api_meta) {
        var apiMeta = data.api_meta;
        
        if (apiMeta.api_id) {
            $('#id').val(apiMeta.api_id);
        }
        
        if (apiMeta.api_title) {
            $('#title').val(apiMeta.api_title);
        }
        
        if (apiMeta.provider) {
            // 한글 회사명 추출 (괄호나 특수문자 제거)
            var koreanProviderName = extractKoreanProviderName(apiMeta.provider);
            
            // providerList에서 일치하는 회사 찾기
            var matchedProvider = findMatchingProvider(koreanProviderName);
            if (matchedProvider) {
                selectProvider(matchedProvider.id);
            } else {
                // 일치하는 회사가 없으면 직접 입력
                $('#provider').val(apiMeta.provider);
            }
        }
        
        if (apiMeta.response_type) {
            $('#returnType').val(apiMeta.response_type);
        }
        
        if (apiMeta.category) {
            $('#categoryName').val(apiMeta.category);
            if (apiMeta.category_id) {
                $('#categoryId').val(apiMeta.category_id);
                // 카테고리 선택 상태 업데이트
                selectedCategory = {
                    id: apiMeta.category_id,
                    name: apiMeta.category,
                    path: apiMeta.category.split(' > ')
                };
                selectedCategoryPath = selectedCategory.path;
                updateCategoryInfo();
            }
        }
        
        if (apiMeta.is_use) {
            $('#isUse').val(apiMeta.is_use);
        }
        
        if (apiMeta.is_chart_use) {
            $('#isChartUse').val(apiMeta.is_chart_use);
        }
        
        if (apiMeta.api_key) {
            $('#key').val(apiMeta.api_key);
        }
        
        if (apiMeta.date_char) {
            $('#dateChar').val(apiMeta.date_char);
        }
        
        if (apiMeta.list_tag && $('#listTag').val() == '') {
            // list_tag가 배열인 경우 문자열로 변환
            var listTagValue = Array.isArray(apiMeta.list_tag) 
                ? apiMeta.list_tag.join(' > ') 
                : apiMeta.list_tag;
            $('#listTag').val(listTagValue);
        }
        
        if (apiMeta.unit) {
            $('#unit').val(apiMeta.unit);
        }
        
        if (apiMeta.aliases) {
            $('#aliases').val(apiMeta.aliases);
        }
        
        if (apiMeta.description) {
            $('#description').val(apiMeta.description);
        }
        
        if (apiMeta.template_url) {
            $('#url').val(apiMeta.template_url);
        }
    }
    
    // 2. fields에서 필드 세팅 자동 채우기
    if (data.fields) {
        populateFieldsFromAI(data.fields);
    }
    
    // 3. usage_guide에서 추가 정보 적용
    if (data.usage_guide) {
        var usageGuide = data.usage_guide;
    }
    
    // 4. quality_assessment에서 품질 정보 확인
    if (data.quality_assessment) {
        var quality = data.quality_assessment;
    }
    
}

// AI 분석 결과로 필드 세팅 자동 채우기
function populateFieldsFromAI(fields) {
    // 기존 필드 행 제거 (템플릿 행 제외)
    $('.tr_row').remove();
    
    // fields가 객체인 경우 배열로 변환
    var fieldsArray = [];
    if (Array.isArray(fields)) {
        fieldsArray = fields;
    } else if (typeof fields === 'object' && fields !== null) {
        fieldsArray = Object.values(fields);
    }
    
    
    // AI 분석된 필드들을 테이블에 추가
    fieldsArray.forEach(function(field, index) {
        var rowTmp = row.clone();
        var rowIndex = index + 1;
        rowTmp.find('.no').text(rowIndex);
        
        // 동적으로 생성되는 행의 ID를 고유하게 만들기
        rowTmp.find('[id$="_template"]').each(function() {
            var oldId = $(this).attr('id');
            var newId = oldId.replace('_template', '_' + rowIndex);
            $(this).attr('id', newId);
        });
        
        // 체크박스에 aria-label 추가
        rowTmp.find('input[type="checkbox"]').attr('aria-label', '주요 필드 선택');
        
        // 필드 데이터 적용
        rowTmp.find('[name="tag[]"]').val(field.tag || '');
        rowTmp.find('[name="field[]"]').val(field.field || '');
        rowTmp.find('[name="keyField[]"]').val(field.keyField || '0');
        
        // keyField가 '1'이거나 1인 경우 체크박스 체크
        if (field.keyField === '1' || field.keyField === 1) {
            rowTmp.find('[name="keyField[]"]').prop('checked', true);
        }
        
        rowTmp.find('[name="value[]"]').val(field.value || '');
        rowTmp.find('[name="remark[]"]').val(field.remark || '');
        rowTmp.removeClass('tmp_row').addClass('tr_row');
        $('#collectionField tbody').append(rowTmp);
        
        // condition readonly 상태 업데이트
        updateConditionReadonlyState(rowTmp);
    });
    
}

// AI 분석 결과로 스케줄 설정 적용
function applyScheduleSettings(schedule) {
    if (!schedule.type) return;
    
    // 스케줄 타입에 따라 탭 전환
    switchTab(schedule.type);
    
    // 시간 설정
    if (schedule.startTime) {
        $('#' + schedule.type + 'StartTime').val(schedule.startTime);
    }
    if (schedule.endTime) {
        $('#' + schedule.type + 'EndTime').val(schedule.endTime);
    }
    if (schedule.interval) {
        $('#' + schedule.type + 'Interval').val(schedule.interval);
    }
    
    // 요일/일자/분기/월 설정
    if (schedule.type === 'weekly' && schedule.days) {
        schedule.days.forEach(function(day) {
            $('#weekly-content input[value="' + day + '"]').prop('checked', true);
        });
    } else if (schedule.type === 'monthly' && schedule.days) {
        schedule.days.forEach(function(day) {
            $('#monthly-content input[value="' + day + '"]').prop('checked', true);
        });
    } else if (schedule.type === 'quarterly' && schedule.quarters) {
        schedule.quarters.forEach(function(quarter) {
            $('#quarterly-content input[value="' + quarter + '"]').prop('checked', true);
        });
    } else if (schedule.type === 'yearly' && schedule.months) {
        schedule.months.forEach(function(month) {
            $('#yearly-content input[value="' + month + '"]').prop('checked', true);
        });
    }
    
    // 선택된 항목 표시 업데이트
    updateSelectedDisplay(schedule.type);
    updateScheduleSummary();
}

// AI 분석 요약 모달 표시
function showAIAnalysisSummary(data) {
    var summaryHtml = '<div style="max-width: 600px; text-align: left;">';
    summaryHtml += '<h3 style="color: #0369a1; margin-bottom: 15px;">🤖 AI 분석 완료</h3>';
    
    // 기본 정보 요약
    if (data.form_data) {
        summaryHtml += '<div style="margin-bottom: 15px;">';
        summaryHtml += '<h4 style="color: #374151; margin-bottom: 8px;">📋 기본 정보</h4>';
        summaryHtml += '<ul style="margin: 0; padding-left: 20px;">';
        if (data.form_data.title) summaryHtml += '<li><strong>제목:</strong> ' + data.form_data.title + '</li>';
        if (data.form_data.provider) summaryHtml += '<li><strong>제공사:</strong> ' + data.form_data.provider + '</li>';
        if (data.form_data.returnType) summaryHtml += '<li><strong>응답 형식:</strong> ' + data.form_data.returnType + '</li>';
        if (data.form_data.categoryName) summaryHtml += '<li><strong>카테고리:</strong> ' + data.form_data.categoryName + '</li>';
        summaryHtml += '</ul></div>';
    }
    
    // 필드 정보 요약
    if (data.fields && data.fields.length > 0) {
        summaryHtml += '<div style="margin-bottom: 15px;">';
        summaryHtml += '<h4 style="color: #374151; margin-bottom: 8px;">🔧 필드 설정 (' + data.fields.length + '개)</h4>';
        summaryHtml += '<ul style="margin: 0; padding-left: 20px;">';
        data.fields.slice(0, 5).forEach(function(field) {
            summaryHtml += '<li><strong>' + (field.tag || 'N/A') + '</strong> → ' + (field.field || 'N/A');
            if (field.keyField === '1') summaryHtml += ' <span style="color: #dc2626;">[키필드]</span>';
            summaryHtml += '</li>';
        });
        if (data.fields.length > 5) {
            summaryHtml += '<li>... 외 ' + (data.fields.length - 5) + '개 필드</li>';
        }
        summaryHtml += '</ul></div>';
    }
    
    // 스케줄 정보 요약
    if (data.schedule) {
        summaryHtml += '<div style="margin-bottom: 15px;">';
        summaryHtml += '<h4 style="color: #374151; margin-bottom: 8px;">⏰ 수집 스케줄</h4>';
        summaryHtml += '<ul style="margin: 0; padding-left: 20px;">';
        summaryHtml += '<li><strong>주기:</strong> ' + getScheduleTypeName(data.schedule.type) + '</li>';
        summaryHtml += '<li><strong>시간:</strong> ' + (data.schedule.startTime || '09:00') + ' ~ ' + (data.schedule.endTime || '18:00') + '</li>';
        summaryHtml += '<li><strong>간격:</strong> ' + (data.schedule.interval || 60) + '분</li>';
        summaryHtml += '</ul></div>';
    }
    
    // 경고 및 주의사항
    if (data.summary && data.summary.length > 0) {
        summaryHtml += '<div style="margin-bottom: 15px;">';
        summaryHtml += '<h4 style="color: #dc2626; margin-bottom: 8px;">⚠️ 주의사항</h4>';
        summaryHtml += '<ul style="margin: 0; padding-left: 20px;">';
        data.summary.forEach(function(warning) {
            summaryHtml += '<li style="color: #6b7280;">' + warning + '</li>';
        });
        summaryHtml += '</ul></div>';
    }
    
    summaryHtml += '<div style="text-align: center; margin-top: 20px;">';
    summaryHtml += '<button onclick="$(this).closest(\'.modal\').remove()" style="background: #0369a1; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer;">확인</button>';
    summaryHtml += '</div></div>';
    
    // 모달 생성 및 표시
    var modalHtml = '<div class="modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;">';
    modalHtml += '<div style="background: white; border-radius: 10px; padding: 25px; max-width: 90vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">';
    modalHtml += summaryHtml;
    modalHtml += '</div></div>';
    
    $('body').append(modalHtml);
}

// 스케줄 타입 한글명 반환
function getScheduleTypeName(type) {
    var typeNames = {
        'daily': '일간',
        'weekly': '주간', 
        'monthly': '월간',
        'quarterly': '분기',
        'yearly': '년간'
    };
    return typeNames[type] || type;
}

// popup(카테고리 선택 등)에서 넘어온 message 데이터 처리
window.addEventListener('message', function(event) {
    try {
        // 보안: 신뢰할 수 있는 origin만 허용 (필요시 아래 주석 해제 후 도메인 지정)
        // if (event.origin !== 'https://hkprice.kod.es' && event.origin !== 'http://localhost:8000') return;

        // 메시지 데이터 유효성 검사
        if (!event.data || typeof event.data !== 'object') {
            return;
        }

        // 메시지 타입이 'fromCategory'인 경우 카테고리 선택 결과 처리
        if (event.data.type === 'fromCategory') {
            // event.data.result는 [{id, name}, ...] 형태의 카테고리 배열
            var categories = event.data.result;

            if (Array.isArray(categories) && categories.length > 0) {
                // 여러 개 선택된 경우 첫 번째만 사용 (기존 호환성)
                var firstCategory = categories[0];

                // 카테고리 데이터 유효성 검사
                if (!firstCategory || !firstCategory.id || !firstCategory.name) {
                    return;
                }

                // #category, #categoryName 필드가 있으면 값 설정
                var $category = $('#category');
                var $categoryName = $('#categoryName');
                var $categoryId = $('#categoryId');

                if ($category.length) {
                    $category.val(firstCategory.id).trigger('change');
                }

                // #categoryId 필드가 있으면 값 설정
                if ($categoryId.length) {
                    $categoryId.val(firstCategory.id).trigger('change');
                }

                if ($categoryName.length) {
                    // 카테고리명만 표시 (경로가 필요하면 추가 구현)
                    $categoryName.val(firstCategory.name).trigger('change');
                }

                // 콜백 함수가 정의되어 있으면 호출 (확장성 고려)
                if (typeof window.onCategorySelected === 'function') {
                    window.onCategorySelected(firstCategory);
                }
            }
        }
    } catch (error) {
        // 오류 발생 시 무시
    }
});

// Migration 버튼 클릭 이벤트
$("#migrationBtn").click(function() {
    var apiId = '<?php echo !empty($_GET["id"]) ? $_GET["id"] : ""; ?>';
    
    if (!apiId) {
        alert('API ID가 없습니다.');
        return;
    }
    
    // 확인 대화상자
    if (!confirm('전체 데이터 마이그레이션을 시작하시겠습니까?\n\n이 작업은 시간이 오래 걸릴 수 있습니다.')) {
        return;
    }
    
    // Migration 시작
    startMigration(apiId);
});

// Migration 시작 함수
function startMigration(apiId) {
    // Migration 버튼 비활성화
    $("#migrationBtn").prop('disabled', true).text('Migration 진행중...');
    
    // AJAX로 Migration 시작
    makeAjaxRequest({
        url: '/apis/startMigration/ajax',
        method: 'POST',
        data: {
            id: apiId
        }
    }).done(function(response) {
        alert('Migration이 시작되었습니다.\n진행 상황은 목록 페이지에서 확인할 수 있습니다.');
        // 목록 페이지로 이동
        goList();
    }).fail(function(xhr, status, error) {
        alert('Migration 시작 중 오류가 발생했습니다: ' + error);
        // 버튼 상태 복원
        $("#migrationBtn").prop('disabled', false).text('Migration');
    });
}

</script>

<!-- API 데이터 레이어 팝업 -->
<div id="apiDataLayer">
    <div class="api-data-layer-header" id="apiDataLayerHeader">
        <span>
            <i class="fa fa-database"></i> API 데이터 (<span id="apiDataCount">0</span>개 항목)
        </span>
        <div class="api-data-layer-actions">
            <button type="button" id="btnFullscreenApiData" title="전체화면">
                <i class="fa fa-expand"></i> 전체화면
            </button>
            <button type="button" id="btnRefreshApiData" title="새로고침">
                <i class="fa fa-refresh"></i> 새로고침
            </button>
            <button type="button" id="btnMinimizeApiData" title="최소화">
                <i class="fa fa-minus"></i> 최소화
            </button>
        </div>
    </div>
    <div class="api-data-layer-content" id="apiDataLayerContent">
        <div id="apiDataTableContainer">
            <!-- 테이블이 동적으로 생성됩니다 -->
        </div>
    </div>
</div>

<!-- 레이어 닫혔을 때 보이는 헤더 -->
<div id="apiDataLayerMinimized">
    <div class="api-data-layer-minimized-header">
        <span>
            <i class="fa fa-database"></i> API 데이터 (<span id="apiDataCountMinimized">0</span>개 항목)
        </span>
        <button type="button" id="btnExpandApiData">
            <i class="fa fa-plus"></i> 열기
        </button>
    </div>
    <div class="api-data-layer-minimized-content" id="apiDataMinimizedContent">
        <!-- 선택된 row가 여기에 표시됩니다 -->
    </div>
</div>

<script type="text/javascript">
// API 데이터 레이어 관리
(function() {
    var isMinimized = false;
    
    // 정렬 기능
    var currentSort = { column: null, order: 'asc' };
    var originalData = [];
    var tableAllKeys = [];
    
    // API 데이터 테이블 생성 함수
    function createApiDataTable(data) {
        originalData = data; // 원본 데이터 저장
        
        if (!data || data.length === 0) {
            return '<div class="api-data-layer-empty"><i class="fa fa-database"></i><div>데이터가 없습니다.</div></div>';
        }
        
        // 배열이 아닌 경우 배열로 변환
        if (!Array.isArray(data)) {
            data = [data];
        }
        
        // 모든 키 수집 (첫 번째 항목의 키를 기준으로)
        var allKeys = [];
        var firstItem = data[0];
        
        if (typeof firstItem === 'object' && firstItem !== null) {
            allKeys = Object.keys(firstItem);
            tableAllKeys = allKeys; // 전역에 저장
            
            // 첫 번째 필드로 정렬
            if (allKeys.length > 0) {
                data = sortData(data, 1, 'asc', allKeys);
                currentSort = { column: 1, order: 'asc' };
            }
        } else {
            // 객체가 아닌 경우 단순 리스트로 표시
            var html = '<div class="api-data-table-wrapper"><table class="api-data-table"><thead><tr><th class="api-data-table-index-col">#</th><th>값</th></tr></thead><tbody>';
            data.forEach(function(item, index) {
                html += '<tr>';
                html += '<td class="api-data-table-index-col">' + (index + 1) + '</td>';
                html += '<td>' + escapeHtml(String(item)) + '</td>';
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            return html;
        }
        
        // 테이블 생성
        var html = '<div class="api-data-table-wrapper"><table class="api-data-table" data-keys="' + escapeHtml(JSON.stringify(allKeys)) + '"><thead><tr>';
        
        // 헤더 생성 (클릭 가능)
        html += '<th class="api-data-table-index-col" data-column="0">#</th>';
        allKeys.forEach(function(key, index) {
            html += '<th class="sortable" data-column="' + (index + 1) + '">' + escapeHtml(key) + ' <i class="fa fa-sort"></i></th>';
        });
        
        html += '</tr></thead><tbody>';
        
        // 데이터 행 생성
        data.forEach(function(item, index) {
            html += '<tr>';
            html += '<td class="api-data-table-index-col">' + (index + 1) + '</td>';
            
            allKeys.forEach(function(key) {
                var value = item[key];
                var displayValue = formatCellValue(value);
                html += '<td>' + displayValue + '</td>';
            });
            
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        return html;
    }
    
    // 정렬 함수 (수정)
    function sortData(data, column, order, allKeys) {
        if (!column || !data || data.length === 0) return data;
        
        var sorted = data.slice(); // 배열 복사
        var sortKey = allKeys[column - 1]; // column 0은 #, 1부터 시작
        
        sorted.sort(function(a, b) {
            var aVal = a[sortKey];
            var bVal = b[sortKey];
            
            // null/undefined 처리
            if (aVal == null) aVal = '';
            if (bVal == null) bVal = '';
            
            // 숫자와 문자열 혼합 처리
            var aNum = parseFloat(aVal);
            var bNum = parseFloat(bVal);
            
            if (!isNaN(aNum) && !isNaN(bNum)) {
                // 둘 다 숫자
                return order === 'asc' ? aNum - bNum : bNum - aNum;
            } else {
                // 문자열 비교
                var aStr = String(aVal).toLowerCase();
                var bStr = String(bVal).toLowerCase();
                if (order === 'asc') {
                    return aStr.localeCompare(bStr);
                } else {
                    return bStr.localeCompare(aStr);
                }
            }
        });
        
        return sorted;
    }
    
    // 셀 값 포맷팅
    function formatCellValue(value) {
        if (value === null || value === undefined) {
            return '<span class="type-null">null</span>';
        }
        
        if (typeof value === 'boolean') {
            return '<span class="type-boolean">' + value + '</span>';
        }
        
        if (typeof value === 'number') {
            return '<span class="type-number">' + value + '</span>';
        }
        
        if (Array.isArray(value)) {
            return '<span class="type-array">[배열: ' + value.length + '개]</span>';
        }
        
        if (typeof value === 'object') {
            return '<span class="type-object">{객체}</span>';
        }
        
        // 문자열은 이스케이프 처리
        return escapeHtml(String(value));
    }
    
    // HTML 이스케이프
    function escapeHtml(str) {
        var map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return str.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    // 데이터 업데이트 함수
    function updateApiDataLayer(data) {
        var count = data ? data.length : 0;
        $('#apiDataCount').text(count);
        $('#apiDataCountMinimized').text(count);
        
        var tableHtml = createApiDataTable(data);
        $('#apiDataTableContainer').html(tableHtml);
        
        // 테이블 행 클릭 이벤트 바인딩
        bindTableRowEvents();
        
        // 테이블 헤더 클릭 이벤트 바인딩
        bindTableHeaderEvents();
        
        // 데이터가 있으면 레이어 표시
        if (count > 0 && !$('#apiDataLayer').is(':visible')) {
            showApiDataLayer();
        }
    }
    
    // 선택된 행 데이터 저장 (전역으로 노출)
    window.selectedRowData = null;
    
    // 테이블 헤더 클릭 이벤트 바인딩
    function bindTableHeaderEvents() {
        $(document).off('click', '.api-data-table thead th.sortable');
        $(document).on('click', '.api-data-table thead th.sortable', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            var $th = $(this);
            var column = parseInt($th.attr('data-column'));
            
            // 정렬 순서 토글
            if (currentSort.column === column) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.order = 'asc';
            }
            
            // 데이터 정렬
            var sortedData = sortData(originalData, column, currentSort.order, tableAllKeys);
            var tableHtml = createApiDataTableWithData(sortedData);
            $('#apiDataTableContainer').html(tableHtml);
            
            // 이벤트 다시 바인딩
            bindTableRowEvents();
            bindTableHeaderEvents();
            
            // 정렬 아이콘 업데이트
            updateSortIcons();
        });
    }
    
    // 정렬 아이콘 업데이트
    function updateSortIcons() {
        $('.api-data-table thead th.sortable').each(function() {
            var $th = $(this);
            var column = parseInt($th.attr('data-column'));
            var $icon = $th.find('i');
            
            if (currentSort.column === column) {
                $icon.removeClass('fa-sort fa-sort-up fa-sort-down');
                $icon.addClass(currentSort.order === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
            } else {
                $icon.removeClass('fa-sort-up fa-sort-down');
                $icon.addClass('fa-sort');
            }
        });
    }
    
    // 정렬된 데이터로 테이블 생성
    function createApiDataTableWithData(sortedData) {
        var data = sortedData;
        
        // 테이블 생성
        var html = '<div class="api-data-table-wrapper"><table class="api-data-table" data-keys="' + escapeHtml(JSON.stringify(tableAllKeys)) + '"><thead><tr>';
        
        // 헤더 생성
        html += '<th class="api-data-table-index-col" data-column="0">#</th>';
        tableAllKeys.forEach(function(key, index) {
            var columnNum = index + 1;
            var sortIconClass = 'fa-sort';
            if (currentSort.column === columnNum) {
                sortIconClass = currentSort.order === 'asc' ? 'fa-sort-up' : 'fa-sort-down';
            }
            html += '<th class="sortable" data-column="' + columnNum + '">' + escapeHtml(key) + ' <i class="fa ' + sortIconClass + '"></i></th>';
        });
        
        html += '</tr></thead><tbody>';
        
        // 데이터 행 생성
        data.forEach(function(item, index) {
            html += '<tr>';
            html += '<td class="api-data-table-index-col">' + (index + 1) + '</td>';
            
            tableAllKeys.forEach(function(key) {
                var value = item[key];
                var displayValue = formatCellValue(value);
                html += '<td>' + displayValue + '</td>';
            });
            
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        return html;
    }
    
    // 테이블 행 클릭 이벤트 바인딩
    function bindTableRowEvents() {
        $(document).off('click', '.api-data-table tbody tr');
        $(document).on('click', '.api-data-table tbody tr', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            var $row = $(this);
            var isSelected = $row.hasClass('selected');
            
            // 모든 선택 해제
            $('.api-data-table tbody tr').removeClass('selected');
            window.selectedRowData = null;
            
            // 토글: 선택/해제 (단일 선택)
            if (!isSelected) {
                $row.addClass('selected');
                
                // 선택된 행의 데이터 추출
                var rowData = {};
                $row.find('td').each(function(index) {
                    if (index === 0) return; // 인덱스 컬럼 제외
                    var $th = $('.api-data-table thead th').eq(index);
                    var key = $th.text().trim();
                    if (key && key !== '#') {
                        rowData[key] = $(this).text().trim();
                    }
                });
                window.selectedRowData = rowData;
                console.log('선택된 row 데이터:', window.selectedRowData);
                
                // 선택된 데이터 미리보기 업데이트
                updateSelectedDataPreview();
            }
        });
    }
    
    // 선택된 데이터 미리보기 업데이트
    function updateSelectedDataPreview() {
        if (!window.selectedRowData || !tableAllKeys || tableAllKeys.length === 0) {
            $('#apiDataMinimizedContent').html('<div style="padding: 20px; text-align: center; color: #999;">선택된 데이터가 없습니다.</div>');
            return;
        }
        
        // 헤더와 선택된 row를 테이블로 표시
        var html = '<table class="minimized-table"><thead><tr>';
        
        tableAllKeys.forEach(function(key) {
            html += '<th>' + escapeHtml(key) + '</th>';
        });
        
        html += '</tr></thead><tbody><tr class="selected">';
        
        tableAllKeys.forEach(function(key) {
            var value = window.selectedRowData[key] || '';
            html += '<td>' + escapeHtml(String(value)) + '</td>';
        });
        
        html += '</tr></tbody></table>';
        
        $('#apiDataMinimizedContent').html(html);
    }
    
    // 레이어 표시
    function showApiDataLayer() {
        var $layer = $('#apiDataLayer');
        $layer.addClass('expanded');
        $layer.removeClass('minimized');
        isMinimized = false;
    }
    
    // 레이어 숨기기
    function hideApiDataLayer() {
        $('#apiDataLayer').removeClass('expanded');
    }
    
    // 최소화
    function minimizeApiDataLayer() {
        $('#apiDataLayer').addClass('minimized').removeClass('expanded');
        $('#apiDataLayerMinimized').show();
        isMinimized = true;
        
        // 선택된 데이터를 최소화 레이어에 표시
        updateSelectedDataPreview();
    }
    
    // 최대화
    function maximizeApiDataLayer() {
        var $layer = $('#apiDataLayer');
        $layer.addClass('expanded').removeClass('minimized');
        $('#apiDataLayerMinimized').hide();
        isMinimized = false;
    }
    
    // 전체화면 토글
    function toggleFullscreenApiDataLayer() {
        var $layer = $('#apiDataLayer');
        var isFullscreen = $layer.hasClass('fullscreen');
        
        if (isFullscreen) {
            $layer.removeClass('fullscreen');
            $('#btnFullscreenApiData').html('<i class="fa fa-expand"></i> 전체화면');
        } else {
            $layer.addClass('fullscreen');
            $('#btnFullscreenApiData').html('<i class="fa fa-compress"></i> 전체화면 해제');
        }
    }
    
    // 이벤트 리스너
    $('#btnMinimizeApiData').on('click', function(e) {
        e.stopPropagation();
        minimizeApiDataLayer();
    });
    
    $('#btnFullscreenApiData').on('click', function(e) {
        e.stopPropagation();
        toggleFullscreenApiDataLayer();
    });
    
    $('#btnExpandApiData').on('click', function(e) {
        e.stopPropagation();
        maximizeApiDataLayer();
    });
    
    $('#btnRefreshApiData').on('click', function(e) {
        e.stopPropagation();
        updateApiDataLayer(apiData);
    });
    
    $('#apiDataLayerHeader').on('click', function(e) {
        if (e.target.closest('.api-data-layer-actions')) return;
        if (isMinimized) {
            maximizeApiDataLayer();
        } else {
            minimizeApiDataLayer();
        }
    });
    
    // apiData 변경 시 업데이트
    var originalApiData = null;
    
    function watchApiDataChanges() {
        setInterval(function() {
            if (originalApiData !== apiData) {
                originalApiData = apiData;
                updateApiDataLayer(apiData);
            }
        }, 500);
    }
    
    // 감시 시작
    watchApiDataChanges();
    
    // 전역 함수로 노출
    window.updateApiDataLayer = updateApiDataLayer;
})();
</script>

</body>
</html>