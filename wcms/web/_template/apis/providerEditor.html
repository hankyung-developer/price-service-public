<!DOCTYPE html>
<html lang="ko">
<head>
    {# head}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .grid.full-width {
            grid-template-columns: 1fr;
        }
        
        .grid label {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .grid label .label-text {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .grid label span {
            font-weight: 600;
            color: #333;
        }
        
        .grid label span.red {
            color: #dc3545;
        }
        
        .grid input,
        .grid select,
        .grid textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .grid input:focus,
        .grid select:focus,
        .grid textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .grid textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .spacing {
            margin-bottom: 30px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 0 10px;
        }
        
        .btn-md {
            padding: 12px 24px;
            font-size: 16px;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .flex {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .justify-center {
            justify-content: center;
        }
        
        .flex-row {
            flex-direction: row;
        }
        
        .d-flex {
            display: flex;
        }
        
        .border {
            border: 1px solid #ddd;
        }
        
        .th-bg {
            background-color: #f8f9fa;
        }
        
        .text-center {
            text-align: center;
        }
        
        .red {
            color: #dc3545;
        }
        
        .gray {
            color: #6c757d;
        }
        
        .readonly-field {
            background-color: #f8f9fa !important;
            color: #6c757d !important;
            cursor: not-allowed;
        }
        
        .help-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
            display: block;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            display: inline-block;
            min-width: 60px;
        }
        
        .status-active {
            background-color: #e6f4ea;
            color: #1e7e34;
        }
        
        .status-inactive {
            background-color: #fce8e6;
            color: #d93025;
        }
        
        .status-pending {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .flex {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    {# left}
    {# header}

    <main class="container">
        <div role="document">
			<div role="heading" aria-level="1">
                {? empty(result.item.id)}API 제공 업체 등록{:}API 제공 업체 수정{/}
            </div>
			
            <section>
				<form id="providerForm" method="post" role="form" class="spacing">
					<input type="hidden" id="coId" name="coId" value="{_SESSION.coId}"/>
                    <input type="hidden" name="action" value="{? result.item.id}update{:}insert{/}">
					<input type="hidden" id="providerId" name="id" value="{? result.item.id}{result.item.id}{/}"/>
					
					<div class="grid">
						<label for="name">
							<span class="label-text">업체명 <span class="red">*</span></span>
							<input type="text" placeholder="업체명을 입력하세요" name="name" id="name" 
                                   value="{? result.item.name}{result.item.name}{/}" required>
						</label>
				    </div>
					<div class="grid">
						<label for="url[website]">
							웹사이트
							<input type="url" id="url[website]" name="url[website]" 
                                   value="{? result.item.url.website}{result.item.url.website}{/}" 
                                   placeholder="https://example.com">
						</label>
                        <label for="url[api]">
							API 주소
							<input type="url" id="url[api]" name="url[api]" 
                                   value="{? result.item.url.api}{result.item.url.api}{/}" 
                                   placeholder="https://example.com">
						</label>
                        <label for="url[menual]">
							메뉴얼
							<input type="url" id="url[menual]" name="url[menual]" 
                                   value="{? result.item.url.menual}{result.item.url.menual}{/}" 
                                   placeholder="https://example.com">
						</label>
					</div>
					
					<div class="grid">
						<label for="status">
							<span class="label-text">상태 <span class="red">*</span></span>
							<select name="status" id="status" required>
								<option value="active"{? result.item.status == 'active'} selected{/}>활성</option>
								<option value="inactive"{? result.item.status == 'inactive'} selected{/}>비활성</option>
								<option value="pending"{? result.item.status == 'pending'} selected{/}>대기</option>
							</select>
						</label>
						<label for="priority">
							<span class="label-text">우선순위</span>
							<select name="priority" id="priority">
								<option value="1"{? result.item.priority == '1'} selected{/}>높음</option>
								<option value="2"{? result.item.priority == '2'} selected{/}>보통</option>
								<option value="3"{? result.item.priority == '3'} selected{/}>낮음</option>
							</select>
						</label>
					</div>
					
					<div class="grid full-width">
						<label for="apiKey">
							API 키
							<input type="text" id="apiKey" name="apiKey" 
                                   value="{? result.item.apiKey}{result.item.apiKey}{/}" 
                                   placeholder="API 인증 키">
						</label>
					</div>

					<div class="grid full-width">
						<label for="notes">
							Header 정보
							<textarea id="header" name="header" placeholder="해더 정보를 입력해주세요" rows="3">{? result.item.header}{result.item.header}{/}</textarea>
						</label>
					</div>

					<div class="grid full-width">
						<label for="notes">
							메모
							<textarea id="notes" name="notes" placeholder="추가적인 메모나 특이사항을 입력하세요" rows="7">{? result.item.notes}{result.item.notes}{/}</textarea>
						</label>
					</div>
				</form>
				
				<div class="flex justify-center">
					<button type="button" class="btn btn-md btn-primary" id="saveBtn">
						{? empty(result.item.id)}업체 등록{:}업체 수정{/}
					</button>
					<button type="button" class="btn btn-md btn-secondary" id="cancelBtn">목록</button>
					{? !empty(result.item.id)}
					<button type="button" class="btn btn-md btn-danger" id="deleteBtn">삭제</button>
					{/}
				</div>
			</section>
		</div>
	</main>

<script type="text/javascript">
// 템플릿 변수 처리
var action = '{? empty(_GET["id"])}insert{:}modify{/}';

$(document).ready(function(){
    // 카테고리 변경 시 설명 자동 완성
    $('#category').change(function(){
        autoFillDescription();
    });
    
    // 저장 버튼
    $('#saveBtn').click(function(){
        if (validateForm()) {
            saveProvider();
        }
    });
    
    // 목록 버튼
    $('#cancelBtn').click(function(){
        goList();
    });
    
        // 삭제 버튼
        $('#deleteBtn').click(function(){
            if (confirm('정말로 이 업체를 삭제하시겠습니까?')) {
            deleteProvider();
        }
    });
    
    // 수정 모드인 경우 버튼 텍스트 변경
    if (action === 'modify') {
        $("#saveBtn").text('업체 수정');
    }
});

// 폼 유효성 검사
function validateForm() {
    if ($('#name').val().trim() == '') {
        alert('업체명을 입력해주세요.');
        $('#name').focus();
        return false;
    }
    
    if ($('#status').val() == '') {
        alert('상태를 선택해주세요.');
        $('#status').focus();
        return false;
    }

    
    return true;
}

// URL 유효성 검사
function isValidUrl(string) {
    try {
        new URL(string);
        return true;
    } catch (_) {
        return false;
    }
}

// 업체 정보 저장
function saveProvider() {
    let formData = $('#providerForm').serialize();
    let url = action === 'insert' ? '/apis/providerInsert/ajax' : '/apis/providerUpdate/ajax';
    
    $.ajax({
        url: url,
        method: 'POST',
        data: formData,
        dataType: 'json'
    }).done(function(data) {
        if (data.result.success) {
            alert('업체 정보가 저장되었습니다.');
            goList();
        } else {
            alert('저장 중 오류가 발생했습니다: ' + (data.result.msg || '알 수 없는 오류'));
        }
    }).fail(function(jqXHR, textStatus, errorThrown) {
        if(jqXHR.responseJSON) {
            alert('저장 중 오류가 발생했습니다: ' + jqXHR.responseJSON.result.msg);
        } else {
            alert('저장 중 오류가 발생했습니다: ' + textStatus);
        }
    });
}

// 업체 삭제
function deleteProvider() {
    let providerId = $('#providerId').val();
    
    $.ajax({
        url: '/apis/providerDelete/ajax',
        method: 'POST',
        data: {'providerId': providerId},
        dataType: 'json'
    }).done(function(data) {
        if (data.result.success) {
            alert('업체가 삭제되었습니다.');
            goList();
        } else {
            alert('삭제 중 오류가 발생했습니다: ' + (data.result.msg || '알 수 없는 오류'));
        }
    }).fail(function(jqXHR, textStatus, errorThrown) {
        if(jqXHR.responseJSON) {
            alert('삭제 중 오류가 발생했습니다: ' + jqXHR.responseJSON.result.msg);
        } else {
            alert('삭제 중 오류가 발생했습니다: ' + textStatus);
        }
    });
}

// 리스트로 이동
function goList() {
    location.href = '/apis/providerList';
}
</script>
</body>
</html>
