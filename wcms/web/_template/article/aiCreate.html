<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ê¸°ì‚¬ì‘ì„± - DataCMS</title>
    {# head}
    <style>
        /* AI ê¸°ì‚¬ ì‘ì„± ì‹œìŠ¤í…œ ìŠ¤íƒ€ì¼ */
        .ai-article-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ë‹¨ê³„ í‘œì‹œ */
        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            gap: 40px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .step-circle.active {
            background-color: #007bff;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .step-circle.completed {
            background-color: #28a745;
            color: white;
        }

        .step-circle.inactive {
            background-color: #e9ecef;
            color: #6c757d;
        }

        .step-circle:hover {
            transform: scale(1.05);
            transition: all 0.2s ease;
        }

        .step-label {
            font-size: 14px;
            font-weight: 500;
        }

        /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
        .content-area {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        /* ë‹¨ê³„ë³„ í™”ë©´ */
        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        /* ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .section {
            margin-bottom: 25px;
        }

        .section-title, .prompt-title, .template-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .required::after {
            content: " *";
            color: #dc3545;
        }

        /* ë²„íŠ¼ ê·¸ë£¹ */
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .option-button {
            padding: 10px 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-width: 120px;
            text-align: center;
        }

        .option-button:hover {
            border-color: #007bff;
        }

        .option-button.selected {
            background-color: #e3f2fd;
            border-color: #007bff;
            color: #007bff;
        }

        .option-button .icon {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: #ffc107;
            border: 2px solid #007bff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #007bff;
        }

        /* í’ˆëª© ì„ íƒ */
        .item-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .item-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 20px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .item-tag:hover {
            background: #bbdefb;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.2);
        }

        .item-tag .remove-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .item-tag .remove-btn:hover {
            background: #ffebee;
            transform: scale(1.1);
        }

        .add-item-btn {
            padding: 8px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        /* ì…ë ¥ í•„ë“œ */
        .input-field {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin-top: 5px;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 1000px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }

        /* í’ˆëª© í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .item-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .item-table thead {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%) !important;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .item-table th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #4338ca;
            color: #ffffff !important;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            white-space: nowrap;
            transition: background-color 0.2s;
            background-color: transparent !important;
        }

        .item-table th:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .item-table th.sortable::after {
            content: ' â‡…';
            opacity: 0.5;
            font-size: 12px;
        }

        .item-table th.sort-asc::after {
            content: ' â–²';
            opacity: 1;
        }

        .item-table th.sort-desc::after {
            content: ' â–¼';
            opacity: 1;
        }

        .item-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
        }

        .item-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .item-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .item-table tbody tr.selected {
            background-color: #bbdefb;
            font-weight: 500;
        }

        .item-table .price-up {
            color: #dc3545;
        }

        .item-table .price-down {
            color: #28a745;
        }

        .item-table .price-same {
            color: #6c757d;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 18px;
        }

        .modal-content p {
            margin-bottom: 15px;
            color: #666;
        }

        .close-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            font-size: 14px;
        }

        .close-btn:hover {
            background: #0056b3;
        }

        /* ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .fa-eye {
            cursor: pointer;
            color: #007bff;
            margin-left: 8px;
            transition: color 0.3s ease;
        }

        .fa-eye:hover {
            color: #0056b3;
        }

        /* í…œí”Œë¦¿ í”„ë¦¬ë·° ìŠ¤íƒ€ì¼ */
        .template-preview {
            margin: 15px 0;
        }

        .template-preview textarea {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        .textarea-field {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin-top: 5px;
            resize: vertical;
            min-height: 120px;
            line-height: 1.6;
        }

        /* ì´ë¯¸ì§€/ì°¨íŠ¸ ì„ íƒ */
        .media-options {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            max-width: 100%;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .media-option {
            flex: 0 0 auto;
            width: calc((100% - 30px) / 3);
            min-width: 280px;
            max-width: 100%;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        /* Step 2: ì´ë¯¸ì§€/ì°¨íŠ¸ ë¯¸ë¦¬ë³´ê¸° ì˜µì…˜ì—ë§Œ ë†’ì´ ì ìš© */
        #imageOptions .media-option,
        #chartOptions .media-option {
            height: 350px;
        }

        .media-option:hover {
            border-color: #007bff;
        }

        .media-option.selected {
            background-color: #e3f2fd;
            border-color: #007bff;
        }

        .media-option .radio {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid #ddd;
            border-radius: 50%;
        }

        .media-option.selected .radio {
            border-color: #007bff;
            background: #007bff;
        }

        /* ì¬ìƒì„± ë²„íŠ¼ */
        .regenerate-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .regenerate-btn:hover {
            background: #218838;
        }

        /* íƒœê·¸ */
        .tag-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .tag {
            padding: 6px 12px;
            background: #e9ecef;
            border-radius: 15px;
            font-size: 12px;
            color: #495057;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .nav-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-btn.prev {
            background: #6c757d;
            color: white;
        }

        .nav-btn.prev:hover {
            background: #5a6268;
        }

        .nav-btn.next {
            background: #007bff;
            color: white;
        }

        .nav-btn.next:hover {
            background: #0056b3;
        }

        .nav-btn.send {
            background: #28a745;
            color: white;
        }

        .nav-btn.send:hover {
            background: #218838;
        }

        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .loading-description {
            color: #6c757d;
            font-size: 14px;
        }

        /* ì„¤ëª… í…ìŠ¤íŠ¸ */
        .help-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .step-indicator {
                gap: 20px;
            }
            
            .step-circle {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .content-area {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .option-button {
                min-width: auto;
            }
        }
    </style>
    <script src="/lib/anychart/anychart-base.min.js"></script>
</head>
<body>
    {# left}
    {# header}
	</style>
    <main class="container">
        <div role="document">
			<div role="heading" aria-level="1">AI ê¸°ì‚¬ì‘ì„±</div>
			
			<!-- AI ê¸°ì‚¬ ì‘ì„± ì‹œìŠ¤í…œ -->
			<div class="ai-article-container">
				<!-- ë‹¨ê³„ í‘œì‹œ -->
				<div class="step-indicator">
					<div class="step" data-step="1">
						<div class="step-circle active" id="step1-circle">1</div>
						<div class="step-label">ê¸°ë³¸ì •ë³´</div>
					</div>
					<div class="step" data-step="2">
						<div class="step-circle inactive" id="step2-circle">2</div>
						<div class="step-label">í¸ì§‘</div>
					</div>
					<div class="step" data-step="3">
						<div class="step-circle inactive" id="step3-circle">3</div>
						<div class="step-label">ê²€í† Â·ì „ì†¡</div>
					</div>
				</div>

				<!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
				<div class="content-area">
					<!-- 1ë‹¨ê³„: ê¸°ë³¸ì •ë³´ -->
					<div class="step-content" id="step1-content">
						<form id="basicForm">
							<!-- ë°ì´í„° ì„ íƒ -->
                            <div class="section" id="section-category">
								<div class="section-title required">ë°ì´í„°</div>
								<div class="button-group">
									{@ result.category.categoryList}
									{? .depth==1}
                                    <div class="option-button" data-value="{.id}" data-role="category">
										{.name}
									</div>
									{/}
									{/}
								</div>
							</div>

							<!-- í”„ë¡¬í”„íŠ¸ ì„ íƒ -->
                            <div class="section" id="section-prompt">
								<div class="prompt-title required">í”„ë¡¬í”„íŠ¸</div>
								<div class="button-group">
									{@ result.prompt}
                                    <div class="option-button" data-value="{.idx}" data-role="prompt">
										{.title}
									</div>
									{/}
								</div>
							</div>

                            <!-- div class="section" id="section-template">
								<div class="template-title required">ê¸°ì‚¬ í…œí”Œë¦¿</div>
								<div class="button-group">
									{@ result.template}
                                    <div class="option-button" data-value="{.idx}" data-role="template">
										{.title} <i class="fa-solid fa-eye" onclick="showTemplateModal('{.idx}')"></i>
									</div>
									{/}
								</div>
							</div -->
                            <input type="hidden" id="templateIdx" name="templateIdx" value="3">

							<!-- í’ˆëª© ì„ íƒ -->
                            <div class="section" id="section-items">
								<div class="section-title">í’ˆëª©</div>
                                <div class="help-text" style="margin-bottom: 10px; color: #28a745; font-weight: 500;">
                                    â„¹ï¸ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ë©´ ìƒìœ„ ì „ì¼ ë³€ë™í­ì´ í° 10ê°œ í’ˆëª©ì´ ìë™ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤.
                                </div>
                                <button type="button" class="add-item-btn" id="addItemBtn">í’ˆëª© ì¶”ê°€</button>
                                <div class="item-container" id="itemContainer"></div>
                                <div class="help-text">* "í’ˆëª© ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì¶”ê°€ í’ˆëª©ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
							</div>
							<!-- ê¸°ì‚¬ ì‘ì„±ìš© í”„ë¡¬í”„íŠ¸ -->
							<!-- div class="section">
								<div class="section-title required">ê¸°ì‚¬ ì‘ì„± í”„ë¡¬í”„íŠ¸</div>
								<div class="prompt-area">
									<label for="articlePrompt" class="prompt-label">ì›í•˜ëŠ” ê¸°ì‚¬ ìŠ¤íƒ€ì¼ì´ë‚˜ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</label>
									<textarea 
										id="articlePrompt" 
										class="input-field prompt-textarea" 
										placeholder="ì˜ˆ: ìŒ€ ê°€ê²© ë™í–¥, ì‹œê¸ˆì¹˜ ìˆ˜ê¸‰, ì†Œë¹„ì ë°˜ì‘ ë“±"
										rows="4"
										style="margin-bottom: 0;"
									></textarea>
									<div class="help-text">* í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ ê¸°ì‚¬ ìŠ¤íƒ€ì¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.</div>
								</div>
							</div -->

							<!-- ì´ë¯¸ì§€ ìƒì„± -->
                            <div class="section" id="section-image-option">
								<div class="section-title required">ì´ë¯¸ì§€</div>
								<div class="media-options">
									<div class="media-option selected" data-value="generate">
										ìƒì„±
									</div>
									<div class="media-option" data-value="no-generate">
										ìƒì„±ì•ˆí•¨
									</div>
								</div>
							</div>

							<!-- ì°¨íŠ¸ ìƒì„± -->
                            <div class="section" id="section-chart-option">
								<div class="section-title required">ì°¨íŠ¸</div>
								<div class="media-options">
									<div class="media-option selected" data-value="generate">
										ìƒì„±
									</div>
									<div class="media-option" data-value="no-generate">
										ìƒì„±ì•ˆí•¨
									</div>
								</div>
							</div>
						</form>
					</div>

					<!-- 2ë‹¨ê³„: í¸ì§‘ -->
                    <div class="step-content" id="step2-content">
						<form id="editForm">
						<!-- ë°ì´í„° í™•ì¸ ë²„íŠ¼ -->
						<div class="section" style="background: #f0f8ff; padding: 15px; border-radius: 8px; border: 1px solid #b3d9ff; margin-bottom: 20px;">
							<div style="display: flex; align-items: center; gap: 10px;">
								<i class="fa-solid fa-database" style="color: #007bff; font-size: 20px;"></i>
								<div style="flex: 1;">
									<strong style="color: #007bff;">ì‚¬ìš©ëœ ë°ì´í„° í™•ì¸</strong>
									<p style="margin: 5px 0 0 0; font-size: 13px; color: #666;">AIê°€ ê¸°ì‚¬ ì‘ì„±ì— ì‚¬ìš©í•œ ì‹¤ì œ ì‹œì¥ ë°ì´í„°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
								</div>
								<button type="button" class="regenerate-btn" onclick="showDataModal()" style="background: #007bff;">
									<i class="fa-solid fa-table"></i> ë°ì´í„° ë³´ê¸°
								</button>
							</div>
						</div>
						
						<!-- ì œëª© -->
						<div class="section">
							<div class="section-title">ì œëª©</div>
                            <input type="text" class="input-field" id="articleTitle" value="" style="font-size: 18px; font-weight: 600;">
						</div>

						<!-- ë¶€ì œëª© -->
						<div class="section">
							<div class="section-title">ë¶€ì œëª©</div>
							<input type="text" class="input-field" id="articleSubtitle" value="" style="font-size: 17px; font-weight: 500;">
						</div>

						<!-- ë³¸ë¬¸ -->
						<div class="section">
							<div class="section-title">ë³¸ë¬¸</div>
							<div style="display: flex; gap: 10px; margin-bottom: 10px;">
								<button type="button" class="regenerate-btn" onclick="regenerateContent('body')">
									<span>ğŸ”„</span> ì¬ìƒì„±
								</button>
								<button type="button" class="regenerate-btn" onclick="toggleBodyEditMode()" style="background: #6c757d;" id="editModeBtn">
									<span>âœï¸</span> í¸ì§‘
								</button>
							</div>
							<!-- ë Œë”ë§ëœ ë³¸ë¬¸ (ê¸°ë³¸ í‘œì‹œ) -->
							<div id="articleBodyRendered" style="border: 1px solid #ddd; border-radius: 6px; padding: 15px; background: #fff; min-height: 200px; line-height: 1.8; font-size: 16px; display: block;"></div>
							<!-- í¸ì§‘ìš© í…ìŠ¤íŠ¸ì˜ì—­ (ìˆ¨ê¹€) -->
							<textarea class="textarea-field" id="articleBody" rows="12" style="display: none;">ì´ë²ˆ ì£¼ ì¥ ë³´ëŸ¬ ê°€ì…¨ë‹¤ê°€ ê¹œì§ ë†€ë¼ì‹  ë¶„ë“¤ ë§ìœ¼ì‹œì£ ? íŠ¹íˆ í‘¸ë¦‡í‘¸ë¦‡í•œ ì‹œê¸ˆì¹˜ë¥¼ ë³´ë©° 'ì–´ë¨¸, ê°€ê²©ì´ ì´ë ‡ê²Œ ì°© í•´ì¡Œë„¤!' í•˜ê³  ë°˜ê°€ì›Œí•˜ì‹  ë¶„ë“¤ë„ ê³„ì‹¤ ê±°ì˜ˆìš”. ë°˜ë©´, ìŒ€ì´ë‚˜ ë©”ë°€ ê°€ê²©ì„ ë³´ë©´ì„œëŠ” í•œìˆ¨ì„ ì‰¬ì…¨ì„ì§€ë„ ëª¨ë¥´ê² ìŠµë‹ˆë‹¤. ìš°ë¦¬ ì‹íƒì˜ ê¸°ë³¸ì´ ë˜ëŠ” ë†ì‚°ë¬¼ ê°€ê²©ì´ ìš”ì¦˜ ì°¸ ë³€ë™ì´ ì‹¬í•œë°ìš”, ê³¼ì—° ì–´ë–¤ í’ˆëª©ë“¤ì´ ì˜¤ë¥´ê³  ë‚´ë ¸ëŠ”ì§€ ìì„¸íˆ ì‚´í´ë³¼ê¹Œìš”?

ë¨¼ì €, ìš°ë¦¬ ë°¥ìƒì— ë¹ ì§ˆ ìˆ˜ ì—†ëŠ” ìŒ€ì…ë‹ˆë‹¤. 5ì›” 31ì¼ í˜„ì¬ ìŒ€ì˜ í‰ê· ê°€ê²©ì€ 1,470ì›ìœ¼ë¡œ í™•ì¸ë©ë‹ˆë‹¤. í•˜ë£¨ ì „ì¸ 5ì›” 30ì¼ ê°€ê²©ì¸ 1,452ì›ê³¼ ë¹„êµí•´ë³´ë©´ 18ì›(ì•½ 1.24%) ì˜¬ëê³ , 3ì¼ ì „ì¸ 5ì›” 28ì¼ì˜ 1,465ì›ë³´ë‹¤ëŠ” 5ì›(ì•½ 0.34%) ìƒìŠ¹í–ˆì–´ìš”. ì§€ë‚œì£¼ 5ì›” 24ì¼ ìŒ€ ê°€ê²©ì´ 1,450ì›ì´ì—ˆìœ¼ë‹ˆ ì¼ì£¼ì¼ ìƒˆ 20ì›(ì•½ 1.38%)ê°€ëŸ‰ ì˜¬ëìŒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•œ ë‹¬ ì „ì¸ 4ì›” 30ì¼ì˜ 1,369ì›ì— ë¹„í•´ì„œëŠ” ë¬´ë ¤ 101ì›(ì•½ 7.38%)ì´ë‚˜ ìƒìŠ¹í–ˆê³ , 3ê°œì›” ì „ì¸ 3ì›” 1ì¼ì˜ 1,359ì›ê³¼ ë¹„êµí•˜ë©´ 111ì›(ì•½ 8.17%)ì´ ì˜¬ë¼ ìŒ€ê°’ì˜ ê¾¸ì¤€í•œ ìƒìŠ¹ì„¸ë¥¼ ë³´ì—¬ì£¼ê³  ìˆìŠµë‹ˆë‹¤.</textarea>
						</div>

						<!-- ì´ë¯¸ì§€ -->
                        <div class="section">
							<div class="section-title">ì´ë¯¸ì§€</div>
							<button type="button" class="regenerate-btn" onclick="regenerateContent('image')">
								<span>ğŸ”„</span> ì¬ìƒì„±
							</button>
                            <div class="media-options" id="imageOptions"></div>
						</div>

						<!-- ì°¨íŠ¸ -->
                        <div class="section">
							<div class="section-title">ì°¨íŠ¸</div>
							<button type="button" class="regenerate-btn" onclick="regenerateContent('chart')">
								<span>ğŸ”„</span> ì¬ìƒì„±
							</button>
                            <div class="media-options" id="chartOptions"></div>
						</div>
						</form>
					</div>

					<!-- 3ë‹¨ê³„: ê²€í† Â·ì „ì†¡ -->
                    <div class="step-content" id="step3-content">
						<form id="reviewForm">
							<!-- ë¬¼ë¥˜ì½”ë“œ -->
							<div class="section">
								<div class="section-title">ë°ì´í„° ì¹´í…Œê³ ë¦¬</div>
								<input type="text" class="input-field" id="reviewCategory" value="" readonly>
							</div>

							<!-- ì œëª© -->
							<div class="section">
								<div class="section-title">ì œëª©</div>
								<input type="text" class="input-field" id="reviewTitle" value="" readonly>
							</div>

							<!-- ë¶€ì œëª© -->
							<div class="section">
								<div class="section-title">ë¶€ì œëª©</div>
								<input type="text" class="input-field" id="reviewSubtitle" value="" readonly>
							</div>

							<!-- ë³¸ë¬¸ -->
							<div class="section">
								<div class="section-title">ë³¸ë¬¸ ë¯¸ë¦¬ë³´ê¸°</div>
								<div style="border: 1px solid #ddd; border-radius: 6px; padding: 15px; background: #f8f9fa; min-height: 200px; line-height: 1.6;">
                                    <div id="reviewContent">ì´ˆì•ˆì´ ìƒì„±ë˜ë©´ ì´ ì˜ì—­ì— ë³¸ë¬¸+ì´ë¯¸ì§€+ì°¨íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
								</div>
							</div>

							<!-- íƒœê·¸ -->
							<div class="section">
								<div class="section-title">íƒœê·¸</div>
								<div class="tag-container" id="reviewTags">
									<div class="tag">íƒœê·¸ê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤</div>
								</div>
							</div>
						</form>
					</div>

					<!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
					<div class="navigation-buttons">
						<button type="button" class="nav-btn prev" id="prevBtn" onclick="previousStep()">ì´ì „</button>
						<button type="button" class="nav-btn next" id="nextBtn" onclick="nextStep()">ë‹¤ìŒ</button>
                        <button type="button" class="nav-btn send" id="sendBtn" onclick="sendArticle()" style="display: none;">ì „ì†¡</button>
					</div>
				</div>
			</div>

			<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
			<div class="loading-overlay" id="loadingOverlay">
				<div class="loading-content">
					<div class="loading-spinner"></div>
					<div class="loading-text" id="loadingText">AI ê¸°ì‚¬ ì‘ì„±ì¤‘...</div>
					<div class="loading-description" id="loadingDescription">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>
				</div>
			</div>
		</div>
	</main>

	<script>
		// ============================================
		// ì„¤ì • ë° ìƒìˆ˜
		// ============================================
		const DEBUG_MODE = false; // í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” falseë¡œ ì„¤ì •
		
		// Canvas ì„¤ì •
		const CANVAS_WIDTH = 625;
		const LOGO_AREA_HEIGHT = 40;
		const LOGO_HEIGHT = 20;
		const LOGO_PADDING = 15;
		const LOGO_OPACITY = 0.8;
		
		// ì°¨íŠ¸ ì„¤ì •
		const CHART_LOAD_DELAY = 500; // ms
		
		// ì „ì—­ ë³€ìˆ˜
		let currentStep = 1;
		const totalSteps = 3;
		
		// ============================================
		// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
		// ============================================
		function debug(...args) {
			if (DEBUG_MODE) {
				console.log(...args);
			}
		}
		
		function debugError(...args) {
			if (DEBUG_MODE) {
				console.error(...args);
			}
		}
		
		// ë‚ ì§œ ê³„ì‚° (nì¼ ì „)
		function getDateBefore(days) {
			const date = new Date();
			date.setDate(date.getDate() - days);
			return date.getFullYear() + '-' + 
				   String(date.getMonth() + 1).padStart(2, '0') + '-' + 
				   String(date.getDate()).padStart(2, '0');
		}
		
		// ê°€ê²© í¬ë§·íŒ…
		function formatPrice(price) {
			return price ? Number(price).toLocaleString() + 'ì›' : '-';
		}
		
		// ë³€ë™ë¥  ê³„ì‚°
		function calculateChange(currentPrice, prevPrice) {
			const current = parseFloat(currentPrice) || 0;
			const prev = parseFloat(prevPrice) || 0;
			if (prev === 0) return { change: 0, percent: 0, class: 'price-same', symbol: '' };
			
			const change = current - prev;
			const percent = ((change / prev) * 100).toFixed(2);
			
			if (change > 0) {
				return { change, percent, class: 'price-up', symbol: 'â–²' };
			} else if (change < 0) {
				return { change, percent, class: 'price-down', symbol: 'â–¼' };
			} else {
				return { change, percent, class: 'price-same', symbol: '' };
			}
		}
		
		// currentStep ê°’ì„ ì•ˆì „í•˜ê²Œ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
		function setCurrentStep(step) {
			const stepNumber = parseInt(step);
			if (isNaN(stepNumber) || stepNumber < 1 || stepNumber > totalSteps) {
				debugError('ìœ íš¨í•˜ì§€ ì•Šì€ ë‹¨ê³„ ê°’:', step, 'ê¸°ë³¸ê°’ 1ë¡œ ì„¤ì •');
				currentStep = 1;
			} else {
				currentStep = stepNumber;
			}
			debug('currentStep ì„¤ì •ë¨:', currentStep);
		}

		// ë‹¨ê³„ ì´ë™ í•¨ìˆ˜
		function showStep(step, addToHistory = true) {
			debug('showStep í•¨ìˆ˜ ì‹œì‘ - ì›ë³¸ ë§¤ê°œë³€ìˆ˜:', step, 'íƒ€ì…:', typeof step);
			
			// stepì´ ìˆ«ìì¸ì§€ í™•ì¸í•˜ê³  ì •ìˆ˜ë¡œ ë³€í™˜
			const stepNumber = parseInt(step);
			debug('parseInt ê²°ê³¼:', stepNumber, 'isNaN:', isNaN(stepNumber));
			
			// ìœ íš¨í•œ ë‹¨ê³„ì¸ì§€ í™•ì¸
			if (isNaN(stepNumber) || stepNumber < 1 || stepNumber > totalSteps) {
				debugError('ìœ íš¨í•˜ì§€ ì•Šì€ ë‹¨ê³„:', step, 'stepNumber:', stepNumber);
				return;
			}

			debug('showStep í˜¸ì¶œë¨ - ë‹¨ê³„:', stepNumber);

			// ëª¨ë“  ë‹¨ê³„ ë‚´ìš© ìˆ¨ê¸°ê¸°
			document.querySelectorAll('.step-content').forEach(content => {
				content.classList.remove('active');
			});

			// ëª¨ë“  ë‹¨ê³„ ì› ë¹„í™œì„±í™”
			document.querySelectorAll('.step-circle').forEach(circle => {
				circle.classList.remove('active', 'completed');
				circle.classList.add('inactive');
			});

			// í˜„ì¬ ë‹¨ê³„ ìš”ì†Œë“¤ ê°€ì ¸ì˜¤ê¸°
			const contentId = 'step' + stepNumber + '-content';
			const circleId = 'step' + stepNumber + '-circle';
			
			const currentContent = document.getElementById(contentId);
			const currentCircle = document.getElementById(circleId);

			// ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
			if (!currentContent || !currentCircle) {
				debugError('ë‹¨ê³„ ' + stepNumber + 'ì˜ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', contentId, circleId);
				return;
			}

			// í˜„ì¬ ë‹¨ê³„ í‘œì‹œ
			currentContent.classList.add('active');
			debug('í‘œì‹œë¨:', currentContent.id);
			currentCircle.classList.remove('inactive');
			currentCircle.classList.add('active');

			// ì´ì „ ë‹¨ê³„ë“¤ ì™„ë£Œ í‘œì‹œ (ì„ íƒì )
			for (let i = 1; i < stepNumber; i++) {
				const prevCircle = document.getElementById('step' + i + '-circle');
				if (prevCircle) {
					prevCircle.classList.remove('inactive');
					prevCircle.classList.add('completed');
				}
			}

			// í˜„ì¬ ë‹¨ê³„ ì—…ë°ì´íŠ¸
			setCurrentStep(stepNumber);

			// íˆìŠ¤í† ë¦¬ì— ì¶”ê°€ (ë’¤ë¡œê°€ê¸° ì œì–´ìš©)
			if (addToHistory) {
				history.pushState({ step: stepNumber }, '', '?step=' + stepNumber);
			}

			// ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
			updateNavigationButtons();
			
			// 2ë‹¨ê³„ë¡œ ì´ë™í•  ë•Œ AI ìƒì„± ì‹œì‘ (ì²˜ìŒ ë°©ë¬¸í•˜ëŠ” ê²½ìš°ì—ë§Œ)
			if (stepNumber === 2) {
				const step2Content = document.getElementById('step2-content');
				if (step2Content && !step2Content.classList.contains('visited')) {
					step2Content.classList.add('visited');
					startAIGeneration();
				} else {
					// ì´ë¯¸ ë°©ë¬¸í•œ ê²½ìš° ë Œë”ë§ ì—…ë°ì´íŠ¸
					updateBodyRendered();
				}
			}
			
			// 3ë‹¨ê³„ë¡œ ì´ë™í•  ë•Œ ë¦¬ë·° ì½˜í…ì¸  ì—…ë°ì´íŠ¸
			if (stepNumber === 3) {
				updateReviewContent();
			}
		}

		// ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
	async function nextStep() {
		debug('nextStep í˜¸ì¶œë¨ - í˜„ì¬ ë‹¨ê³„:', currentStep);
		// currentStepì´ ìœ íš¨í•œì§€ í™•ì¸
		if (typeof currentStep !== 'number' || isNaN(currentStep) || currentStep < 1) {
			debugError('currentStepì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ:', currentStep, '1ë¡œ ì¬ì„¤ì •');
			setCurrentStep(1);
		}
		
		// 1ë‹¨ê³„ì—ì„œ 2ë‹¨ê³„ë¡œ ì´ë™í•˜ê¸° ì „ì— í•„ìš”í•œ ê°’ë“¤ì„ stateì— ì €ì¥
		if (currentStep === 1) {
			const articlePromptElement = document.getElementById('articlePrompt');
			if (articlePromptElement) {
				state.articlePrompt = articlePromptElement.value.trim();
			}
		}
		
		// 2ë‹¨ê³„ì—ì„œ 3ë‹¨ê³„ë¡œ ì´ë™í•˜ê¸° ì „ì— ì°¨íŠ¸ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
		if (currentStep === 2) {
			await convertChartToImage();
		}
		
		if (currentStep < totalSteps) {
			showStep(currentStep + 1);
		}
	}

		// ì´ì „ ë‹¨ê³„ë¡œ ì´ë™
		function previousStep() {
			debug('previousStep í˜¸ì¶œë¨ - í˜„ì¬ ë‹¨ê³„:', currentStep);
			// currentStepì´ ìœ íš¨í•œì§€ í™•ì¸
			if (typeof currentStep !== 'number' || isNaN(currentStep) || currentStep < 1) {
				debugError('currentStepì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ:', currentStep, '1ë¡œ ì¬ì„¤ì •');
				setCurrentStep(1);
			}
			
			if (currentStep > 1) {
				showStep(currentStep - 1);
			}
		}

		// ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
		function updateNavigationButtons() {
			const prevBtn = document.getElementById('prevBtn');
			const nextBtn = document.getElementById('nextBtn');
			const sendBtn = document.getElementById('sendBtn');

			// ë²„íŠ¼ë“¤ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
			if (!prevBtn || !nextBtn || !sendBtn) {
				debugError('ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
				return;
			}

			// currentStepì´ ìœ íš¨í•œì§€ í™•ì¸
			if (typeof currentStep !== 'number' || isNaN(currentStep) || currentStep < 1) {
				debugError('updateNavigationButtonsì—ì„œ currentStepì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ:', currentStep);
				setCurrentStep(1);
			}

			// ì´ì „ ë²„íŠ¼ì€ 1ë‹¨ê³„ê°€ ì•„ë‹ ë•Œë§Œ í‘œì‹œ
			prevBtn.style.display = currentStep === 1 ? 'none' : 'block';
			
			// ë‹¤ìŒ ë²„íŠ¼ì€ ë§ˆì§€ë§‰ ë‹¨ê³„ê°€ ì•„ë‹ ë•Œë§Œ í‘œì‹œ
			nextBtn.style.display = currentStep === totalSteps ? 'none' : 'block';
			
			// ì „ì†¡ ë²„íŠ¼ì€ ë§ˆì§€ë§‰ ë‹¨ê³„ì—ì„œë§Œ í‘œì‹œ
			sendBtn.style.display = currentStep === totalSteps ? 'block' : 'none';
			
			debug('í˜„ì¬ ë‹¨ê³„:', currentStep);
		}

        // ì „ì—­ ìƒíƒœ ê´€ë¦¬
        const state = {
            categoryId: '',
            promptIdx: 0,
            templateIdx: 0,
            items: [], // {id, title}
            makeImage: 'generate',
            makeChart: 'generate',
            articlePrompt: '',
            draft: null,  // AI ì´ˆì•ˆ ë°ì´í„° ì €ì¥
            chartData: null,  // ì°¨íŠ¸ ë°ì´í„° ì €ì¥
            imagePrompt: '',  // ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ì €ì¥
            chosen: { chart: null, image: null }
        };

        // [API] ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ì™¸ë¶€ APIì—ì„œ ì•„ì´í…œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ë° ìƒìœ„ 5ê°œ ìë™ ì„ íƒ
        async function fetchApisByCategory(categoryId){
            try{
                debug('ì¹´í…Œê³ ë¦¬ ì„ íƒ:', categoryId);
                
                // 3ì¼ ì „ ë‚ ì§œ ê³„ì‚°
                const startDate = getDateBefore(7);
                
                // API URL êµ¬ì„±
                const url = 'https://price-api.hankyung.com/api/data?categoryId=' + encodeURIComponent(categoryId) + '&startDate=' + startDate + '&sortField=prevDayChange&sortOrder=desc';
                debug('API í˜¸ì¶œ:', url);
                
                showLoading('í’ˆëª© ë°ì´í„° ë¡œë”©ì¤‘...', 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
                
                const res = await fetch(url);
                const json = await res.json();
                hideLoading();
                
                debug('API ì‘ë‹µ:', json);
                
                // ë°ì´í„° ì¶”ì¶œ
                let rawList = [];
                if (json && json.data && Array.isArray(json.data.data)) {
                    rawList = json.data.data;
                } else if (Array.isArray(json && json.data)) {
                    rawList = json.data;
                } else if (Array.isArray(json)) {
                    rawList = json;
                }
                
                debug('ì¶”ì¶œëœ ë°ì´í„°:', rawList.length, 'ê°œ');
                
                // í’ˆëª© ë¦¬ìŠ¤íŠ¸ êµ¬ì„±
                const items = rawList.map(function(v){
                    return {
                        id: v.sid || v.id || '',
                        title: v.name || v.title || v.sid || '',
                        kind: (v.data && v.data[0] && v.data[0].kind) || '',
                        grade: (v.data && v.data[0] && v.data[0].grade) || '',
                        price: (v.data && v.data[0] && v.data[0].price) || '',
                        prevDayPrice: (v.data && v.data[0] && v.data[0].prevDayPrice) || ''
                    };
                }).filter(item => item.id && item.title);
                
                debug('ë³€í™˜ëœ í’ˆëª©:', items.length, 'ê°œ');
                
                if (items.length === 0) {
                    alert('í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ í’ˆëª© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ìƒìœ„ 5ê°œ í•­ëª©ì„ ìë™ìœ¼ë¡œ ì„ íƒ
                state.items = items.slice(0, 5).map(function(item){
                    return {
                        id: item.id,
                        title: item.title+'('+item.kind+')'
                    };
                });
                
                // ì „ì²´ í’ˆëª© ë¦¬ìŠ¤íŠ¸ ì €ì¥ (í’ˆëª© ì¶”ê°€ ë²„íŠ¼ìš©)
                window.availableItems = items;
                
                // ì„ íƒëœ í’ˆëª© í™”ë©´ì— í‘œì‹œ
                renderSelectedItems();
                
                debug('ìë™ ì„ íƒ ì™„ë£Œ: ' + state.items.length + 'ê°œ í’ˆëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                
            } catch(e) {
                hideLoading();
                debugError('fetchApisByCategory error', e);
                alert('í’ˆëª© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + e.message);
            }
        }

        // [Render] ì„ íƒëœ í’ˆëª©ë“¤ì„ #itemContainerì— ë Œë”ë§
        function renderSelectedItems(){
            const wrap = document.getElementById('itemContainer');
            wrap.innerHTML = '';
            
            if (state.items.length === 0) {
                wrap.innerHTML = '<div style="padding: 15px; text-align: center; color: #999; border: 2px dashed #ddd; border-radius: 8px;">' +
                                 'ì„ íƒëœ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.<br>' +
                                 '<small>ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ í’ˆëª©ì´ ì¶”ê°€ë©ë‹ˆë‹¤.</small>' +
                                 '</div>';
                return;
            }
            
            state.items.forEach((it, index) => {
                const tag = document.createElement('div');
                tag.className = 'item-tag';
                tag.dataset.id = it.id;
                tag.dataset.title = it.title;
                tag.title = it.title + ' (í´ë¦­í•˜ì—¬ ì œê±°)';
                
                // í’ˆëª©ëª…
                const nameSpan = document.createElement('span');
                nameSpan.textContent = it.title;
                nameSpan.style.flexGrow = '1';
                
                // ì œê±° ë²„íŠ¼
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.innerHTML = 'Ã—';
                removeBtn.onclick = function() {
                    removeItem(this);
                };
                
                tag.appendChild(nameSpan);
                tag.appendChild(removeBtn);
                wrap.appendChild(tag);
            });
        }

        // [State] ì•„ì´í…œ ì¶”ê°€ (í•„ìš”ì‹œ ì‚¬ìš©)
        function addItemToSelection(it){
            const exists = state.items.find(i=>i.id===it.id);
            if(!exists){
                state.items.push({id:it.id, title:it.title});
                renderSelectedItems();
            }
        }

        // ============================================
        // 1. ê¸°ì‚¬ ì´ˆì•ˆ ìƒì„±
        // ============================================
        async function generateArticleDraft(){
            showLoading('AI ê¸°ì‚¬ ì‘ì„±ì¤‘...', 'ì„ íƒí•œ ë°ì´í„°ë¡œ ì´ˆì•ˆì„ ìƒì„±í•©ë‹ˆë‹¤.');
            try{
                // ìš”ì²­ ë°ì´í„° êµ¬ì„±
                const form = new URLSearchParams();
                form.append('items', JSON.stringify(state.items));
                form.append('categoryId', state.categoryId);
                form.append('templateIdx', $("#templateIdx").val());
                form.append('promptIdx', String(state.promptIdx||0));
                form.append('articlePrompt', state.articlePrompt);
                form.append('makeImage', 'no-generate');  // ì´ë¯¸ì§€ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìƒì„±
                form.append('makeChart', 'no-generate');  // ì°¨íŠ¸ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìƒì„±

                const res = await fetch('/article/aiDraft', {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:String(form)});
                const json = await res.json();
                hideLoading();
                
                if(!json.success){
                    alert(json.msg||'ì´ˆì•ˆ ìƒì„± ì‹¤íŒ¨');
                    return false;
                }
                
                // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                state.draft = json.data;
                state.chartData = json.data.chart_data || null;  // ì°¨íŠ¸ ë°ì´í„°
                state.imagePrompt = json.data.image_prompt || '';  // ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸
                
                debug('ì´ˆì•ˆ ë°ì´í„° ì €ì¥ ì™„ë£Œ:', {
                    title: state.draft.title,
                    imagePrompt: state.imagePrompt,
                    chartDataCount: state.chartData ? state.chartData.data.length : 0
                });
                
                // ì œëª©, ë¶€ì œëª©, ë³¸ë¬¸ í‘œì‹œ
                document.getElementById('articleTitle').value = state.draft.title||'';
                document.getElementById('articleSubtitle').value = state.draft.subtitle||'';
                document.getElementById('articleBody').value = state.draft.content||'';
                
                // ë Œë”ë§ëœ ë³¸ë¬¸ ì—…ë°ì´íŠ¸
                updateBodyRendered();
                
                return true;
            }catch(e){
                hideLoading();
                console.error('ì´ˆì•ˆ ìƒì„± ì˜¤ë¥˜:', e);
                alert('ì´ˆì•ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + e.message);
                return false;
            }
        }

        // ============================================
        // 2. ì´ë¯¸ì§€ ìƒì„± (image_prompt ì‚¬ìš© - 3ê°œ ìƒì„±)
        // ============================================
        async function generateArticleImage(){
            if(!state.imagePrompt){
                debug('ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if(state.makeImage !== 'generate'){
                debug('ì´ë¯¸ì§€ ìƒì„± ê±´ë„ˆëœ€');
                return;
            }
            
            showLoading('AI ì´ë¯¸ì§€ ìƒì„±ì¤‘...', '3ê°€ì§€ ìŠ¤íƒ€ì¼ì˜ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (ì•½ 1-2ë¶„ ì†Œìš”)');
            
            try{
                const images = [];
                
                // ì¹´í…Œê³ ë¦¬ë³„ ê³µí†µ í”„ë¡¬í”„íŠ¸ ê²°ì •
                let commonPrompt = '';
                const selectedCategory = document.querySelector('#section-category .option-button.selected');
                const categoryName = selectedCategory ? selectedCategory.textContent.trim().toLowerCase() : '';
                
                // ì„ íƒëœ í’ˆëª© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                let itemsText = '';
                if (state.items && state.items.length > 0) {
                    // í’ˆëª©ëª…ì—ì„œ ê´„í˜¸ ì•ˆì˜ ì¢…ë¥˜ ì œê±°í•˜ê³  í’ˆëª©ëª…ë§Œ ì¶”ì¶œ
                    const itemNames = state.items.map(item => {
                        const name = item.title.replace(/\([^)]*\)/g, '').trim();
                        return name;
                    });
                    itemsText = itemNames.join(', ');
                }
                
                // ì¹´í…Œê³ ë¦¬ íŒë³„: ë†ìˆ˜ì‚°ë¬¼ vs ì›ìì¬
                const isAgricultural = categoryName.includes('ë†ì‚°ë¬¼') || categoryName.includes('ìˆ˜ì‚°ë¬¼') || 
                                      categoryName.includes('ì¶•ì‚°ë¬¼') || categoryName.includes('ì±„ì†Œ') || 
                                      categoryName.includes('ê³¼ì¼') || categoryName.includes('ê³¡ë¬¼');
                
                // í’ˆëª© í”„ë¡¬í”„íŠ¸ (ì„ íƒëœ í’ˆëª©ì´ ìˆì„ ë•Œë§Œ)
                const itemPrompt = itemsText ? itemsText + ', ' : '';
                
                // 3ê°€ì§€ ìŠ¤íƒ€ì¼ë¡œ ì´ë¯¸ì§€ ìƒì„±
                let styles = [];
                
                if (isAgricultural) {
                    // ë†ìˆ˜ì‚°ë¬¼: ì‹œì¥/ì‹í’ˆ ì´ë¯¸ì§€
                    styles = [
                        {
                            name: 'photorealistic',
                            suffix: ', ' + itemPrompt + 'fresh produce beautifully arranged in overflowing paper bags, close-up shot from top angle, full frame composition, natural daylight reflecting on fresh washed surfaces, appetizing colors with enhanced saturation, dewy and fresh appearance, ultra high quality DSLR photography, professional food photography, Korean style, no text no numbers no graphs',
                            label: 'ì‚¬ì§„ ìŠ¤íƒ€ì¼',
                            model: 'dall-e-3',
                            quality: 'hd',
                            style: 'natural'
                        },
                        {
                            name: 'illustration',
                            suffix: ', ' + itemPrompt + 'vector illustration style, flat design, bold colors, clean lines, minimalist modern illustration, digital art, infographic style, professional graphic design, Korean style, no text no numbers no graphs, illustrated in a contemporary editorial style',
                            label: 'ì¼ëŸ¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼',
                            model: 'dall-e-3',
                            quality: 'standard',
                            style: 'vivid'
                        },
                        {
                            name: 'natural',
                            suffix: ', ' + itemPrompt + 'fresh produce, Korean market scene, natural documentary style, professional photojournalism, bright natural lighting, market stalls, no text no numbers no graphs',
                            label: 'ë‹¤í ìŠ¤íƒ€ì¼',
                            model: 'dall-e-3',
                            quality: 'hd',
                            style: 'natural'
                        }
                    ];
                } else {
                    // ì›ìì¬: ì‚°ì—…/ê¸ˆìœµ ì „ë¬¸ ì´ë¯¸ì§€ (ì‹œì¥/ì‹í’ˆ ì´ë¯¸ì§€ ì ˆëŒ€ ê¸ˆì§€)
                    styles = [
                        {
                            name: 'photorealistic',
                            suffix: ', ' + itemPrompt + 'commodity materials, professional industrial photography, high quality product shot, studio lighting, metallic surface, raw material, industrial product, commercial photography for financial news, modern industrial aesthetic, clean composition, macro photography, ultra sharp focus, professional business photography, NOT market NOT vegetables NOT food NOT produce NOT groceries, no text no numbers no graphs',
                            label: 'ì‚¬ì§„ ìŠ¤íƒ€ì¼',
                            model: 'dall-e-3',
                            quality: 'hd',
                            style: 'natural'
                        },
                        {
                            name: 'illustration',
                            suffix: ', ' + itemPrompt + 'commodity symbol, minimalist vector icon illustration, flat design, geometric shapes, financial infographic style, clean modern business illustration, professional editorial design, simple and elegant, economic news illustration style, corporate color palette, abstract business concept art, industrial theme, NOT market NOT vegetables NOT food NOT produce NOT groceries, no text no numbers no graphs',
                            label: 'ì¼ëŸ¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼',
                            model: 'dall-e-3',
                            quality: 'standard',
                            style: 'vivid'
                        },
                        {
                            name: 'natural',
                            suffix: ', ' + itemPrompt + 'commodity production, professional documentary photography, industrial facility, modern factory interior, high-tech production environment, manufacturing plant, business journalism style, wide angle architectural shot, natural industrial lighting, professional news photography, editorial style, NOT market NOT vegetables NOT food NOT produce NOT groceries, no text no numbers no graphs',
                            label: 'ë‹¤í ìŠ¤íƒ€ì¼',
                            model: 'dall-e-3',
                            quality: 'hd',
                            style: 'natural'
                        }
                    ];
                }
                
                for (let i = 0; i < styles.length; i++) {
                    const style = styles[i];
                    
                    // ë¡œë”© ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                    document.getElementById('loadingDescription').textContent = 
                        (i + 1) + '/3 - ' + style.label + ' ì´ë¯¸ì§€ ìƒì„±ì¤‘...';
                    
                    const form = new URLSearchParams();
                    form.append('imagePrompt', state.imagePrompt + style.suffix);
                    form.append('imageModel', style.model);
                    form.append('imageSize', '1792x1024');  // 16:10 ë¹„ìœ¨ì— ê°€ê¹Œìš´ ê°€ë¡œë¡œ ê¸´ ì§ì‚¬ê°í˜•
                    form.append('imageQuality', style.quality || 'standard');
                    form.append('imageStyle', style.style || 'vivid');

                    const res = await fetch('/article/aiGenerateArticleImage', {
                        method:'POST', 
                        headers:{'Content-Type':'application/x-www-form-urlencoded'}, 
                        body:String(form)
                    });
                    
                    const json = await res.json();
                    
                    if(json.success && json.data.image_url){
                        images.push({
                            url: json.data.image_url,
                            path: json.data.image_path,
                            filename: json.data.image_filename,
                            style: style.name,
                            label: style.label,
                            quality: style.quality,
                            model: style.model
                        });
                        debug(style.label + ' ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ:', json.data.image_url);
                    } else {
                        debugError(style.label + ' ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:', json.msg || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                    }
                }
                
                hideLoading();
                
                if(images.length > 0){
                    renderImageOptions(images);
                    debug(images.length + 'ê°œì˜ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ');
                } else {
                    debugError('ìƒì„±ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    alert('ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
                
            }catch(e){
                hideLoading();
                debugError('ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜:', e);
            }
        }

        // ============================================
        // 3. ì°¨íŠ¸ ìƒì„± (chart_data ì‚¬ìš© - AIë¡œ HTML ìƒì„±)
        // ============================================
        async function generateArticleChart(){
            if(!state.chartData || !state.chartData.data){
                debug('ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if(state.makeChart !== 'generate'){
                debug('ì°¨íŠ¸ ìƒì„± ê±´ë„ˆëœ€');
                return;
            }
            
            debug('AI ì°¨íŠ¸ ìƒì„± ì‹œì‘:', state.chartData);
            
            showLoading('AI ì°¨íŠ¸ ìƒì„±ì¤‘...', '3ê°€ì§€ íƒ€ì…ì˜ ì°¨íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (ì•½ 1-2ë¶„ ì†Œìš”)');
            
            try {
                // ì—¬ëŸ¬ ì°¨íŠ¸ íƒ€ì…ìœ¼ë¡œ ìƒì„± (ë§‰ëŒ€, ì„ , ì›)
                const chartTypes = [
                    { type: 'column', title: 'í’ˆëª©ë³„ ê°€ê²© ë¹„êµ', label: 'ë§‰ëŒ€ ì°¨íŠ¸', multiSeries: false },
                    { type: 'line', title: 'í’ˆëª©ë³„ ì¼ìë³„ ê°€ê²© ë³€ë™', label: 'ë‹¤ì¤‘ ì„  ì°¨íŠ¸', multiSeries: true },
                    { type: 'pie', title: 'í’ˆëª©ë³„ ê°€ê²© ë¹„ì¤‘', label: 'ì› ì°¨íŠ¸', multiSeries: false }
                ];
                const charts = [];
                
                for (let i = 0; i < chartTypes.length; i++) {
                    const chartInfo = chartTypes[i];
                    
                    // ë¡œë”© ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                    document.getElementById('loadingDescription').textContent = 
                        (i + 1) + '/3 - ' + chartInfo.label + ' ìƒì„±ì¤‘...';
                    
                    const form = new URLSearchParams();
                    form.append('chartData', JSON.stringify(state.chartData));
                    form.append('chartType', chartInfo.type);
                    form.append('chartTitle', chartInfo.title);
                    form.append('maxItems', '5');
                    form.append('multiSeries', chartInfo.multiSeries ? 'true' : 'false');
                    
                    const res = await fetch('/article/aiGenerateChartCode', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: String(form)
                    });
                    
                    const json = await res.json();
                    
                    if (json.success && json.data.chart_url) {
                        charts.push({
                            url: json.data.chart_url,
                            type: chartInfo.type,
                            title: json.data.chart_title,
                            code: json.data.chart_code
                        });
                        debug(chartInfo.label + ' ìƒì„± ì™„ë£Œ:', json.data.chart_url);
                    } else {
                        debugError(chartInfo.label + ' ìƒì„± ì‹¤íŒ¨:', json.msg);
                    }
                }
                
                hideLoading();
                
                if (charts.length > 0) {
                    renderChartOptions(charts);
                    debug(charts.length + 'ê°œ ì°¨íŠ¸ ìƒì„± ì™„ë£Œ');
                } else {
                    debugError('ìƒì„±ëœ ì°¨íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
                
            } catch(e) {
                hideLoading();
                debugError('AI ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜:', e);
            }
        }

        // ============================================
        // AI ìƒì„± í†µí•© ì‹¤í–‰ (step1 â†’ step2 ì „í™˜ ì‹œ í˜¸ì¶œ)
        // ============================================
        async function startAIGeneration(){
            // 1. ê¸°ì‚¬ ì´ˆì•ˆ ìƒì„±
            const draftSuccess = await generateArticleDraft();
            if(!draftSuccess) return;
            
            // 2. ì´ë¯¸ì§€ ìƒì„± (ìˆœì°¨ ì‹¤í–‰)
            if(state.makeImage === 'generate'){
                await generateArticleImage();
            }
            
            // 3. ì°¨íŠ¸ ìƒì„± (ìˆœì°¨ ì‹¤í–‰)
            if(state.makeChart === 'generate'){
                await generateArticleChart();
            }
            
            // 4. ë¦¬ë·° ì½˜í…ì¸  ì—…ë°ì´íŠ¸
            updateReviewContent();
        }

        function renderChartOptions(charts){
            const box = document.getElementById('chartOptions');
            box.innerHTML='';
            charts.slice(0,3).forEach((ch,idx)=>{
                const opt = document.createElement('div');
                opt.className = 'media-option'+(idx===0?' selected':'');
                opt.dataset.value = 'chart'+(idx+1);
                
                // iframe ì»¨í…Œì´ë„ˆ (ë³¸ë¬¸ ë„ˆë¹„ì— ë§ê²Œ ì¡°ì •, ë†’ì´ë¥¼ ì¶©ë¶„íˆ í™•ë³´)
                const container = document.createElement('div');
                container.style.maxWidth = '100%';
                container.style.width = '100%';
                container.style.height = '300px';  // ì°¨íŠ¸ ë¯¸ë¦¬ë³´ê¸° ë†’ì´
                container.style.background = '#ffffff';
                container.style.borderRadius = '4px';
                container.style.overflow = 'hidden';
                container.style.margin = '0 auto';
                
                // iframeìœ¼ë¡œ ì°¨íŠ¸ í‘œì‹œ
                const iframe = document.createElement('iframe');
                iframe.src = ch.url;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.style.display = 'block';
                iframe.setAttribute('scrolling', 'no');
                iframe.title = ch.title || 'ì°¨íŠ¸';
                iframe.id = 'chartFrame' + (idx + 1);  // ê° ì°¨íŠ¸ì— ê³ ìœ  ID ë¶€ì—¬
                
                container.appendChild(iframe);
                opt.appendChild(container);
                
                // ì°¨íŠ¸ íƒ€ì… ë¼ë²¨ ì¶”ê°€
                const label = document.createElement('div');
                label.style.fontSize = '11px';
                label.style.color = '#666';
                label.style.marginTop = '4px';
                label.style.textAlign = 'center';
                label.textContent = getChartTypeLabel(ch.type);
                opt.appendChild(label);
                
                const radio = document.createElement('div'); 
                radio.className='radio'; 
                opt.appendChild(radio);
                
                opt.addEventListener('click', ()=>{ 
                    selectInGroup(box, opt); 
                    state.chosen.chart = ch; 
                    updateReviewContent(); 
                });
                
                box.appendChild(opt);
                
                if(idx===0) state.chosen.chart = ch;
            });
        }
        
        // ì°¨íŠ¸ íƒ€ì… ë¼ë²¨ ë³€í™˜
        function getChartTypeLabel(type) {
            const labels = {
                'line': 'ì„  ì°¨íŠ¸',
                'column': 'ë§‰ëŒ€ ì°¨íŠ¸',
                'bar': 'ê°€ë¡œ ë§‰ëŒ€',
                'area': 'ì˜ì—­ ì°¨íŠ¸',
                'pie': 'ì› ì°¨íŠ¸'
            };
            return labels[type] || type;
        }

        // [Chart] anychartë¡œ ë¼ì¸ì°¨íŠ¸ ë Œë” (ë ˆê±°ì‹œ - í•„ìš” ì‹œ ì‚¬ìš©)
        function drawChart(containerId, config){
            try{
                const data = (config && config.data)? config.data : [];
                const chart = anychart.line();
                const series = chart.line(data.map(d=>({x:d[0], value: Number(d[1])})));
                series.name(config.title||'');
                chart.title(config.title||'');
                chart.container(containerId);
                chart.draw();
            }catch(e){ console.error('Chart draw error', e); }
        }

        function renderImageOptions(images){
            const box = document.getElementById('imageOptions');
            box.innerHTML='';
            images.slice(0,3).forEach((img,idx)=>{
                const opt = document.createElement('div');
                opt.className = 'media-option'+(idx===0?' selected':'');
                opt.dataset.value = 'image'+(idx+1);
                
                // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ (ë³¸ë¬¸ ë„ˆë¹„ì— ë§ê²Œ ì¡°ì •)
                const inner = document.createElement('div');
                inner.style.maxWidth='100%'; 
                inner.style.width='100%'; 
                inner.style.height='300px';  // ì°¨íŠ¸ì™€ ë™ì¼í•œ ë†’ì´
                inner.style.background='#f8f9fa'; 
                inner.style.borderRadius='4px'; 
                inner.style.display='flex'; 
                inner.style.alignItems='center'; 
                inner.style.justifyContent='center';
                inner.style.overflow='hidden';
                inner.style.margin='0 auto';
                inner.innerHTML = '<img src="' + (img.url||'') + '" alt="img' + (idx+1) + '" style="max-width:100%; width:100%; height:auto; object-fit:contain;"/>';
                opt.appendChild(inner);
                
                // ìŠ¤íƒ€ì¼ ë¼ë²¨ ì¶”ê°€
                if(img.label) {
                    const label = document.createElement('div');
                    label.style.fontSize = '11px';
                    label.style.color = '#666';
                    label.style.marginTop = '4px';
                    label.style.textAlign = 'center';
                    label.textContent = img.label;
                    opt.appendChild(label);
                }
                
                const radio = document.createElement('div'); 
                radio.className='radio'; 
                opt.appendChild(radio);
                
                opt.addEventListener('click', ()=>{ 
                    selectInGroup(box, opt); 
                    state.chosen.image = img; 
                    updateReviewContent(); 
                });
                
                box.appendChild(opt);
                
                if(idx===0) state.chosen.image = img;
            });
        }

        // 3ë‹¨ê³„ ë¦¬ë·° ì½˜í…ì¸  ì—…ë°ì´íŠ¸ (ë³¸ë¬¸+ì´ë¯¸ì§€+ì°¨íŠ¸)
        function updateReviewContent(){
            // ì¹´í…Œê³ ë¦¬ ì—…ë°ì´íŠ¸
            const reviewCategory = document.getElementById('reviewCategory');
            if(reviewCategory) {
                // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì°¾ê¸°
                const selectedCategory = document.querySelector('#section-category .option-button.selected');
                reviewCategory.value = selectedCategory ? selectedCategory.textContent.trim() : state.categoryId;
            }
            
            // ì œëª© ì—…ë°ì´íŠ¸
            const reviewTitle = document.getElementById('reviewTitle');
            if(reviewTitle) {
                reviewTitle.value = document.getElementById('articleTitle')?.value || '';
            }
            
            // ë¶€ì œëª© ì—…ë°ì´íŠ¸
            const reviewSubtitle = document.getElementById('reviewSubtitle');
            if(reviewSubtitle) {
                reviewSubtitle.value = document.getElementById('articleSubtitle')?.value || '';
            }
            
            // íƒœê·¸ ì—…ë°ì´íŠ¸
            const reviewTags = document.getElementById('reviewTags');
            if(reviewTags && state.draft?.tags) {
                reviewTags.innerHTML = '';
                state.draft.tags.forEach(tag => {
                    const tagDiv = document.createElement('div');
                    tagDiv.className = 'tag';
                    tagDiv.textContent = tag;
                    reviewTags.appendChild(tagDiv);
                });
            }
            
            // ë³¸ë¬¸ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            const reviewContent = document.getElementById('reviewContent');
            if(!reviewContent) return;
            
            let html = '';
            const body = document.getElementById('articleBody')?.value || state.draft?.body || '';
            const paragraphs = body.split('\n\n');
            
            paragraphs.forEach((para, idx) => {
                if(para.trim()) {
                    html += '<p style="margin-bottom:15px;line-height:1.8;">' + para.trim() + '</p>';
                    
                    // ì²« ë²ˆì§¸ ë‹¨ë½ í›„ì— ì´ë¯¸ì§€ ì‚½ì… (ë³¸ë¬¸ ë„ˆë¹„ì— ë§ê²Œ)
                    if(idx === 0 && state.chosen.image && state.chosen.image.url) {
                        html += '<div style="text-align:center;margin:20px auto;max-width:100%;"><img src="' + state.chosen.image.url + '" alt="ê¸°ì‚¬ ì´ë¯¸ì§€" style="max-width:100%;width:100%;height:auto;border-radius:8px;"/></div>';
                    }
                    
                    // ì„¸ ë²ˆì§¸ ë‹¨ë½ í›„ì— ì°¨íŠ¸ ì‚½ì… (ë³¸ë¬¸ ë„ˆë¹„ì— ë§ê²Œ, ë†’ì´ë¥¼ ì¶©ë¶„íˆ í™•ë³´)
                    if(idx === 2 && state.chosen.chart && state.chosen.chart.url) {
                        html += '<div style="margin:20px auto;padding:15px;background:#f8f9fa;border-radius:8px;max-width:100%;">';
                        html += '<iframe id="reviewChartFrame" src="' + state.chosen.chart.url + '" ';
                        html += 'style="max-width:100%;width:100%;height:600px;border:none;border-radius:4px;background:#ffffff;display:block;margin:0 auto;" ';
                        html += 'scrolling="no" title="' + (state.chosen.chart.title || 'ì°¨íŠ¸') + '"></iframe>';
                        html += '</div>';
                    }
                }
            });
            
            reviewContent.innerHTML = html;
        }

        // [UI] ë™ì¼ ê·¸ë£¹ ë‚´ ë‹¨ì¼ ì„ íƒ
        function selectInGroup(container, selected){
            container.querySelectorAll('.media-option').forEach(el=>el.classList.remove('selected'));
            selected.classList.add('selected');
        }

		// ë¡œë”© í‘œì‹œ
		function showLoading(title, description) {
			document.getElementById('loadingText').textContent = title;
			document.getElementById('loadingDescription').textContent = description;
			document.getElementById('loadingOverlay').style.display = 'flex';
		}

		// ë¡œë”© ìˆ¨ê¸°ê¸°
		function hideLoading() {
			document.getElementById('loadingOverlay').style.display = 'none';
		}

        // ============================================
        // ë³¸ë¬¸ í¸ì§‘/ë Œë”ë§ í† ê¸€
        // ============================================
        function toggleBodyEditMode() {
            const textarea = document.getElementById('articleBody');
            const rendered = document.getElementById('articleBodyRendered');
            const btn = document.getElementById('editModeBtn');
            
            if (textarea.style.display === 'none') {
                // í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜
                textarea.style.display = 'block';
                rendered.style.display = 'none';
                btn.innerHTML = '<span>ğŸ‘ï¸</span> ë¯¸ë¦¬ë³´ê¸°';
                btn.style.background = '#007bff';
            } else {
                // ë Œë”ë§ ëª¨ë“œë¡œ ì „í™˜
                textarea.style.display = 'none';
                rendered.style.display = 'block';
                btn.innerHTML = '<span>âœï¸</span> í¸ì§‘';
                btn.style.background = '#6c757d';
                
                // ë Œë”ë§ ì—…ë°ì´íŠ¸
                updateBodyRendered();
            }
        }
        
        // ë³¸ë¬¸ ë Œë”ë§ ì—…ë°ì´íŠ¸
        function updateBodyRendered() {
            const textarea = document.getElementById('articleBody');
            const rendered = document.getElementById('articleBodyRendered');
            
            if (!textarea || !rendered) return;
            
            const content = textarea.value || '';
            const paragraphs = content.split('\n\n');
            
            let html = '';
            paragraphs.forEach((para) => {
                if (para.trim()) {
                    html += '<p style="margin-bottom: 15px; line-height: 1.8; font-size: 16px;">' + para.trim() + '</p>';
                }
            });
            
            rendered.innerHTML = html || '<p style="color: #999; font-size: 16px;">ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // ============================================
        // ì¬ìƒì„± í•¨ìˆ˜ë“¤
        // ============================================
        async function regenerateContent(type){
            if(type === 'chart') {
                // ì°¨íŠ¸ ì¬ìƒì„± (ê¸°ì¡´ chart_data ì‚¬ìš©)
                await generateArticleChart();
            } else if(type === 'image') {
                // ì´ë¯¸ì§€ ì¬ìƒì„±
                await generateArticleImage();
            } else if(type === 'body') {
                // ë³¸ë¬¸ ì¬ìƒì„± - ì „ì²´ ì´ˆì•ˆì„ ë‹¤ì‹œ ìƒì„±
                await generateArticleDraft();
            }
            
            // ë¦¬ë·° ì½˜í…ì¸  ì—…ë°ì´íŠ¸
            updateReviewContent();
        }

        // í’ˆëª© ì œê±°
        // [Action] ì„ íƒ íƒœê·¸ ì‚­ì œ ë° state ë°˜ì˜
        function removeItem(button) {
            const parent = button.parentElement;
            const id = parent?.dataset?.id;
            if (id) {
                state.items = state.items.filter(it=>it.id!==id);
            }
            renderSelectedItems();
        }

        // ë°ì´í„° í™•ì¸ ëª¨ë‹¬ í‘œì‹œ (2ë‹¨ê³„)
        function showDataModal() {
            if (!state.chartData || !state.chartData.data || state.chartData.data.length === 0) {
                alert('ì‚¬ìš© ê°€ëŠ¥í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\nì´ˆì•ˆ ìƒì„±ì´ ì™„ë£Œëœ í›„ ë°ì´í„°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'dataModal';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.maxWidth = '1200px';
            
            // ì œëª©
            const titleContainer = document.createElement('div');
            titleContainer.style.display = 'flex';
            titleContainer.style.justifyContent = 'space-between';
            titleContainer.style.alignItems = 'center';
            titleContainer.style.marginBottom = '20px';
            titleContainer.style.paddingBottom = '15px';
            titleContainer.style.borderBottom = '2px solid #007bff';
            
            const title = document.createElement('h2');
            title.innerHTML = '<i class="fa-solid fa-database"></i> AI ê¸°ì‚¬ ì‘ì„±ì— ì‚¬ìš©ëœ ë°ì´í„°';
            title.style.margin = '0';
            title.style.color = '#007bff';
            
            const dataInfo = document.createElement('div');
            dataInfo.style.fontSize = '14px';
            dataInfo.style.color = '#666';
            dataInfo.innerHTML = '<strong>ì´ ' + state.chartData.data.length + 'ê°œ í’ˆëª©</strong> | ê¸°ê°„: ' + 
                                (state.chartData.data[0]?.data?.[0]?.date || 'ìµœê·¼ 7ì¼');
            
            titleContainer.appendChild(title);
            titleContainer.appendChild(dataInfo);
            
            // ì•ˆë‚´ ë¬¸êµ¬
            const infoBox = document.createElement('div');
            infoBox.style.background = '#fff3cd';
            infoBox.style.padding = '12px 15px';
            infoBox.style.borderRadius = '6px';
            infoBox.style.border = '1px solid #ffc107';
            infoBox.style.marginBottom = '15px';
            infoBox.innerHTML = '<i class="fa-solid fa-info-circle" style="color: #ffc107;"></i> ' +
                               '<strong>ì´ ë°ì´í„°ê°€ AI ê¸°ì‚¬ ì‘ì„±ì— ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.</strong> ' +
                               'AIëŠ” ì´ ë°ì´í„°ì˜ ìˆ˜ì¹˜ë§Œ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.';
            
            // í’ˆëª©ë³„ íƒ­ ìƒì„±
            const tabContainer = document.createElement('div');
            tabContainer.style.display = 'flex';
            tabContainer.style.gap = '5px';
            tabContainer.style.marginBottom = '15px';
            tabContainer.style.flexWrap = 'wrap';
            
            const tableContainer = document.createElement('div');
            tableContainer.style.maxHeight = '500px';
            tableContainer.style.overflowY = 'auto';
            tableContainer.style.overflowX = 'auto';
            tableContainer.style.border = '1px solid #ddd';
            tableContainer.style.borderRadius = '6px';
            tableContainer.style.marginBottom = '15px';
            
            // ê° í’ˆëª©ë³„ íƒ­ê³¼ í…Œì´ë¸” ìƒì„±
            state.chartData.data.forEach((item, index) => {
                // íƒ­ ë²„íŠ¼
                const tabBtn = document.createElement('button');
                tabBtn.type = 'button';
                tabBtn.className = 'option-button';
                tabBtn.textContent = item.name + (item.kind ? ' (' + item.kind + ')' : '');
                tabBtn.style.minWidth = 'auto';
                tabBtn.style.padding = '8px 15px';
                tabBtn.style.fontSize = '13px';
                tabBtn.style.color = '#333';
                tabBtn.style.background = '#fff';
                
                if (index === 0) {
                    tabBtn.classList.add('selected');
                }
                
                tabBtn.addEventListener('click', function() {
                    // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
                    tabContainer.querySelectorAll('.option-button').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    
                    // í•´ë‹¹ í’ˆëª© ë°ì´í„° í‘œì‹œ
                    renderItemData(item);
                });
                
                tabContainer.appendChild(tabBtn);
            });
            
            // ë°ì´í„° í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜
            const renderItemData = (item) => {
                tableContainer.innerHTML = '';
                
                if (!item.data || item.data.length === 0) {
                    tableContainer.innerHTML = '<div style="padding: 30px; text-align: center; color: #999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                // í…Œì´ë¸” ìƒì„±
                const table = document.createElement('table');
                table.className = 'item-table';
                table.style.fontSize = '12px';
                table.style.minWidth = '1800px';
                table.style.width = '100%';
                
                // í—¤ë”
                const thead = document.createElement('thead');
                thead.innerHTML = '<tr>' +
                    '<th style="min-width: 90px; text-align: center;">ë‚ ì§œ</th>' +
                    '<th style="min-width: 120px; text-align: center;">ì¢…ë¥˜</th>' +
                    '<th style="min-width: 80px; text-align: center;">ë“±ê¸‰</th>' +
                    '<th style="min-width: 100px; text-align: right; background: #e3f2fd;">í˜„ì¬ê°€ê²©</th>' +
                    '<th style="min-width: 90px; text-align: right;">ì „ì¼</th>' +
                    '<th style="min-width: 80px; text-align: right;">ë³€ë™ë¥ </th>' +
                    '<th style="min-width: 90px; text-align: right;">1ì£¼ì „</th>' +
                    '<th style="min-width: 80px; text-align: right;">ë³€ë™ë¥ </th>' +
                    '<th style="min-width: 90px; text-align: right;">1ë‹¬ì „</th>' +
                    '<th style="min-width: 80px; text-align: right;">ë³€ë™ë¥ </th>' +
                    '<th style="min-width: 90px; text-align: right;">3ë‹¬ì „</th>' +
                    '<th style="min-width: 80px; text-align: right;">ë³€ë™ë¥ </th>' +
                    '<th style="min-width: 90px; text-align: right;">6ë‹¬ì „</th>' +
                    '<th style="min-width: 80px; text-align: right;">ë³€ë™ë¥ </th>' +
                    '<th style="min-width: 90px; text-align: right;">1ë…„ì „</th>' +
                    '<th style="min-width: 80px; text-align: right;">ë³€ë™ë¥ </th>' +
                    '</tr>';
                table.appendChild(thead);
                
                // ë°”ë””
                const tbody = document.createElement('tbody');
                item.data.forEach(row => {
                    const tr = document.createElement('tr');
                    
                    const price = parseFloat(row.price) || 0;
                    
                    // ê° ê¸°ê°„ë³„ ë³€ë™ë¥  ê³„ì‚° í•¨ìˆ˜
                    const calcChange = (basePrice) => {
                        const base = parseFloat(basePrice) || 0;
                        if (base === 0 || price === 0) return { percent: '-', class: 'price-same', symbol: '' };
                        
                        const changePercent = ((price - base) / base * 100).toFixed(2);
                        if (changePercent > 0) {
                            return { percent: changePercent, class: 'price-up', symbol: 'â–²' };
                        } else if (changePercent < 0) {
                            return { percent: Math.abs(changePercent), class: 'price-down', symbol: 'â–¼' };
                        }
                        return { percent: '0.00', class: 'price-same', symbol: '' };
                    };
                    
                    // ê° ê¸°ê°„ë³„ ë³€ë™ ê³„ì‚°
                    const prevDay = calcChange(row.prevDayPrice);
                    const oneWeek = calcChange(row.oneWeekAgoPrice);
                    const oneMonth = calcChange(row.oneMonthAgoPrice);
                    const threeMonths = calcChange(row.threeMonthsAgoPrice);
                    const sixMonths = calcChange(row.sixMonthsAgoPrice);
                    const oneYear = calcChange(row.oneYearAgoPrice);
                    
                    tr.innerHTML = '<td style="text-align: center;">' + (row.date || '-') + '</td>' +
                        '<td style="text-align: center;">' + (row.kind || '-') + '</td>' +
                        '<td style="text-align: center;">' + (row.grade || '-') + '</td>' +
                        '<td style="text-align: right; background: #f0f8ff;"><strong>' + price.toLocaleString() + '</strong></td>' +
                        '<td style="text-align: right;">' + (parseFloat(row.prevDayPrice) || 0).toLocaleString() + '</td>' +
                        '<td style="text-align: right;" class="' + prevDay.class + '"><strong>' + prevDay.symbol + ' ' + prevDay.percent + (prevDay.percent !== '-' ? '%' : '') + '</strong></td>' +
                        '<td style="text-align: right;">' + (parseFloat(row.oneWeekAgoPrice) || 0).toLocaleString() + '</td>' +
                        '<td style="text-align: right;" class="' + oneWeek.class + '"><strong>' + oneWeek.symbol + ' ' + oneWeek.percent + (oneWeek.percent !== '-' ? '%' : '') + '</strong></td>' +
                        '<td style="text-align: right;">' + (parseFloat(row.oneMonthAgoPrice) || 0).toLocaleString() + '</td>' +
                        '<td style="text-align: right;" class="' + oneMonth.class + '"><strong>' + oneMonth.symbol + ' ' + oneMonth.percent + (oneMonth.percent !== '-' ? '%' : '') + '</strong></td>' +
                        '<td style="text-align: right;">' + (parseFloat(row.threeMonthsAgoPrice) || 0).toLocaleString() + '</td>' +
                        '<td style="text-align: right;" class="' + threeMonths.class + '"><strong>' + threeMonths.symbol + ' ' + threeMonths.percent + (threeMonths.percent !== '-' ? '%' : '') + '</strong></td>' +
                        '<td style="text-align: right;">' + (parseFloat(row.sixMonthsAgoPrice) || 0).toLocaleString() + '</td>' +
                        '<td style="text-align: right;" class="' + sixMonths.class + '"><strong>' + sixMonths.symbol + ' ' + sixMonths.percent + (sixMonths.percent !== '-' ? '%' : '') + '</strong></td>' +
                        '<td style="text-align: right;">' + (parseFloat(row.oneYearAgoPrice) || 0).toLocaleString() + '</td>' +
                        '<td style="text-align: right;" class="' + oneYear.class + '"><strong>' + oneYear.symbol + ' ' + oneYear.percent + (oneYear.percent !== '-' ? '%' : '') + '</strong></td>';
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                
                tableContainer.appendChild(table);
            };
            
            // ì´ˆê¸° ë°ì´í„° í‘œì‹œ (ì²« ë²ˆì§¸ í’ˆëª©)
            renderItemData(state.chartData.data[0]);
            
            // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.justifyContent = 'flex-end';
            buttonContainer.style.marginTop = '20px';
            
            // ë‹«ê¸° ë²„íŠ¼
            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-btn';
            closeBtn.textContent = 'ë‹«ê¸°';
            closeBtn.addEventListener('click', function() {
                modal.remove();
            });
            
            buttonContainer.appendChild(closeBtn);
            
            // ì¡°ë¦½
            modalContent.appendChild(titleContainer);
            modalContent.appendChild(infoBox);
            modalContent.appendChild(tabContainer);
            modalContent.appendChild(tableContainer);
            modalContent.appendChild(buttonContainer);
            modal.appendChild(modalContent);
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        // í’ˆëª© ì¶”ê°€ ë ˆì´ì–´ íŒì—… í‘œì‹œ
        function showItemSelectionModal() {
            if (!window.availableItems || window.availableItems.length === 0) {
                alert('ë¨¼ì € ë°ì´í„°(ì¹´í…Œê³ ë¦¬)ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì„ì‹œ ì„ íƒ ë°°ì—´ (í˜„ì¬ state.itemsì˜ idë“¤ë¡œ ì´ˆê¸°í™”)
            const tempSelectedItems = state.items.map(item => item.id);

            // ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'itemSelectionModal';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.maxWidth = '1000px';
            
            // ì œëª©ê³¼ ì„ íƒ ê°œìˆ˜ í‘œì‹œ
            const titleContainer = document.createElement('div');
            titleContainer.style.display = 'flex';
            titleContainer.style.justifyContent = 'space-between';
            titleContainer.style.alignItems = 'center';
            titleContainer.style.marginBottom = '20px';
            
            const title = document.createElement('h2');
            title.textContent = 'í’ˆëª© ì„ íƒ';
            title.style.margin = '0';
            
            const selectionCount = document.createElement('div');
            selectionCount.style.fontSize = '14px';
            selectionCount.style.color = '#007bff';
            selectionCount.style.fontWeight = '600';
            selectionCount.textContent = 'ì„ íƒ: ' + tempSelectedItems.length + 'ê°œ';
            
            titleContainer.appendChild(title);
            titleContainer.appendChild(selectionCount);
            
            // ê²€ìƒ‰ ì…ë ¥
            const searchBox = document.createElement('input');
            searchBox.type = 'text';
            searchBox.className = 'input-field';
            searchBox.placeholder = 'í’ˆëª©ëª…ì„ ê²€ìƒ‰í•˜ì„¸ìš”...';
            searchBox.style.marginBottom = '15px';
            
            // í…Œì´ë¸” ì»¨í…Œì´ë„ˆ
            const tableContainer = document.createElement('div');
            tableContainer.style.maxHeight = '500px';
            tableContainer.style.overflowY = 'auto';
            tableContainer.style.border = '1px solid #ddd';
            tableContainer.style.borderRadius = '6px';
            tableContainer.style.marginBottom = '15px';
            
            // í…Œì´ë¸” ìƒì„±
            const table = document.createElement('table');
            table.className = 'item-table';
            
            // ì •ë ¬ ìƒíƒœ
            let sortColumn = 'change'; // ê¸°ë³¸: ë³€ë™ë¥ ë¡œ ì •ë ¬
            let sortDirection = 'desc'; // desc: ë‚´ë¦¼ì°¨ìˆœ, asc: ì˜¤ë¦„ì°¨ìˆœ
            
            // í…Œì´ë¸” í—¤ë”
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const headers = [
                { text: 'ì„ íƒ', field: null, width: '5%', align: 'center' },
                { text: 'í’ˆëª©ëª…', field: 'title', width: '25%', align: 'left' },
                { text: 'ì¢…ë¥˜', field: 'kind', width: '20%', align: 'left' },
                { text: 'ë“±ê¸‰', field: 'grade', width: '10%', align: 'center' },
                { text: 'ê°€ê²©', field: 'price', width: '15%', align: 'right' },
                { text: 'ì „ì¼ê°€ê²©', field: 'prevDayPrice', width: '15%', align: 'right' },
                { text: 'ë³€ë™', field: 'change', width: '10%', align: 'right' }
            ];
            
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.text;
                th.style.width = header.width;
                th.style.textAlign = header.align;
                
                if (header.field) {
                    th.className = 'sortable';
                    th.dataset.field = header.field;
                    
                    // ê¸°ë³¸ ì •ë ¬ ì»¬ëŸ¼ í‘œì‹œ
                    if (header.field === sortColumn) {
                        th.classList.add('sort-' + sortDirection);
                    }
                    
                    // í´ë¦­ ì´ë²¤íŠ¸
                    th.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const field = this.dataset.field;
                        
                        // ê°™ì€ ì»¬ëŸ¼ í´ë¦­ ì‹œ ë°©í–¥ ì „í™˜
                        if (sortColumn === field) {
                            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                        } else {
                            sortColumn = field;
                            sortDirection = 'desc';
                        }
                        
                        // í—¤ë” í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸
                        headerRow.querySelectorAll('th').forEach(h => {
                            h.classList.remove('sort-asc', 'sort-desc');
                        });
                        this.classList.add('sort-' + sortDirection);
                        
                        // ì¬ë Œë”ë§
                        renderItems(searchBox.value);
                    });
                }
                
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // í…Œì´ë¸” ë°”ë””
            const tbody = document.createElement('tbody');
            table.appendChild(tbody);
            
            tableContainer.appendChild(table);
            
            // ì„ íƒ ê°œìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            const updateSelectionCount = () => {
                selectionCount.textContent = 'ì„ íƒ: ' + tempSelectedItems.length + 'ê°œ';
            };

            // í’ˆëª© ë Œë”ë§ í•¨ìˆ˜
            const renderItems = (filterText = '') => {
                tbody.innerHTML = '';
                
                let filtered = window.availableItems.filter(item => 
                    !filterText || item.title.toLowerCase().includes(filterText.toLowerCase())
                );
                
                // ì •ë ¬
                filtered.sort((a, b) => {
                    let aVal, bVal;
                    
                    if (sortColumn === 'price' || sortColumn === 'prevDayPrice') {
                        aVal = parseFloat(a[sortColumn]) || 0;
                        bVal = parseFloat(b[sortColumn]) || 0;
                    } else if (sortColumn === 'change') {
                        const aPrice = parseFloat(a.price) || 0;
                        const aPrevPrice = parseFloat(a.prevDayPrice) || 0;
                        const bPrice = parseFloat(b.price) || 0;
                        const bPrevPrice = parseFloat(b.prevDayPrice) || 0;
                        
                        aVal = aPrevPrice > 0 ? ((aPrice - aPrevPrice) / aPrevPrice) * 100 : 0;
                        bVal = bPrevPrice > 0 ? ((bPrice - bPrevPrice) / bPrevPrice) * 100 : 0;
                    } else {
                        aVal = String(a[sortColumn] || '').toLowerCase();
                        bVal = String(b[sortColumn] || '').toLowerCase();
                    }
                    
                    if (sortDirection === 'asc') {
                        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                    } else {
                        return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                    }
                });
                
                if (filtered.length === 0) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = '<td colspan="7" style="text-align:center;color:#999;padding:20px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td>';
                    tbody.appendChild(emptyRow);
                    return;
                }
                
                filtered.forEach(item => {
                    // ì„ì‹œ ì„ íƒ ë°°ì—´ì—ì„œ í™•ì¸
                    const isSelected = tempSelectedItems.includes(item.id);
                    
                    const tr = document.createElement('tr');
                    if (isSelected) {
                        tr.className = 'selected';
                    }
                    
                    // ê°€ê²© ë³€ë™ ê³„ì‚°
                    const changeInfo = calculateChange(item.price, item.prevDayPrice);
                    
                    tr.innerHTML = 
                        '<td style="text-align:center;">' + (isSelected ? 'âœ“' : '') + '</td>' +
                        '<td><strong>' + (item.title || '-') + '</strong></td>' +
                        '<td>' + (item.kind || '-') + '</td>' +
                        '<td style="text-align:center;">' + (item.grade || '-') + '</td>' +
                        '<td style="text-align:right;"><strong>' + formatPrice(item.price) + '</strong></td>' +
                        '<td style="text-align:right;">' + formatPrice(item.prevDayPrice) + '</td>' +
                        '<td style="text-align:right;" class="' + changeInfo.class + '">' +
                        '<strong>' + changeInfo.symbol + ' ' + Math.abs(changeInfo.percent) + '%</strong>' +
                        '</td>';
                    
                    tr.style.cursor = 'pointer';
                    tr.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        // ì„ íƒ/í•´ì œ í† ê¸€
                        const index = tempSelectedItems.indexOf(item.id);
                        if (index > -1) {
                            // ì´ë¯¸ ì„ íƒë¨ - ì œê±°
                            tempSelectedItems.splice(index, 1);
                            tr.classList.remove('selected');
                        } else {
                            // ì„ íƒë˜ì§€ ì•ŠìŒ - ì¶”ê°€
                            tempSelectedItems.push(item.id);
                            tr.classList.add('selected');
                        }
                        
                        // ì²´í¬ë§ˆí¬ ì—…ë°ì´íŠ¸
                        tr.children[0].textContent = tempSelectedItems.includes(item.id) ? 'âœ“' : '';
                        
                        // ì„ íƒ ê°œìˆ˜ ì—…ë°ì´íŠ¸
                        updateSelectionCount();
                    });
                    
                    tbody.appendChild(tr);
                });
            };
            
            // ê²€ìƒ‰ ì´ë²¤íŠ¸
            searchBox.addEventListener('input', function() {
                renderItems(this.value);
            });
            
            // ì´ˆê¸° ë Œë”ë§
            renderItems();
            
            // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.gap = '10px';
            buttonContainer.style.justifyContent = 'flex-end';
            buttonContainer.style.marginTop = '20px';
            
            // ë‹«ê¸° ë²„íŠ¼
            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-btn';
            closeBtn.textContent = 'ë‹«ê¸°';
            closeBtn.style.background = '#6c757d';
            closeBtn.addEventListener('mouseenter', function() {
                this.style.background = '#5a6268';
            });
            closeBtn.addEventListener('mouseleave', function() {
                this.style.background = '#6c757d';
            });
            closeBtn.addEventListener('click', function() {
                modal.remove();
            });
            
            // ì ìš© ë²„íŠ¼
            const applyBtn = document.createElement('button');
            applyBtn.className = 'close-btn';
            applyBtn.textContent = 'ì ìš©';
            applyBtn.style.background = '#28a745';
            applyBtn.addEventListener('mouseenter', function() {
                this.style.background = '#218838';
            });
            applyBtn.addEventListener('mouseleave', function() {
                this.style.background = '#28a745';
            });
            applyBtn.addEventListener('click', function() {
                // ì„ì‹œ ì„ íƒ ë°°ì—´ì„ ì‹¤ì œ state.itemsì— ë°˜ì˜
                state.items = [];
                tempSelectedItems.forEach(itemId => {
                    const item = window.availableItems.find(i => i.id === itemId);
                    if (item) {
                        state.items.push({
                            id: item.id,
                            title: item.title + '(' + item.kind + ')'
                        });
                    }
                });
                
                // ì„ íƒëœ í’ˆëª© í™”ë©´ì— í‘œì‹œ
                renderSelectedItems();
                
                // ëª¨ë‹¬ ë‹«ê¸°
                modal.remove();
            });
            
            buttonContainer.appendChild(closeBtn);
            buttonContainer.appendChild(applyBtn);
            
            // ì¡°ë¦½
            modalContent.appendChild(titleContainer);
            modalContent.appendChild(searchBox);
            modalContent.appendChild(tableContainer);
            modalContent.appendChild(buttonContainer);
            modal.appendChild(modalContent);
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }


        // ì˜µì…˜ ë²„íŠ¼ ì„ íƒ
        document.querySelectorAll('.option-button').forEach(button => {
			button.addEventListener('click', function(event) {
				// ì•„ì´ì½˜ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
				if (event.target.classList.contains('fa-eye')) {
					event.stopPropagation();
					return;
				}
				
				// ê°™ì€ ê·¸ë£¹ì˜ ë‹¤ë¥¸ ë²„íŠ¼ë“¤ ì„ íƒ í•´ì œ
				const parent = this.parentElement;
				parent.querySelectorAll('.option-button').forEach(btn => {
					btn.classList.remove('selected');
				});
				
				// í˜„ì¬ ë²„íŠ¼ ì„ íƒ
				this.classList.add('selected');

                // ê·¸ë£¹ ìƒíƒœ ì €ì¥
                const role = this.dataset.role;
                if(role==='category'){
                    state.categoryId = this.dataset.value || this.getAttribute('data-value');
                    fetchApisByCategory(state.categoryId);
                } else if(role==='prompt'){
                    state.promptIdx = parseInt(this.dataset.value || this.getAttribute('data-value'))||0;
                } else if(role==='template'){
                    state.templateIdx = parseInt(this.dataset.value || this.getAttribute('data-value'))||0;
                }
			});
		});

        // ë¯¸ë””ì–´ ì˜µì…˜ ì„ íƒ (ì´ë¯¸ì§€/ì°¨íŠ¸ êµ¬ë¶„í•˜ì—¬ stateì— ë°˜ì˜)
        document.querySelectorAll('#section-image-option .media-option').forEach(option => {
            option.addEventListener('click', function() {
                const parent = this.parentElement;
                parent.querySelectorAll('.media-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                state.makeImage = this.getAttribute('data-value');
            });
        });

        document.querySelectorAll('#section-chart-option .media-option').forEach(option => {
            option.addEventListener('click', function() {
                const parent = this.parentElement;
                parent.querySelectorAll('.media-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                state.makeChart = this.getAttribute('data-value');
            });
        });

        // ë‹¨ê³„ í´ë¦­ ì´ë²¤íŠ¸
		document.querySelectorAll('.step').forEach(step => {
			step.addEventListener('click', function() {
				const stepData = this.dataset.step;
				const stepNumber = parseInt(stepData);
				if (isNaN(stepNumber)) {
					debugError('ìœ íš¨í•˜ì§€ ì•Šì€ ë‹¨ê³„ ë°ì´í„°:', stepData);
					return;
				}
				showStep(stepNumber);
			});
		});

		// í…œí”Œë¦¿ ëª¨ë‹¬ í‘œì‹œ
		function showTemplateModal(templateIdx) {
			// ë¡œë”© í‘œì‹œ
			showLoading('í…œí”Œë¦¿ ë¡œë”©ì¤‘...', 'í…œí”Œë¦¿ ë‚´ìš©ì„ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.');

			fetch('/aiSetting/templateEdit/ajax?idx=' + encodeURIComponent(templateIdx))
				.then(response => response.json())
				.then(data => {
					hideLoading();
					
					if (data.result.success) {
						const templateContent = data.result.item.content || 'í…œí”Œë¦¿ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.';
						
						// ëª¨ë‹¬ ìš”ì†Œ ìƒì„±
						const modal = document.createElement('div');
						modal.className = 'modal';
						
						// ëª¨ë‹¬ ë‚´ìš© ìƒì„±
						const modalContent = document.createElement('div');
						modalContent.className = 'modal-content';
						
						// ì œëª© ìƒì„±
						const title = document.createElement('h2');
						title.textContent = 'ê¸°ì‚¬ í…œí”Œë¦¿: ' + data.result.item.title;
						
						// ì„¤ëª… ìƒì„±
						const description = document.createElement('p');
						description.textContent = 'í…œí”Œë¦¿ ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:';
						
						// í…œí”Œë¦¿ í”„ë¦¬ë·° ì»¨í…Œì´ë„ˆ ìƒì„±
						const templatePreview = document.createElement('div');
						templatePreview.className = 'template-preview';
						
						// í…ìŠ¤íŠ¸ ì˜ì—­ ìƒì„±
						const textarea = document.createElement('textarea');
						textarea.className = 'input-field';
						textarea.rows = 15;
						textarea.readOnly = true;
						textarea.value = templateContent;
						
						// ë‹«ê¸° ë²„íŠ¼ ìƒì„±
						const closeBtn = document.createElement('button');
						closeBtn.className = 'close-btn';
						closeBtn.textContent = 'ë‹«ê¸°';
						
						// ìš”ì†Œë“¤ì„ ì¡°ë¦½
						templatePreview.appendChild(textarea);
						modalContent.appendChild(title);
						modalContent.appendChild(description);
						modalContent.appendChild(templatePreview);
						modalContent.appendChild(closeBtn);
						modal.appendChild(modalContent);
						document.body.appendChild(modal);

						// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
						modal.addEventListener('click', function(event) {
							if (event.target.classList.contains('modal')) {
								this.remove();
							}
						});

						closeBtn.addEventListener('click', function() {
							modal.remove();
						});
					} else {
						alert('í…œí”Œë¦¿ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
					}
				})
				.catch(error => {
					hideLoading();
					console.error('í…œí”Œë¦¿ ë¡œë”© ì˜¤ë¥˜:', error);
					alert('í…œí”Œë¦¿ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
				});
		}

        // ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ì²˜ë¦¬
		window.addEventListener('popstate', function(event) {
			debug('popstate ì´ë²¤íŠ¸:', event.state);
			
			if (event.state && typeof event.state.step === 'number') {
				debug('íˆìŠ¤í† ë¦¬ì—ì„œ ë³µì›ëœ ë‹¨ê³„:', event.state.step);
				showStep(event.state.step, false);
			} else {
				debug('í˜ì´ì§€ ì§„ì… ì „ íˆìŠ¤í† ë¦¬ë¡œ ì´ë™');
			}
		});

        // ì´ˆê¸°í™” - í˜ì´ì§€ ë¡œë”© ì‹œ 1ë‹¨ê³„ í‘œì‹œ
		document.addEventListener('DOMContentLoaded', function() {
			debug('DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
			
			// DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ ì‹¤í–‰
			setTimeout(function() {
				debug('ì´ˆê¸°í™” ì‹œì‘');
				
				// ëª¨ë“  ë‹¨ê³„ ë‚´ìš©ì„ ë¨¼ì € ìˆ¨ê¸°ê¸°
				document.querySelectorAll('.step-content').forEach(content => {
					content.classList.remove('active');
				});
				
				// currentStepì„ ì•ˆì „í•˜ê²Œ 1ë¡œ ì„¤ì •
				setCurrentStep(1);
				
                // ì´ˆê¸° íˆìŠ¤í† ë¦¬ ìƒíƒœ ì„¤ì •
                history.replaceState({ step: 1 }, '', '?step=1');
                
                // 1ë‹¨ê³„ë¥¼ ê¸°ë³¸ìœ¼ë¡œ í‘œì‹œ (íˆìŠ¤í† ë¦¬ì— ì¶”ê°€í•˜ì§€ ì•ŠìŒ)
                showStep(1, false);
				
				// ëª¨ë“  ë‹¨ê³„ ì›ì„ ì´ˆê¸° ìƒíƒœë¡œ ì„¤ì •
				document.querySelectorAll('.step-circle').forEach((circle, index) => {
					if (index === 0) {
						circle.classList.remove('inactive');
						circle.classList.add('active');
					} else {
						circle.classList.remove('active', 'completed');
						circle.classList.add('inactive');
					}
				});
				
				// ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
				updateNavigationButtons();
				
				// í’ˆëª© ì»¨í…Œì´ë„ˆ ì´ˆê¸° ìƒíƒœ í‘œì‹œ
				renderSelectedItems();
				
				// í’ˆëª© ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
				const addItemBtn = document.getElementById('addItemBtn');
				if (addItemBtn) {
					addItemBtn.addEventListener('click', showItemSelectionModal);
				}
				
				debug('ì´ˆê¸°í™” ì™„ë£Œ - ìµœì¢… currentStep:', currentStep);
			}, 100); // 100ms ì§€ì—°ìœ¼ë¡œ DOM ì™„ì „ ë¡œë“œ ë³´ì¥
		});

        // next ë²„íŠ¼ì€ ê¸°ë³¸ nextStep(showStep í˜¸ì¶œ) ë¡œì§ì„ ì‚¬ìš©í•˜ê³ ,
        // showStepì—ì„œ step2 ì§„ì… ì‹œ ìµœì´ˆ 1íšŒë§Œ startAIGeneration()ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.

        /**
         * ì°¨íŠ¸ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜í•˜ì—¬ ì„œë²„ì— ì €ì¥
         * Step 2 â†’ Step 3 ì „í™˜ ì‹œ í˜¸ì¶œ
         */
        async function convertChartToImage() {
            debug('=== convertChartToImage í˜¸ì¶œ ===');
            debug('state.makeChart:', state.makeChart);
            debug('state.chosen.chart:', state.chosen.chart);
            
            if (!state.chosen.chart || state.makeChart !== 'generate') {
                debug('ì°¨íŠ¸ê°€ ì—†ê±°ë‚˜ ì°¨íŠ¸ ìƒì„±ì„ ì„ íƒí•˜ì§€ ì•ŠìŒ - ìŠ¤í‚µ');
                return;
            }
            
            try {
                showLoading('ì°¨íŠ¸ ì´ë¯¸ì§€ ë³€í™˜ì¤‘...', 'ì°¨íŠ¸ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.');
                debug('=== ì°¨íŠ¸ ì´ë¯¸ì§€ ë³€í™˜ ì‹œì‘ ===', state.chosen.chart);
                
                // iframe ì°¾ê¸° (Step 2 ì„ íƒëœ ì°¨íŠ¸ â†’ Step 3 ë¦¬ë·° â†’ ì „ì²´ ê²€ìƒ‰)
                let iframe = document.querySelector('#chartOptions .media-option.selected iframe') ||
                            document.getElementById('reviewChartFrame') ||
                            document.getElementById('chartFrame1') ||
                            document.getElementById('chartFrame2') ||
                            document.getElementById('chartFrame3');
                
                if (!iframe || !iframe.contentWindow) {
                    debugError('ì°¨íŠ¸ iframeì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    hideLoading();
                    alert('ì°¨íŠ¸ iframeì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nì°¨íŠ¸ê°€ ì™„ì „íˆ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
                    return;
                }
                
                debug('iframe ì°¾ê¸° ì„±ê³µ');
                
                // iframe ë‚´ë¶€ì˜ anychart ì°¨íŠ¸ ê°ì²´ì— ì ‘ê·¼
                const iframeWindow = iframe.contentWindow;
                const iframeDocument = iframe.contentDocument || iframeWindow.document;
                
                debug('iframe window ì ‘ê·¼:', !!iframeWindow, 'chart ì¡´ì¬:', !!iframeWindow.chart);
                
                // AnyChart ì°¨íŠ¸ ê°ì²´ ê°€ì ¸ì˜¤ê¸°
                let chart = iframeWindow.chart;
                if (!chart && iframeWindow.anychart) {
                    debug('window.chartê°€ ì—†ìŒ, anychart APIë¡œ ì°¾ê¸° ì‹œë„');
                    try {
                        const allCharts = iframeWindow.anychart.getGlobal ? 
                            iframeWindow.anychart.getGlobal().charts : 
                            (iframeWindow.anychart.charts || []);
                        if (allCharts && allCharts.length > 0) {
                            chart = allCharts[0];
                        }
                    } catch (e) {
                        debugError('anychart APIë¡œ ì°¨íŠ¸ ì°¾ê¸° ì‹¤íŒ¨:', e);
                    }
                }
                
                if (!chart) {
                    debugError('ì°¨íŠ¸ ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    hideLoading();
                    alert('ì°¨íŠ¸ ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì°¨íŠ¸ê°€ ì™„ì „íˆ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                debug('ì°¨íŠ¸ ê°ì²´ ê°€ì ¸ì˜´, íƒ€ì…:', chart.getType ? chart.getType() : 'unknown');
                
                // ì°¨íŠ¸ê°€ ì™„ì „íˆ ë Œë”ë§ë  ë•Œê¹Œì§€ ì ì‹œ ëŒ€ê¸°
                await new Promise(resolve => setTimeout(resolve, CHART_LOAD_DELAY));
                
                debug('SVG â†’ Canvas ë³€í™˜ ì‹œì‘');
                
                try {
                    // ì°¨íŠ¸ë¥¼ SVG ë¬¸ìì—´ë¡œ ë³€í™˜
                    const svgString = chart.toSvg();
                    debug('SVG ìƒì„± ì™„ë£Œ, ê¸¸ì´:', svgString.length);
                    
                    // ë¡œê³  ì´ë¯¸ì§€ URL (iframeì—ì„œ ê°€ì ¸ì˜¤ê¸°)
                    const logoImg = iframeDocument.querySelector('#logoContainer img');
                    const logoSrc = logoImg ? logoImg.src : 'https://indicator.hankyung.com/image/logo.png';
                    
                    // Canvas ì„¤ì •
                    const canvas = document.createElement('canvas');
                    canvas.width = CANVAS_WIDTH;
                    const ctx = canvas.getContext('2d');
                    
                    // ì°¨íŠ¸ SVGë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
                    const chartImg = new Image();
                    chartImg.crossOrigin = 'anonymous';
                    
                    chartImg.onload = function() {
                        debug('ì°¨íŠ¸ ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ, í¬ê¸°:', chartImg.width, 'x', chartImg.height);
                        
                        // ë¡œê³  ì´ë¯¸ì§€ ë¡œë“œ
                        const logoImage = new Image();
                        logoImage.crossOrigin = 'anonymous';
                        
                        logoImage.onload = function() {
                            debug('ë¡œê³  ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ');
                            
                            // Canvas ì´ ë†’ì´ ê³„ì‚° (ì°¨íŠ¸ ë†’ì´ + ë¡œê³  ì˜ì—­)
                            const chartHeight = chartImg.height;
                            canvas.height = chartHeight + LOGO_AREA_HEIGHT;
                            
                            // í°ìƒ‰ ë°°ê²½
                            ctx.fillStyle = '#ffffff';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            
                            // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
                            ctx.drawImage(chartImg, 0, 0);
                            
                            // ë¡œê³  ì˜ì—­ (ì°¨íŠ¸ ì•„ë˜)
                            const logoWidth = logoImage.width * (LOGO_HEIGHT / logoImage.height);
                            const logoX = canvas.width - logoWidth - LOGO_PADDING;
                            const logoY = chartHeight + (LOGO_AREA_HEIGHT - LOGO_HEIGHT) / 2;
                            
                            // ë¡œê³  íˆ¬ëª…ë„ ì ìš©
                            ctx.globalAlpha = LOGO_OPACITY;
                            ctx.drawImage(logoImage, logoX, logoY, logoWidth, LOGO_HEIGHT);
                            ctx.globalAlpha = 1.0;
                            
                            // Canvasë¥¼ Base64ë¡œ ë³€í™˜
                            const base64 = canvas.toDataURL('image/png', 1.0);
                            debug('PNG Base64 ìƒì„± ì™„ë£Œ (ì°¨íŠ¸+ë¡œê³ ), ê¸¸ì´:', base64.length);
                            
                            URL.revokeObjectURL(chartImg.src);
                            saveChartImageToServer(base64);
                        };
                        
                        logoImage.onerror = function(error) {
                            debugError('ë¡œê³  ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨, ë¡œê³  ì—†ì´ ì°¨íŠ¸ë§Œ ì €ì¥');
                            
                            // ë¡œê³  ì—†ì´ ì°¨íŠ¸ë§Œ ì €ì¥
                            canvas.height = chartImg.height;
                            ctx.fillStyle = '#ffffff';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(chartImg, 0, 0);
                            
                            const base64 = canvas.toDataURL('image/png', 1.0);
                            debug('PNG Base64 ìƒì„± ì™„ë£Œ (ì°¨íŠ¸ë§Œ), ê¸¸ì´:', base64.length);
                            
                            URL.revokeObjectURL(chartImg.src);
                            saveChartImageToServer(base64);
                        };
                        
                        // ë¡œê³  ì´ë¯¸ì§€ ë¡œë“œ ì‹œì‘
                        logoImage.src = logoSrc;
                    };
                    
                    chartImg.onerror = function(error) {
                        debugError('ì°¨íŠ¸ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
                        hideLoading();
                        alert('ì°¨íŠ¸ ì´ë¯¸ì§€ ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. SVG ë¡œë“œ ì˜¤ë¥˜\n\nëŒ€ì²´ ë°©ë²•ì„ ì‹œë„í•˜ê±°ë‚˜, ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                    };
                    
                    // SVGë¥¼ Data URLë¡œ ë³€í™˜
                    const svgBlob = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
                    const svgUrl = URL.createObjectURL(svgBlob);
                    chartImg.src = svgUrl;
                    
                } catch (svgError) {
                    debugError('SVG ë³€í™˜ ì‹¤íŒ¨:', svgError);
                    hideLoading();
                    alert('ì°¨íŠ¸ ì´ë¯¸ì§€ ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nSVG ë³€í™˜ ì˜¤ë¥˜: ' + svgError.message + '\n\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                }
                
            } catch (e) {
                debugError('ì°¨íŠ¸ ì´ë¯¸ì§€ ë³€í™˜ ì¤‘ ì˜¤ë¥˜:', e);
                hideLoading();
                alert('ì°¨íŠ¸ ì´ë¯¸ì§€ ë³€í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
            }
        }
        
        /**
         * ì°¨íŠ¸ ì´ë¯¸ì§€ë¥¼ ì„œë²„ì— ì €ì¥
         */
        async function saveChartImageToServer(base64Image) {
            try {
                const form = new URLSearchParams();
                form.append('chartImageData', base64Image);
                form.append('chartFilename', state.chosen.chart.filename || '');
                
                const res = await fetch('/article/aiSaveChartImage', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: String(form)
                });
                
                const json = await res.json();
                hideLoading();
                
                if (json.success) {
                    debug('ì°¨íŠ¸ ì´ë¯¸ì§€ ì €ì¥ ì„±ê³µ:', json.data);
                    
                    // stateì— PNG ê²½ë¡œ ì €ì¥
                    state.chosen.chart.png_path = json.data.png_path;
                    state.chosen.chart.png_filename = json.data.png_filename;
                    
                    debug('ì°¨íŠ¸ PNG ì •ë³´ ì €ì¥ ì™„ë£Œ');
                } else {
                    debugError('ì°¨íŠ¸ ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨:', json.msg);
                    alert('ì°¨íŠ¸ ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: ' + json.msg);
                }
            } catch (e) {
                hideLoading();
                debugError('ì°¨íŠ¸ ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', e);
                alert('ì°¨íŠ¸ ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
            }
        }

        // ê¸°ì‚¬ ì €ì¥ ë° ì „ì†¡
        async function sendArticle(){
            showLoading('ê¸°ì‚¬ ì €ì¥ì¤‘...', 'ì‘ì„±ëœ ê¸°ì‚¬ë¥¼ ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤.');
            try{
                console.log('=== ê¸°ì‚¬ ì €ì¥ ì‹œì‘ ===');
                console.log('state.makeImage:', state.makeImage);
                console.log('state.makeChart:', state.makeChart);
                console.log('state.chosen.chart:', state.chosen.chart);
                console.log('state.chosen.image:', state.chosen.image);
                
                // 3stepì˜ reviewContent HTML ê°€ì ¸ì˜¤ê¸°
                const reviewContentElement = document.getElementById('reviewContent');
                const reviewContentHtml = reviewContentElement ? reviewContentElement.innerHTML : '';
                
                // ë°ì´í„° ìˆ˜ì§‘
                const articleData = {
                    categoryId: state.categoryId,
                    title: document.getElementById('articleTitle').value,
                    subtitle: document.getElementById('articleSubtitle').value,
                    body: document.getElementById('articleBody').value,
                    reviewContent: reviewContentHtml,  // 3step ë³¸ë¬¸ HTML (ì´ë¯¸ì§€+ì°¨íŠ¸ í¬í•¨)
                    items: state.items,
                    chart: state.chosen.chart,
                    image: state.chosen.image,
                    image_prompt: state.draft?.image_prompt || '',  // ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ì¶”ê°€
                    tags: state.draft?.tags || [],
                    makeImage: state.makeImage,
                    makeChart: state.makeChart
                };
                
                console.log('=== ì „ì†¡í•  articleData ===');
                console.log('makeImage:', articleData.makeImage);
                console.log('makeChart:', articleData.makeChart);
                console.log('image ê°ì²´:', articleData.image);
                console.log('chart ê°ì²´:', articleData.chart);
                
                debug('ì „ì†¡í•  articleData:', articleData);

                // ë°±ì—”ë“œë¡œ ì „ì†¡
                const form = new URLSearchParams();
                form.append('data', JSON.stringify(articleData));
                
                const res = await fetch('/article/aiSave', {
                    method:'POST', 
                    headers:{'Content-Type':'application/x-www-form-urlencoded'}, 
                    body:String(form)
                });
                
                const json = await res.json();
                hideLoading();
                
                if(json.success){ 
                    // ì €ì¥ ê²°ê³¼ ë©”ì‹œì§€ êµ¬ì„±
                    let message = 'âœ… ê¸°ì‚¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n';
                    message += 'ğŸ“„ ê¸°ì‚¬ ID: ' + json.aid + '\n\n';
                    alert(message);
                    
                    //location.href = '/article/list';
                } else { 
                    alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + (json.msg||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜')); 
                }
            }catch(e){ 
                hideLoading(); 
                debugError('ì €ì¥ ì¤‘ ì˜¤ë¥˜:', e); 
                alert('âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message); 
            }
        }
	</script>
</body>
</html>