tinymce.PluginManager.add('movie', function(editor, url) {
    editor.ui.registry.addButton( 'movie', {
        icon: 'embed', 
        tooltip: '외부 동영상 입력',
        onAction:()=>{
            editor.windowManager.open({
                title: '외부동영상 입력',
                body: {
                    type: 'panel',
                    items: [
                        {
                            type: 'input',name: 'url', label: '동영상 주소', id: 'url'
                        },
                        {
                            type: 'input',name: 'script', label: '스크립트', id: 'script'
                        },
                        {
                            type: 'input',name: 'width', label: '가로', id: 'width' , value:'800'
                        },
                        {
                            type: 'input',name: 'height', label: '세로', id: 'height', value:'450'
                        }
                    ]
                },
                buttons: [
                    {
                        type: 'cancel',name: 'closeButton',text: '취소'
                    },
                    {
                        type: 'submit',name: 'submitButton',text: '확인',primary: true
                    }
                ],
                onSubmit: function (api) {
                    var data = api.getData();
                    if(data.url){
                        if( data.url.indexOf("tv.naver.com") > -1 ){
                            data.url = data.url.replace( '/v/', '/embed/' );
                        }else if( data.url.indexOf("tv.kakao.com") > -1 ){
                            data.url = data.url.replace( '/v/', '/embed/player/cliplink/' );
                        }else if( data.url.indexOf("//youtu.be/") > -1 ){
                            data.url = data.url.replace( '//youtu.be/', '//www.youtube.com/embed/' );
                        }else if( data.url.indexOf("youtube.com/") > -1 ){
                            let match = data.url.match(/\/shorts\/([a-zA-Z0-9-_]{11})/);
                            let match2 = data.url.match(/[?&]v=([^&]+)/);
                            if( match ){
                                data.url = 'https://www.youtube.com/embed/' + match[1];
                            }else if( match2 ){
                                data.url = 'https://www.youtube.com/embed/' + match2[1];
                            }
                        }
                        var width = 800;
                        var height = 450;
                        if(data.width) width = data.width;
                        if(data.height) height = data.height;
                        editor.insertContent('<figure class="image youtubeWrap"><iframe src="' + data.url + '" width="' + width + '" height="' + height + '" frameborder="no" marginwidth="0" marginheight="0" scrolling="no" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen"></iframe></figure>');
                        api.close();
                    }else if(data.script){
                        editor.insertContent('<figure class="image">'+data.script+'</figure>');
                        api.close();
                    }
                }
            })
        }
    });
});